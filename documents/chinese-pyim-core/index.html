<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>chinese-pyim-core - Chinese-pyim</title>
    <meta charset="utf-8" />
    <meta name="author" content="Feng Shu" />
    <link rel="stylesheet" href="http://tumashu.github.com/chinese-pyim/media/css/main.css" type="text/css">
  </head>
<body class="container">
    <div>
      <header class="masthead">
        <h1 class="masthead-title"><a href="http://tumashu.github.com/chinese-pyim/">Chinese-pyim</a> <span class="subtitle">(一个 emacs 环境下的中文拼音输入法)</span></h1>
        <ul>
          <li><a href="http://tumashu.github.com/chinese-pyim/documents/">Documents</a></li>
          <li><a href="http://tumashu.github.com/chinese-pyim/snapshots/">Snapshots</a></li>
          <li><a href="http://tumashu.github.com/chinese-pyim/tags/">Tags</a></li>
          <li><a href="http://tumashu.github.com/chinese-pyim/about/">About</a></li>
          <li><a href="https://github.com/tumashu/chinese-pyim">GitHub</a></li>
          <li><a href="http://tumashu.github.com/chinese-pyim/rss.xml">RSS</a></li>
        </ul>
        <form method="get" id="searchform" action="http://www.google.com/search">
          <input type="text" class="field" name="q" id="s" placeholder="Search">
          <input type="hidden" name="as_sitesearch" value="tumashu.github.com/chinese-pyim">
        </form>
        <img class="avatar" src="http://tumashu.github.com/chinese-pyim/media/img/horse.jpg" />
      </header>
    </div>

<div class="content-and-footer">
<div>
<div class="post">
<h1 class="post-title">chinese-pyim-core</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgheadline1">1. 简要介绍</a></li>
<li><a href="#orgheadline39">2. 代码说明</a>
<ul>
<li><a href="#orgheadline2">2.1. require + defcustom + defvar</a></li>
<li><a href="#orgheadline3">2.2. 将变量转换为 local 变量</a></li>
<li><a href="#orgheadline4">2.3. 输入法启动和重启</a></li>
<li><a href="#orgheadline14">2.4. 处理词库文件</a>
<ul>
<li><a href="#orgheadline8">2.4.1. 自定义词库</a></li>
<li><a href="#load-dicts">2.4.2. 加载词库</a></li>
<li><a href="#orgheadline10">2.4.3. 从词库中搜索中文词条</a></li>
<li><a href="#orgheadline13">2.4.4. 保存词条，删除词条以及调整词条位置</a></li>
</ul>
</li>
<li><a href="#orgheadline17">2.5. 生成 `pyim-current-key' 并插入 `pyim-current-str'</a>
<ul>
<li><a href="#orgheadline15">2.5.1. 生成拼音字符串 `pyim-current-key'</a></li>
<li><a href="#orgheadline16">2.5.2. 在待输入 buffer 中插入 `pyim-current-str'</a></li>
</ul>
</li>
<li><a href="#orgheadline22">2.6. 处理拼音字符串 `pyim-current-key'</a>
<ul>
<li><a href="#orgheadline20">2.6.1. 拼音字符串 -&gt; 待选词列表</a></li>
<li><a href="#orgheadline21">2.6.2. 核心函数：拼音字符串处理函数</a></li>
</ul>
</li>
<li><a href="#orgheadline23">2.7. 处理当前需要插入字符串 `pyim-current-str'</a></li>
<li><a href="#orgheadline27">2.8. 显示和选择备选词条</a>
<ul>
<li><a href="#orgheadline24">2.8.1. 构建词条菜单字符串： `pyim-guidance-str' 。</a></li>
<li><a href="#orgheadline25">2.8.2. 显示选词框</a></li>
<li><a href="#orgheadline26">2.8.3. 选择备选词</a></li>
</ul>
</li>
<li><a href="#orgheadline28">2.9. 处理标点符号</a></li>
<li><a href="#orgheadline29">2.10. 处理特殊功能触发字符（单字符快捷键）</a></li>
<li><a href="#make-char-table">2.11. 代码说明</a></li>
<li><a href="#orgheadline38">2.12. 与拼音输入相关的用户命令</a>
<ul>
<li><a href="#orgheadline31">2.12.1. 删除拼音字符串最后一个字符</a></li>
<li><a href="#orgheadline32">2.12.2. 删除拼音字符串最后一个拼音</a></li>
<li><a href="#orgheadline33">2.12.3. 取消当前输入</a></li>
<li><a href="#orgheadline34">2.12.4. 字母上屏</a></li>
<li><a href="#orgheadline35">2.12.5. 处理模糊音</a></li>
<li><a href="#orgheadline36">2.12.6. Chinese-pyim 取消激活</a></li>
<li><a href="#orgheadline37">2.12.7. 切换中英文输入模式</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-orgheadline1" class="outline-2">
<h2 id="orgheadline1"><span class="section-number-2">1</span> 简要介绍</h2>
<div class="outline-text-2" id="text-1">
<p>
Chinese pyim 输入法的核心文件，包含了输入法的基本功能函数，比如：
</p>
<ol class="org-ol">
<li>加载和搜索词库</li>
<li>处理拼音字符串</li>
<li>处理备选词条</li>
<li>显示备选词条</li>
<li>其它</li>
</ol>
</div>
</div>

<div id="outline-container-orgheadline39" class="outline-2">
<h2 id="orgheadline39"><span class="section-number-2">2</span> 代码说明</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-orgheadline2" class="outline-3">
<h3 id="orgheadline2"><span class="section-number-3">2.1</span> require + defcustom + defvar</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #FBDE2D;">require</span> '<span style="color: #4c83ff;">cl-lib</span>)
(<span style="color: #FBDE2D;">require</span> '<span style="color: #4c83ff;">help-mode</span>)
(<span style="color: #FBDE2D;">require</span> '<span style="color: #4c83ff;">pos-tip</span>)
(<span style="color: #FBDE2D;">require</span> '<span style="color: #4c83ff;">chinese-pyim-pymap</span>)

(<span style="color: #FBDE2D;">defgroup</span> <span style="color: #D8FA3C;">chinese-pyim</span> nil
  <span style="color: #61CE3C;">"Chinese pinyin input method"</span>
  <span style="color: #FF6400;">:group</span> 'leim)

(<span style="color: #FBDE2D;">defcustom</span> <span style="color: #D8FA3C;">pyim-directory</span> (locate-user-emacs-file <span style="color: #61CE3C;">"pyim/"</span>)
  <span style="color: #61CE3C;">"&#19968;&#20010;&#30446;&#24405;&#65292;&#29992;&#20110;&#20445;&#23384;&#19982; Chinese-pyim &#30456;&#20851;&#30340;&#25991;&#20214;&#12290;"</span>
  <span style="color: #FF6400;">:group</span> 'chinese-pyim)

(<span style="color: #FBDE2D;">defcustom</span> <span style="color: #D8FA3C;">pyim-personal-file</span>
  (concat (file-name-as-directory pyim-directory)
          <span style="color: #61CE3C;">"pyim-personal.txt"</span>)
  <span style="color: #61CE3C;">"&#36825;&#20010;&#25991;&#20214;&#29992;&#26469;&#20445;&#23384;&#29992;&#25143;&#26366;&#32463;&#36755;&#20837;&#36807;&#30340;&#20013;&#25991;&#35789;&#26465;&#65292;&#21644;&#36825;&#20123;&#35789;&#26465;&#36755;&#20837;&#30340;&#20808;&#21518;&#39034;&#24207;&#12290;"</span>
  <span style="color: #FF6400;">:group</span> 'chinese-pyim
  <span style="color: #FF6400;">:type</span> 'file)

(<span style="color: #FBDE2D;">defcustom</span> <span style="color: #D8FA3C;">pyim-dicts</span> nil
  <span style="color: #61CE3C;">"&#19968;&#20010;&#21015;&#34920;&#65292;&#29992;&#20110;&#20445;&#23384; `</span><span style="color: #61CE3C;">Chinese-pyim</span><span style="color: #61CE3C;">' &#30340;&#35789;&#24211;&#20449;&#24687;&#65292;&#27599;&#19968;&#20010; element &#37117;&#20195;&#34920;&#19968;&#26465;&#35789;&#24211;&#30340;&#20449;&#24687;&#12290;</span>
<span style="color: #61CE3C;">&#29992;&#25143;&#21487;&#20197;&#20351;&#29992;&#35789;&#24211;&#31649;&#29702;&#21629;&#20196; `</span><span style="color: #61CE3C;">pyim-dicts-manager</span><span style="color: #61CE3C;">' &#26469;&#28155;&#21152;&#35789;&#24211;&#20449;&#24687;&#65292;&#27599;&#19968;&#26465;&#35789;&#24211;&#20449;&#24687;&#37117;&#20351;&#29992;&#19968;&#20010;</span>
<span style="color: #61CE3C;">plist &#26469;&#34920;&#31034;&#65292;&#27604;&#22914;&#65306;</span>

<span style="color: #61CE3C;">    (:name \"100&#19975;&#22823;&#35789;&#24211;\"</span>
<span style="color: #61CE3C;">     :file \"/path/to/pinyin-bigdict.txt\"</span>
<span style="color: #61CE3C;">     :coding utf-8-unix</span>
<span style="color: #61CE3C;">     :dict-type pinyin-dict)</span>

<span style="color: #61CE3C;">&#20854;&#20013;&#65306;</span>
<span style="color: #61CE3C;">1. `</span><span style="color: #61CE3C;">:name</span><span style="color: #61CE3C;">'      &#20195;&#34920;&#35789;&#24211;&#21517;&#31216;&#65292;&#29992;&#25143;&#21487;&#20197;&#25353;&#29031;&#21916;&#22909;&#26469;&#30830;&#23450;&#12290;</span>
<span style="color: #61CE3C;">2. `</span><span style="color: #61CE3C;">:coding</span><span style="color: #61CE3C;">'    &#34920;&#31034;&#35789;&#24211;&#25991;&#20214;&#20351;&#29992;&#30340;&#32534;&#30721;&#12290;</span>
<span style="color: #61CE3C;">3. `</span><span style="color: #61CE3C;">:file</span><span style="color: #61CE3C;">'      &#34920;&#31034;&#35789;&#24211;&#25991;&#20214;&#65292;</span>
<span style="color: #61CE3C;">4. `</span><span style="color: #61CE3C;">:dict-type</span><span style="color: #61CE3C;">' &#34920;&#31034;&#35789;&#24211;&#25991;&#20214;&#26159;&#26222;&#36890;&#35789;&#24211;&#25991;&#20214;&#36824;&#26159; guessdict &#35789;&#24211;&#25991;&#20214;&#12290;"</span>
  <span style="color: #FF6400;">:group</span> 'chinese-pyim
  <span style="color: #FF6400;">:type</span> 'list)

(<span style="color: #FBDE2D;">defcustom</span> <span style="color: #D8FA3C;">pyim-dicts-directory</span>
  (concat (file-name-as-directory pyim-directory)
          <span style="color: #61CE3C;">"dicts/"</span>)
  <span style="color: #61CE3C;">"&#19968;&#20010;&#30446;&#24405;&#65292;&#29992;&#20110;&#20445;&#23384; Chinese-pyim &#35789;&#24211;&#31649;&#29702;&#22120;&#19979;&#36733;&#25110;&#32773;&#23548;&#20837;&#30340;&#35789;&#24211;&#25991;&#20214;"</span>
  <span style="color: #FF6400;">:group</span> 'chinese-pyim)

(<span style="color: #FBDE2D;">defcustom</span> <span style="color: #D8FA3C;">pyim-punctuation-dict</span>
  '((<span style="color: #61CE3C;">"'"</span> <span style="color: #61CE3C;">"&#8216;"</span> <span style="color: #61CE3C;">"&#8217;"</span>)
    (<span style="color: #61CE3C;">"\""</span> <span style="color: #61CE3C;">"&#8220;"</span> <span style="color: #61CE3C;">"&#8221;"</span>)
    (<span style="color: #61CE3C;">"_"</span> <span style="color: #61CE3C;">"&#8213;&#8213;"</span>)
    (<span style="color: #61CE3C;">"^"</span> <span style="color: #61CE3C;">"&#8230;&#8230;"</span>)
    (<span style="color: #61CE3C;">"]"</span> <span style="color: #61CE3C;">"&#12305;"</span>)
    (<span style="color: #61CE3C;">"["</span> <span style="color: #61CE3C;">"&#12304;"</span>)
    (<span style="color: #61CE3C;">"@"</span> <span style="color: #61CE3C;">"&#9678;"</span>)
    (<span style="color: #61CE3C;">"?"</span> <span style="color: #61CE3C;">"&#65311;"</span>)
    (<span style="color: #61CE3C;">"&gt;"</span> <span style="color: #61CE3C;">"&#12299;"</span>)
    (<span style="color: #61CE3C;">"="</span> <span style="color: #61CE3C;">"&#65309;"</span>)
    (<span style="color: #61CE3C;">"&lt;"</span> <span style="color: #61CE3C;">"&#12298;"</span>)
    (<span style="color: #61CE3C;">";"</span> <span style="color: #61CE3C;">"&#65307;"</span>)
    (<span style="color: #61CE3C;">":"</span> <span style="color: #61CE3C;">"&#65306;"</span>)
    (<span style="color: #61CE3C;">"/"</span> <span style="color: #61CE3C;">"&#12289;"</span>)
    (<span style="color: #61CE3C;">"."</span> <span style="color: #61CE3C;">"&#12290;"</span>)
    (<span style="color: #61CE3C;">"-"</span> <span style="color: #61CE3C;">"&#65293;"</span>)
    (<span style="color: #61CE3C;">","</span> <span style="color: #61CE3C;">"&#65292;"</span>)
    (<span style="color: #61CE3C;">"+"</span> <span style="color: #61CE3C;">"&#65291;"</span>)
    (<span style="color: #61CE3C;">"*"</span> <span style="color: #61CE3C;">"&#215;"</span>)
    (<span style="color: #61CE3C;">")"</span> <span style="color: #61CE3C;">"&#65289;"</span>)
    (<span style="color: #61CE3C;">"("</span> <span style="color: #61CE3C;">"&#65288;"</span>)
    (<span style="color: #61CE3C;">"&amp;"</span> <span style="color: #61CE3C;">"&#8251;"</span>)
    (<span style="color: #61CE3C;">"%"</span> <span style="color: #61CE3C;">"&#65285;"</span>)
    (<span style="color: #61CE3C;">"$"</span> <span style="color: #61CE3C;">"&#65509;"</span>)
    (<span style="color: #61CE3C;">"#"</span> <span style="color: #61CE3C;">"&#65283;"</span>)
    (<span style="color: #61CE3C;">"!"</span> <span style="color: #61CE3C;">"&#65281;"</span>)
    (<span style="color: #61CE3C;">"`"</span> <span style="color: #61CE3C;">"&#12539;"</span>)
    (<span style="color: #61CE3C;">"~"</span> <span style="color: #61CE3C;">"&#65374;"</span>)
    (<span style="color: #61CE3C;">"}"</span> <span style="color: #61CE3C;">"&#12303;"</span>)
    (<span style="color: #61CE3C;">"|"</span> <span style="color: #61CE3C;">"&#247;"</span>)
    (<span style="color: #61CE3C;">"{"</span> <span style="color: #61CE3C;">"&#12302;"</span>))
  <span style="color: #61CE3C;">"&#26631;&#28857;&#31526;&#21495;&#34920;&#12290;"</span>
  <span style="color: #FF6400;">:group</span> 'chinese-pyim
  <span style="color: #FF6400;">:type</span> 'list)

(<span style="color: #FBDE2D;">defcustom</span> <span style="color: #D8FA3C;">pyim-translate-trigger-char</span> ?v
  <span style="color: #61CE3C;">"&#29992;&#20110;&#35302;&#21457;&#29305;&#27530;&#25805;&#20316;&#30340;&#23383;&#31526;&#65292;&#30456;&#24403;&#19982;&#21333;&#23383;&#24555;&#25463;&#38190;&#12290;</span>

<span style="color: #61CE3C;">Chinese-pyim &#20869;&#24314;&#30340;&#21151;&#33021;&#26377;&#65306;</span>
<span style="color: #61CE3C;">1. &#20809;&#26631;&#21069;&#38754;&#30340;&#23383;&#31526;&#20026;&#26631;&#28857;&#31526;&#21495;&#26102;&#65292;&#25353;&#36825;&#20010;&#23383;&#31526;&#21487;&#20197;&#20999;&#25442;&#21069;&#38754;&#30340;&#26631;</span>
<span style="color: #61CE3C;">   &#28857;&#31526;&#21495;&#30340;&#26679;&#24335;&#65288;&#21322;&#35282;/&#20840;&#35282;&#65289;</span>
<span style="color: #61CE3C;">2. &#24403;&#20809;&#26631;&#21069;&#38754;&#20026;&#20013;&#25991;&#23383;&#31526;&#20018;&#26102;&#65292;&#36755;&#20837; &lt;num&gt;v &#21487;&#20197;&#29992;&#20110;&#20445;&#23384;&#33258;&#23450;&#20041;&#35789;&#26465;&#12290;"</span>
  <span style="color: #FF6400;">:group</span> 'chinese-pyim
  <span style="color: #FF6400;">:type</span> 'character)

(<span style="color: #FBDE2D;">defcustom</span> <span style="color: #D8FA3C;">pyim-fuzzy-pinyin-adjust-function</span>
  'pyim-fuzzy-pinyin-adjust-1
  <span style="color: #61CE3C;">"&#35774;&#23450;&#31970;&#31946;&#38899;&#22788;&#29702;&#20989;&#25968;"</span>
  <span style="color: #FF6400;">:group</span> 'chinese-pyim
  <span style="color: #FF6400;">:type</span> 'function)

(<span style="color: #FBDE2D;">defcustom</span> <span style="color: #D8FA3C;">pyim-enable-words-predict</span>
  '(pinyin-similar guess-words)
  <span style="color: #61CE3C;">"&#19968;&#20010; list&#65292;&#29992;&#20110;&#35774;&#32622;&#35789;&#35821;&#32852;&#24819;&#26041;&#24335;&#65292;&#24403;&#21069;&#25903;&#25345;&#65306;</span>

<span style="color: #61CE3C;">1. `</span><span style="color: #61CE3C;">pinyin-similar</span><span style="color: #61CE3C;">' &#25628;&#32034;&#25340;&#38899;&#31867;&#20284;&#30340;&#35789;&#26465;&#20570;&#20026;&#32852;&#24819;&#35789;&#12290;</span>
<span style="color: #61CE3C;">2. `</span><span style="color: #61CE3C;">pinyin-shouzimu</span><span style="color: #61CE3C;">' &#25628;&#32034;&#25340;&#38899;&#39318;&#23383;&#27597;&#23545;&#24212;&#30340;&#35789;&#26465;&#20570;&#20026;&#32852;&#24819;&#35789;&#12290;</span>
<span style="color: #61CE3C;">3. `</span><span style="color: #61CE3C;">pinyin-znabc</span><span style="color: #61CE3C;">' &#31867;&#20284;&#26234;&#33021;ABC&#30340;&#35789;&#35821;&#32852;&#24819;(&#28304;&#20110; emacs-eim)&#12290;</span>
<span style="color: #61CE3C;">4. `</span><span style="color: #61CE3C;">guess-words</span><span style="color: #61CE3C;">' &#20197;&#19978;&#27425;&#36755;&#20837;&#30340;&#35789;&#26465;&#20026; code&#65292;&#28982;&#21518;&#22312; guessdict &#20013;&#25628;&#32034;&#65292;</span>
<span style="color: #61CE3C;">                 &#29992;&#25628;&#32034;&#24471;&#21040;&#30340;&#35789;&#26465;&#26469;&#25552;&#39640;&#36755;&#20837;&#27861;&#35782;&#21035;&#31934;&#24230;&#12290;</span>

<span style="color: #61CE3C;">                 &#27880;&#24847;&#65306;&#36825;&#20010;&#26041;&#27861;&#38656;&#35201;&#29992;&#25143;&#23433;&#35013; guessdict &#35789;&#24211;&#65292;</span>
<span style="color: #61CE3C;">                       guessdict &#35789;&#24211;&#25991;&#20214;&#21487;&#20197;&#29992; `</span><span style="color: #61CE3C;">pyim-article2dict-guessdict</span><span style="color: #61CE3C;">'</span>
<span style="color: #61CE3C;">                       &#21629;&#20196;&#29983;&#25104;&#12290;</span>

<span style="color: #61CE3C;">&#24403;&#36825;&#20010;&#21464;&#37327;&#35774;&#32622;&#20026; nil &#26102;&#65292;&#20851;&#38381;&#35789;&#35821;&#32852;&#24819;&#21151;&#33021;&#12290;"</span>
  <span style="color: #FF6400;">:group</span> 'chinese-pyim)

(<span style="color: #FBDE2D;">defcustom</span> <span style="color: #D8FA3C;">pyim-page-length</span> 5
  <span style="color: #61CE3C;">"&#27599;&#39029;&#26174;&#31034;&#30340;&#35789;&#26465;&#25968;&#30446;"</span>
  <span style="color: #FF6400;">:group</span> 'chinese-pyim
  <span style="color: #FF6400;">:type</span> 'number)

(<span style="color: #FBDE2D;">defface</span> <span style="color: #D8FA3C;">pyim-string-face</span> '((t (<span style="color: #FF6400;">:underline</span> t)))
  <span style="color: #61CE3C;">"Face to show current string"</span>
  <span style="color: #FF6400;">:group</span> 'chinese-pyim)

(<span style="color: #FBDE2D;">defface</span> <span style="color: #D8FA3C;">pyim-minibuffer-string-face</span> '((t (<span style="color: #FF6400;">:background</span> <span style="color: #61CE3C;">"gray40"</span>)))
  <span style="color: #61CE3C;">"Face to current string show in minibuffer"</span>
  <span style="color: #FF6400;">:group</span> 'chinese-pyim)

(<span style="color: #FBDE2D;">defcustom</span> <span style="color: #D8FA3C;">pyim-tooltip-color</span> nil
  <span style="color: #61CE3C;">"&#35774;&#32622; tooltip &#36873;&#35789;&#26694;&#30340;&#39068;&#33394;&#65292;&#35774;&#32622;&#26684;&#24335;&#20026;&#65306;</span>

<span style="color: #61CE3C;">    (FOREGROUND-COLOR . BACKGROUND-COLOR)</span>

<span style="color: #61CE3C;">&#20363;&#22914;&#65306;</span>

<span style="color: #61CE3C;">   (\"white\" . \"black\")</span>

<span style="color: #61CE3C;">&#22914;&#26524;&#36825;&#20010;&#21464;&#37327;&#35774;&#32622;&#20026; nil&#65292;&#40664;&#35748;&#23558;&#20351;&#29992;&#21464;&#37327; `</span><span style="color: #61CE3C;">pos-tip-foreground-color</span><span style="color: #61CE3C;">' &#26469;&#25351;&#23450;</span>
<span style="color: #61CE3C;">&#21069;&#26223;&#39068;&#33394;&#65292;&#20351;&#29992;&#21464;&#37327; `</span><span style="color: #61CE3C;">pos-tip-background-color</span><span style="color: #61CE3C;">' &#26469;&#25351;&#23450;&#32972;&#26223;&#39068;&#33394;&#12290;"</span>
  <span style="color: #FF6400;">:group</span> 'chinese-pyim)

(<span style="color: #FBDE2D;">defcustom</span> <span style="color: #D8FA3C;">pyim-english-input-switch-function</span> nil
  <span style="color: #61CE3C;">"&#19968;&#20010;&#20989;&#25968;&#65292;&#20854;&#36816;&#34892;&#32467;&#26524;&#20026; t &#26102;&#65292;Chinese-pyim &#24320;&#21551;&#33521;&#25991;&#36755;&#20837;&#21151;&#33021;&#12290;"</span>
  <span style="color: #FF6400;">:group</span> 'chinese-pyim
  <span style="color: #FF6400;">:type</span> 'function)

(<span style="color: #FBDE2D;">defcustom</span> <span style="color: #D8FA3C;">pyim-select-word-finish-hook</span> nil
  <span style="color: #61CE3C;">"Chinese-pyim &#36873;&#35789;&#23436;&#25104;&#26102;&#36816;&#34892;&#30340;hook&#65292;"</span>
  <span style="color: #FF6400;">:group</span> 'chinese-pyim
  <span style="color: #FF6400;">:type</span> 'hook)

(<span style="color: #FBDE2D;">defcustom</span> <span style="color: #D8FA3C;">pyim-use-tooltip</span>  t
  <span style="color: #61CE3C;">"&#22914;&#20309;&#26174;&#31034; Chinese-pyim &#36873;&#35789;&#26694;&#65292;&#24403;&#21462;&#20540;&#20026; t &#24182;&#19988; *tooltip &#21151;&#33021;&#21487;&#20197;&#27491;&#24120;&#20351;&#29992;*</span>
<span style="color: #61CE3C;">&#26102;&#65292;&#20351;&#29992; tooltip &#26174;&#31034;&#36873;&#35789;&#26694;&#65292;&#24403;&#21462;&#20540;&#20026; nil &#26102;&#65292;&#20351;&#29992; minibuffer &#26174;&#31034;&#36873;&#35789;&#26694;&#12290;</span>

<span style="color: #61CE3C;">&#20855;&#20307;&#32454;&#33410;&#35831;&#21442;&#32771;&#20989;&#25968; `</span><span style="color: #61CE3C;">pyim-use-tooltip-p</span><span style="color: #61CE3C;">' ."</span>
  <span style="color: #FF6400;">:group</span> 'chinese-pyim)

(<span style="color: #FBDE2D;">defcustom</span> <span style="color: #D8FA3C;">pyim-tooltip-width-adjustment</span> 1.2
  <span style="color: #61CE3C;">"&#26657;&#27491; tooltip &#36873;&#35789;&#26694;&#23485;&#24230;&#30340;&#25968;&#20540;&#65292;&#34920;&#31034;&#26657;&#27491;&#21518;&#30340;&#23485;&#24230;&#26159;&#26410;&#26657;&#27491;&#21069;&#23485;&#24230;&#30340;&#20493;&#25968;&#12290;</span>

<span style="color: #61CE3C;">&#30001;&#20110;&#23383;&#20307;&#35774;&#32622;&#31561;&#21407;&#22240;&#65292;tooltip &#36873;&#35789;&#26694;&#23454;&#38469;&#23485;&#24230;&#20250;&#27604; *&#39044;&#26399;&#23485;&#24230;* &#20559;&#22823;&#25110;&#32773;&#20559;&#23567;&#65292;</span>
<span style="color: #61CE3C;">&#36825;&#26102;&#65292;&#26377;&#21487;&#33021;&#20250;&#20986;&#29616;&#36873;&#35789;&#26694;&#35789;&#26465;&#26174;&#31034;&#19981;&#20840;&#25110;&#32773;&#36873;&#35789;&#26694;&#24377;&#20986;&#20301;&#32622;&#19981;&#21512;&#29702;&#31561;&#38382;&#39064;&#12290;&#29992;&#25143;&#21487;&#20197;&#36890;&#36807;</span>
<span style="color: #61CE3C;">&#22686;&#22823;&#25110;&#32773;&#20943;&#23567;&#36825;&#20010;&#21464;&#37327;&#26469;&#25913;&#21464; tooltip &#36873;&#35789;&#26694;&#30340;&#23485;&#24230;&#65292;&#21462;&#20540;&#22823;&#27010;&#22312; 0.5 ~ 2.0 &#33539;&#22260;&#20043;&#20869;&#12290;"</span>
  <span style="color: #FF6400;">:group</span> 'chinese-pyim)

(<span style="color: #FBDE2D;">defvar</span> <span style="color: #D8FA3C;">pyim-title</span> <span style="color: #61CE3C;">"&#28789;&#25340;"</span> <span style="color: #61CE3C;">"Chinese-pyim &#22312; mode-line &#20013;&#26174;&#31034;&#30340;&#21517;&#31216;&#12290;"</span>)
(<span style="color: #FBDE2D;">defvar</span> <span style="color: #D8FA3C;">pyim-buffer-name</span> <span style="color: #61CE3C;">" *Chinese-pyim*"</span>)
(<span style="color: #FBDE2D;">defvar</span> <span style="color: #D8FA3C;">pyim-buffer-list</span> nil
  <span style="color: #61CE3C;">"&#19968;&#20010;&#21015;&#34920;&#65292;&#29992;&#26469;&#20445;&#23384;&#35789;&#24211;&#25991;&#20214;&#19982; buffer &#30340;&#23545;&#24212;&#20449;&#24687;&#12290;</span>
<span style="color: #61CE3C;">1. &#27599;&#20010;&#20803;&#32032;&#37117;&#26159;&#19968;&#20010; alist&#12290;</span>
<span style="color: #61CE3C;">2. &#27599;&#19968;&#20010; alist &#37117;&#21253;&#21547;&#20004;&#20010;&#37096;&#20221;&#65306;</span>
<span style="color: #61CE3C;">   1. buffer &#35789;&#24211;&#25991;&#20214;&#23548;&#20837;&#26102;&#21019;&#24314;&#30340; buffer (&#29992;&#25143;&#19981;&#21487;&#35265;)&#12290;</span>
<span style="color: #61CE3C;">   2. file   &#35789;&#24211;&#25991;&#20214;&#30340;&#36335;&#24452;&#12290;"</span>)

(<span style="color: #FBDE2D;">defvar</span> <span style="color: #D8FA3C;">pyim-buffer-cache-list</span> nil
  <span style="color: #61CE3C;">"&#19968;&#20010;&#21015;&#34920;&#65292;&#29992;&#26469;&#32531;&#23384; `</span><span style="color: #61CE3C;">pyim-buffer-list</span><span style="color: #61CE3C;">' &#20013;&#30340;&#26222;&#36890;&#35789;&#24211; buffer&#65292;&#20197;&#21152;&#24555;&#35775;&#38382;&#36895;&#24230;&#12290;</span>

<span style="color: #61CE3C;">1. &#27599;&#20010;&#20803;&#32032;&#37117;&#26159;&#19968;&#20010; alist&#12290;</span>
<span style="color: #61CE3C;">2. &#27599;&#19968;&#20010; alist &#37117;&#21253;&#21547;&#20004;&#20010;&#37096;&#20221;&#65306;</span>
<span style="color: #61CE3C;">   1. buffer &#35789;&#24211;&#25991;&#20214;&#23548;&#20837;&#26102;&#21019;&#24314;&#30340; buffer (&#29992;&#25143;&#19981;&#21487;&#35265;)&#12290;</span>
<span style="color: #61CE3C;">   2. buffer-cache &#20174;&#35789;&#24211; buffer &#20013;&#26500;&#24314;&#30340;&#19968;&#20010; hashtable&#12290;</span>

<span style="color: #61CE3C;">&#27880;&#24847;&#65306; *&#19981;&#32531;&#23384;* &#20010;&#20154;&#35789;&#24211;&#25991;&#20214; buffer &#21644; guessdict &#35789;&#24211;&#25991;&#20214; buffer&#12290;"</span>)

(<span style="color: #FBDE2D;">defvar</span> <span style="color: #D8FA3C;">pyim-shen-mu</span>
  '(<span style="color: #61CE3C;">"b"</span> <span style="color: #61CE3C;">"p"</span> <span style="color: #61CE3C;">"m"</span> <span style="color: #61CE3C;">"f"</span> <span style="color: #61CE3C;">"d"</span> <span style="color: #61CE3C;">"t"</span> <span style="color: #61CE3C;">"n"</span> <span style="color: #61CE3C;">"l"</span> <span style="color: #61CE3C;">"g"</span> <span style="color: #61CE3C;">"k"</span> <span style="color: #61CE3C;">"h"</span>
    <span style="color: #61CE3C;">"j"</span> <span style="color: #61CE3C;">"q"</span> <span style="color: #61CE3C;">"x"</span> <span style="color: #61CE3C;">"z"</span> <span style="color: #61CE3C;">"c"</span> <span style="color: #61CE3C;">"s"</span> <span style="color: #61CE3C;">"zh"</span> <span style="color: #61CE3C;">"ch"</span> <span style="color: #61CE3C;">"sh"</span> <span style="color: #61CE3C;">"r"</span> <span style="color: #61CE3C;">"y"</span> <span style="color: #61CE3C;">"w"</span>))

(<span style="color: #FBDE2D;">defvar</span> <span style="color: #D8FA3C;">pyim-yun-mu</span>
  '(<span style="color: #61CE3C;">"a"</span> <span style="color: #61CE3C;">"o"</span> <span style="color: #61CE3C;">"e"</span> <span style="color: #61CE3C;">"i"</span> <span style="color: #61CE3C;">"u"</span> <span style="color: #61CE3C;">"v"</span> <span style="color: #61CE3C;">"ai"</span> <span style="color: #61CE3C;">"ei"</span> <span style="color: #61CE3C;">"ui"</span> <span style="color: #61CE3C;">"ao"</span> <span style="color: #61CE3C;">"ou"</span> <span style="color: #61CE3C;">"iu"</span>
    <span style="color: #61CE3C;">"ie"</span> <span style="color: #61CE3C;">"ia"</span> <span style="color: #61CE3C;">"ua"</span> <span style="color: #61CE3C;">"ve"</span> <span style="color: #61CE3C;">"er"</span> <span style="color: #61CE3C;">"an"</span> <span style="color: #61CE3C;">"en"</span> <span style="color: #61CE3C;">"in"</span> <span style="color: #61CE3C;">"un"</span> <span style="color: #61CE3C;">"vn"</span> <span style="color: #61CE3C;">"ang"</span> <span style="color: #61CE3C;">"iong"</span>
    <span style="color: #61CE3C;">"eng"</span> <span style="color: #61CE3C;">"ing"</span> <span style="color: #61CE3C;">"ong"</span> <span style="color: #61CE3C;">"uan"</span> <span style="color: #61CE3C;">"uang"</span> <span style="color: #61CE3C;">"ian"</span> <span style="color: #61CE3C;">"iang"</span> <span style="color: #61CE3C;">"iao"</span> <span style="color: #61CE3C;">"ue"</span>
    <span style="color: #61CE3C;">"uai"</span> <span style="color: #61CE3C;">"uo"</span>))

(<span style="color: #FBDE2D;">defvar</span> <span style="color: #D8FA3C;">pyim-valid-yun-mu</span>
  '(<span style="color: #61CE3C;">"a"</span> <span style="color: #61CE3C;">"o"</span> <span style="color: #61CE3C;">"e"</span> <span style="color: #61CE3C;">"ai"</span> <span style="color: #61CE3C;">"ei"</span> <span style="color: #61CE3C;">"ui"</span> <span style="color: #61CE3C;">"ao"</span> <span style="color: #61CE3C;">"ou"</span> <span style="color: #61CE3C;">"er"</span> <span style="color: #61CE3C;">"an"</span> <span style="color: #61CE3C;">"en"</span>
    <span style="color: #61CE3C;">"ang"</span> <span style="color: #61CE3C;">"eng"</span>))

(<span style="color: #FBDE2D;">defvar</span> <span style="color: #D8FA3C;">pyim-char-table</span> (make-vector 1511 nil))

(<span style="color: #FBDE2D;">defvar</span> <span style="color: #D8FA3C;">pyim-current-key</span> <span style="color: #61CE3C;">""</span> <span style="color: #61CE3C;">"&#24050;&#32463;&#36755;&#20837;&#30340;&#20195;&#30721;"</span>)
(<span style="color: #FBDE2D;">defvar</span> <span style="color: #D8FA3C;">pyim-current-str</span> <span style="color: #61CE3C;">""</span> <span style="color: #61CE3C;">"&#24403;&#21069;&#36873;&#25321;&#30340;&#35789;&#26465;"</span>)
(<span style="color: #FBDE2D;">defvar</span> <span style="color: #D8FA3C;">pyim-last-input-word</span> <span style="color: #61CE3C;">""</span> <span style="color: #61CE3C;">"&#20445;&#23384;&#19978;&#19968;&#27425;&#36755;&#20837;&#36807;&#30340;&#35789;&#26465;&#65292;&#29992;&#20110;&#23454;&#29616;&#26576;&#31181;&#35789;&#35821;&#32852;&#24819;&#21151;&#33021;&#12290;"</span>)
(<span style="color: #FBDE2D;">defvar</span> <span style="color: #D8FA3C;">pyim-input-ascii</span> nil
  <span style="color: #61CE3C;">"&#26159;&#21542;&#24320;&#21551; Chinese-pyim &#33521;&#25991;&#36755;&#20837;&#27169;&#24335;&#12290;"</span>)

(<span style="color: #FBDE2D;">defvar</span> <span style="color: #D8FA3C;">pyim-current-choices</span> nil
  <span style="color: #61CE3C;">"&#25152;&#26377;&#21487;&#36873;&#30340;&#35789;&#26465;&#65292;&#26159;&#19968;&#20010;list&#12290;</span>
<span style="color: #61CE3C;">1. CAR &#37096;&#20221;&#26159;&#21487;&#36873;&#30340;&#35789;&#26465;&#65292;&#19968;&#33324;&#26159;&#19968;&#20010;&#23383;&#31526;&#20018;&#21015;&#34920;&#12290;</span>
<span style="color: #61CE3C;">   &#20063;&#21487;&#20197;&#21547;&#26377;list&#12290;&#20294;&#26159;&#21253;&#21547;&#30340;list&#31532;&#19968;&#20010;&#20803;&#32032;&#24517;&#39035;&#26159;&#23558;&#35201;&#25554;&#20837;&#30340;&#23383;&#31526;&#20018;&#12290;</span>
<span style="color: #61CE3C;">2. CDR &#37096;&#20998;&#26159;&#19968;&#20010; Association list&#12290;&#36890;&#24120;&#21547;&#26377;&#36825;&#26679;&#30340;&#20869;&#23481;&#65306;</span>
<span style="color: #61CE3C;">   1. pos &#19978;&#27425;&#36873;&#25321;&#30340;&#20301;&#32622;</span>
<span style="color: #61CE3C;">   2. completion &#19979;&#19968;&#20010;&#21487;&#33021;&#30340;&#23383;&#27597;&#65288;&#22914;&#26524; pyim-do-completion &#20026; t&#65289;"</span>)

(<span style="color: #FBDE2D;">defvar</span> <span style="color: #D8FA3C;">pyim-translating</span> nil <span style="color: #61CE3C;">"&#35760;&#24405;&#26159;&#21542;&#22312;&#36716;&#25442;&#29366;&#24577;"</span>)

(<span style="color: #FBDE2D;">defvar</span> <span style="color: #D8FA3C;">pyim-overlay</span> nil <span style="color: #61CE3C;">"&#26174;&#31034;&#24403;&#21069;&#36873;&#25321;&#35789;&#26465;&#30340; overlay"</span>)

(<span style="color: #FBDE2D;">defvar</span> <span style="color: #D8FA3C;">pyim-pinyin-position</span> nil)
(<span style="color: #FBDE2D;">defvar</span> <span style="color: #D8FA3C;">pyim-pinyin-list</span> nil)

(<span style="color: #FBDE2D;">defvar</span> <span style="color: #D8FA3C;">pyim-guidance-str</span> <span style="color: #61CE3C;">""</span> <span style="color: #61CE3C;">"&#26174;&#31034;&#21487;&#36873;&#35789;&#26465;&#30340;&#23383;&#31526;&#20018;"</span>)
(<span style="color: #FBDE2D;">defvar</span> <span style="color: #D8FA3C;">pyim-current-pos</span> nil <span style="color: #61CE3C;">"&#24403;&#21069;&#36873;&#25321;&#30340;&#35789;&#26465;&#22312; pyim-current-choices &#20013;&#30340;&#20301;&#32622;"</span>)

(<span style="color: #FBDE2D;">defvar</span> <span style="color: #D8FA3C;">pyim-load-hook</span> nil)
(<span style="color: #FBDE2D;">defvar</span> <span style="color: #D8FA3C;">pyim-active-hook</span> nil)

(<span style="color: #FBDE2D;">defvar</span> <span style="color: #D8FA3C;">pyim-punctuation-translate-p</span> t
  <span style="color: #61CE3C;">"*Non-nil means will translate punctuation."</span>)

(<span style="color: #FBDE2D;">defvar</span> <span style="color: #D8FA3C;">pyim-pair-punctuation-status</span>
  '((<span style="color: #61CE3C;">"\""</span> nil) (<span style="color: #61CE3C;">"'"</span> nil))
  <span style="color: #61CE3C;">"&#25104;&#23545;&#26631;&#28857;&#31526;&#21495;&#20999;&#25442;&#29366;&#24577;"</span>)

(<span style="color: #FBDE2D;">defvar</span> <span style="color: #D8FA3C;">pyim-punctuation-escape-list</span> (number-sequence ?0 ?9)
  <span style="color: #61CE3C;">"Punctuation will not insert after this characters.</span>
<span style="color: #61CE3C;">If you don't like this funciton, set the variable to nil"</span>)

(<span style="color: #FBDE2D;">defvar</span> <span style="color: #D8FA3C;">pyim-mode-map</span>
  (<span style="color: #FBDE2D;">let</span> ((map (make-sparse-keymap))
        (i ?\ ))
    (<span style="color: #FBDE2D;">while</span> (&lt; i 127)
      (define-key map (char-to-string i) 'pyim-self-insert-command)
      (<span style="color: #FBDE2D;">setq</span> i (1+ i)))
    (<span style="color: #FBDE2D;">setq</span> i 128)
    (<span style="color: #FBDE2D;">while</span> (&lt; i 256)
      (define-key map (vector i) 'pyim-self-insert-command)
      (<span style="color: #FBDE2D;">setq</span> i (1+ i)))
    (<span style="color: #FBDE2D;">dolist</span> (i (number-sequence ?1 ?9))
      (define-key map (char-to-string i) 'pyim-number-select))
    (define-key map <span style="color: #61CE3C;">" "</span> 'pyim-select-current)
    (define-key map [backspace] 'pyim-delete-last-char)
    (define-key map (kbd <span style="color: #61CE3C;">"M-DEL"</span>) 'pyim-backward-kill-py)
    (define-key map [tab] 'pyim-fuzzy-pinyin-adjust)
    (define-key map (kbd <span style="color: #61CE3C;">"TAB"</span>) 'pyim-fuzzy-pinyin-adjust)
    (define-key map <span style="color: #61CE3C;">"\M-g"</span> 'pyim-fuzzy-pinyin-adjust)
    (define-key map [delete] 'pyim-delete-last-char)
    (define-key map <span style="color: #61CE3C;">"\177"</span> 'pyim-delete-last-char)
    (define-key map <span style="color: #61CE3C;">"\C-n"</span> 'pyim-next-page)
    (define-key map <span style="color: #61CE3C;">"\C-p"</span> 'pyim-previous-page)
    (define-key map <span style="color: #61CE3C;">"\C-f"</span> 'pyim-next-word)
    (define-key map <span style="color: #61CE3C;">"\C-b"</span> 'pyim-previous-word)
    (define-key map <span style="color: #61CE3C;">"="</span> 'pyim-next-page)
    (define-key map <span style="color: #61CE3C;">"-"</span> 'pyim-previous-page)
    (define-key map <span style="color: #61CE3C;">"\M-n"</span> 'pyim-next-page)
    (define-key map <span style="color: #61CE3C;">"\M-p"</span> 'pyim-previous-page)
    (define-key map <span style="color: #61CE3C;">"\C-m"</span> 'pyim-quit-no-clear)
    (define-key map [return] 'pyim-quit-no-clear)
    (define-key map <span style="color: #61CE3C;">"\C-c"</span> 'pyim-quit-clear)
    (define-key map <span style="color: #61CE3C;">"\C-g"</span> 'pyim-quit-clear)
    map)
  <span style="color: #61CE3C;">"Keymap"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline3" class="outline-3">
<h3 id="orgheadline3"><span class="section-number-3">2.2</span> 将变量转换为 local 变量</h3>
<div class="outline-text-3" id="text-2-2">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #FBDE2D;">defvar</span> <span style="color: #D8FA3C;">pyim-local-variable-list</span>
  '(pyim-current-key
    pyim-current-str
    pyim-current-choices
    pyim-current-pos
    pyim-input-ascii
    pyim-english-input-switch-function
    pyim-guidance-str
    pyim-translating
    pyim-overlay

    pyim-load-hook
    pyim-active-hook

    input-method-function
    inactivate-current-input-method-function
    describe-current-input-method-function

    pyim-punctuation-translate-p
    pyim-pair-punctuation-status
    pyim-punctuation-escape-list

    pyim-pinyin-list
    pyim-pinyin-position)
  <span style="color: #61CE3C;">"A list of buffer local variable"</span>)

(<span style="color: #FBDE2D;">dolist</span> (var pyim-local-variable-list)
  (make-variable-buffer-local var)
  (put var 'permanent-local t))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline4" class="outline-3">
<h3 id="orgheadline4"><span class="section-number-3">2.3</span> 输入法启动和重启</h3>
<div class="outline-text-3" id="text-2-3">
<p>
Chinese-pyim 使用 emacs 官方自带的输入法框架来启动输入法和重启输入法。所以我们首先需要使用 emacs 自带的命令 `register-input-method' 注册一个输入法。
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #8B8989; font-style: italic;">;;; </span><span style="color: #8B8989; font-style: italic;">&#27880;&#20876;&#36755;&#20837;&#27861;</span>
(register-input-method <span style="color: #61CE3C;">"chinese-pyim"</span> <span style="color: #61CE3C;">"euc-cn"</span> 'pyim-start pyim-title)
</pre>
</div>

<p>
真正启动 Chinese-pyim 的命令是 `pyim-start' ，这个命令做如下工作：
</p>
<ol class="org-ol">
<li>重置 `pyim-local-variable-list' 中所有的 local 变量。</li>
<li>使用 `pyim-load-file’加载词库文件，具体细节请参考：<a href="#load-dicts">2.4.2</a></li>
<li>使用 `pyim-make-char-table' 创建汉字到拼音的 hash table，具体细节请参考：<a href="#make-char-table">2.11</a></li>
<li>运行hook： `pyim-load-hook'。</li>
<li>将 `pyim-save-personal-file' 命令添加到 `kill-emacs-hook' emacs 关闭之前将个人词频 buffer 的内容保存到个人词频文件。具体细节请参考：
<a href="#orgtarget1">2.4.2</a>。</li>
<li>设定变量：
<ol class="org-ol">
<li>`input-method-function'</li>
<li>`deactivate-current-input-method-function'</li>
</ol></li>
<li>运行 `pyim-active-hook'</li>
</ol>

<p>
`pyim-start' 先后会运行两个 hook，所以我们需要事先定义：
</p>

<p>
`pyim-restart' 用于重启 Chinese-pyim，其过程和 `pyim-start' 类似，不同之处有：
</p>

<ol class="org-ol">
<li>输入法重启之前会询问用户，是否保存个人词频信息。</li>
<li>重启之前会使用函数 `pyim-kill-buffers' 删除所有的词库 buffer，具体请参考：<a href="#orgtarget2">2.4.2</a></li>
</ol>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-start</span> (name <span style="color: #D8FA3C;">&amp;optional</span> active-func restart save-personal-file)
  (<span style="color: #FBDE2D;">interactive</span>)
  (mapc 'kill-local-variable pyim-local-variable-list)
  (mapc 'make-local-variable pyim-local-variable-list)
  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#37325;&#21551;&#26102;&#65292;kill &#25152;&#26377;&#24050;&#32463;&#25171;&#24320;&#30340; buffer&#12290;</span>
  (<span style="color: #FBDE2D;">when</span> (<span style="color: #FBDE2D;">and</span> restart save-personal-file)
    (pyim-save-personal-file))
  (<span style="color: #FBDE2D;">when</span> restart
    (pyim-kill-buffers)
    (<span style="color: #FBDE2D;">setq</span> pyim-buffer-list nil))
  (<span style="color: #FBDE2D;">unless</span> (<span style="color: #FBDE2D;">and</span> pyim-buffer-list
               (pyim-check-buffers)
               (not restart))
    (<span style="color: #FBDE2D;">setq</span> pyim-buffer-list (pyim-load-file))
    (pyim-make-char-table)
    (run-hooks 'pyim-load-hook)
    (message nil))

  (<span style="color: #FBDE2D;">unless</span> (member 'pyim-save-personal-file kill-emacs-hook)
    (add-to-list 'kill-emacs-hook 'pyim-save-personal-file))

  (<span style="color: #FBDE2D;">setq</span> input-method-function 'pyim-input-method)
  (<span style="color: #FBDE2D;">setq</span> deactivate-current-input-method-function 'pyim-inactivate)
  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">(setq describe-current-input-method-function 'pyim-help)</span>
  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">If we are in minibuffer, turn off the current input method</span>
  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">before exiting.</span>
  (<span style="color: #FBDE2D;">when</span> (eq (selected-window) (minibuffer-window))
    (add-hook 'minibuffer-exit-hook 'pyim-exit-from-minibuffer))
  (run-hooks 'pyim-active-hook)
  (<span style="color: #FBDE2D;">when</span> restart
    (message <span style="color: #61CE3C;">"Chinese-pyim &#37325;&#21551;&#23436;&#25104;&#12290;"</span>)))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-exit-from-minibuffer</span> ()
  (deactivate-input-method)
  (<span style="color: #FBDE2D;">when</span> (&lt;= (minibuffer-depth) 1)
    (remove-hook 'minibuffer-exit-hook 'quail-exit-from-minibuffer)))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-restart</span> ()
  <span style="color: #61CE3C;">"&#37325;&#21551; Chinese-pyim&#65292;&#19981;&#24314;&#35758;&#29992;&#20110;&#32534;&#31243;&#29615;&#22659;&#12290;"</span>
  (<span style="color: #FBDE2D;">interactive</span>)
  (<span style="color: #FBDE2D;">let</span> ((file-save-p
         (yes-or-no-p <span style="color: #61CE3C;">"&#27491;&#22312;&#37325;&#21551; Chinese-pyim&#65292;&#38656;&#35201;&#20445;&#23384; personal &#25991;&#20214;&#30340;&#21464;&#21160;&#21527;&#65311; "</span>)))
    (pyim-restart-1 file-save-p)))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-restart-1</span> (save-personal-file)
  <span style="color: #61CE3C;">"&#37325;&#21551; Chinese-pyim&#65292;&#29992;&#20110;&#32534;&#31243;&#29615;&#22659;&#12290;"</span>
  (pyim-start <span style="color: #61CE3C;">"Chinese-pyim"</span> nil t save-personal-file))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline14" class="outline-3">
<h3 id="orgheadline14"><span class="section-number-3">2.4</span> 处理词库文件</h3>
<div class="outline-text-3" id="text-2-4">
</div><div id="outline-container-orgheadline8" class="outline-4">
<h4 id="orgheadline8"><span class="section-number-4">2.4.1</span> 自定义词库</h4>
<div class="outline-text-4" id="text-2-4-1">
</div><ol class="org-ol"><li><a id="orgheadline5"></a>词库文件格式<br  /><div class="outline-text-5" id="text-2-4-1-1">
<p>
Chinese-pyim 使用词库文件来保存各个拼音对应的中文词条，每一个词库文件都是简单的文本文件，其结构类似：
</p>

<pre class="example">
ni-bu-hao 你不好
ni-hao  你好 妮好 你豪
</pre>

<p>
第一个空白字符之前的内容为拼音code，空白字符之后为中文词条列表。拼音词库<b>不处理</b>中文标点符号。
</p>

<p>
注意：词库文件必须按行排序（准确的说，是按每一行的 code 排序），因为
`Chinese-pyim' 为优化搜索速度，使用二分法寻找词条，而二分法工作的前提就是对文件按行排序。具体细节请参考：`pyim-bisearch-word' 。当用户手动调整词库文件后，记得运行 `pyim-update-dict-file' 来对文件排序。
</p>
</div></li>

<li><a id="orgheadline6"></a>个人词频文件<br  /><div class="outline-text-5" id="text-2-4-1-2">
<p>
虽然 Chinese-pyim 只使用一种词库文件格式，但定义了两种词库类型，用于不同的目的：
</p>
<ol class="org-ol">
<li>个人词频文件</li>
<li>普通词库文件</li>
<li>Guessdict词库文件</li>
</ol>

<p>
个人词频文件用来保存用户曾经输入过的中文词条以及这些词条输入的先后顺序（也就是词频信息）。Chinese-pyim 搜索中文词条时，个人词频文件里的词条优先显示。我们使用变量 `pyim-personal-file' 来保存个人词频文件的路径:
</p>

<p>
个人词频文件使用上述词库文件的格式来保存上述信息，将其独立出来的原因是：
</p>
<ol class="org-ol">
<li>随着 `Chinese-pyim' 使用时间的延长，个人词频文件会保存越来越多的用户常用的词条，属于用户隐私（提醒用户不要随意将这个文件泄露他人）。</li>
<li>个人词频文件的内容在 Chinese-pyim 使用过程中频繁的变动。</li>
<li>随着个人词频文件的积累，Chinese-pyim 会越来越顺手，所以个人词频文件需要用户经常备份。</li>
</ol>

<p>
值得注意的是：不建议用户<b>手动编辑</b>这个文件，因为：每次 emacs 关闭之前，emacs 会运行命令：`pyim-save-personal-file' 来更新这个文件，编辑过的内容将会被覆盖。
</p>

<p>
BUG：当用户错误的将这个变量设定为其他重要文件时，也存在文件内容破坏的风险。
</p>

<p>
当这个文件中的词条数量增长到一定程度，用户可以直接将这个文件转换为词库。
</p>
</div></li>

<li><a id="orgheadline7"></a>普通词库文件 和 Guessdict词库<br  /><div class="outline-text-5" id="text-2-4-1-3">
<p>
普通词库文件，也可以叫做共享词库文件，与个人词频文件相比，普通词库文件有如下特点：
</p>
<ol class="org-ol">
<li>词条数量巨大：普通词库文件中往往包含大量的词条信息（可能超过50万）。</li>
<li>内容变化很小：用户一般不需要编辑普通词库文件（开发词库的用户除外），所以普通词库文件的内容一般不会发生改变。</li>
<li>普通词库文件适宜制作词库包，在用户之间共享。</li>
</ol>

<p>
Guessdict词库用于词语联想，它与普通词库文件有类似的特征，唯一不同的是：
Guessdict词库的 code 是中文，而不是拼音。
</p>

<pre class="example">
我爱 北京 美女 旅游
我们 去哪 去看海
</pre>

<p>
我们使用变量 `pyim-dicts' 来设定普通词库文件和 guessdict 词库的信息：
</p>
<ol class="org-ol">
<li>`:name' 用户给词库设定的名称，暂时没有用处，未来可能用于构建词库包。</li>
<li>`:file' 词库文件的绝对路径。</li>
<li>`:coding' 词库文件的编码，词库文件是一个文本文件，window系统一般使用 GBK 编码来保存中文，而Linux系统一般使用 UTF-8 编码来保存中文，
emacs 似乎不能自动识别中文编码，所以要求用户明确告知词库文件使用什么编码来保存。</li>
<li>`:dict-type' 当前词库文件是普通词库还是 guessdict 词库，普通词库设置为 pinyin-dict，guessdict 词库设置为 guess-dict。</li>
</ol>
</div></li></ol>
</div>

<div id="outline-container-orgheadline9" class="outline-4">
<h4 id="load-dicts"><a id="orgheadline9"></a><span class="section-number-4">2.4.2</span> 加载词库</h4>
<div class="outline-text-4" id="text-load-dicts">
<p>
Chinese-pyim 激活时，首先会使用 `pyim-load-file' 加载个人词频文件和普通词库文件，如果个人词频文件不存在时，Chinese-pyim 会使用函数：
`pyim-create-template-dict' 自动创建这个文件。如果用户没有设定
`pyim-dicts'， `pyim-load-file' 会弹出警告信息，告知用户安装词库的命令。
</p>

<p>
`pyim-load-file' 加载词库简单来说就是：创建一个buffer，然后将词库文件的内容插入新创建的这个buffer，同时得到buffer和file的对应表。具体过程为：
</p>
<ol class="org-ol">
<li><p>
首先创建一个 buffer，buffer 的名称源自 `pyim-buffer-name'，
Chinese-pyim 默认创建的 buffer 名称类似：
</p>
<pre class="example">
-空格-*Chinese-pyim*
-空格-*Chinese-pyim*-10000
</pre>
<p>
这些buffer的名称前面都包含一个空格，所以在 emacs buffer列表中<b>不可见</b>。
</p></li>
<li>将个人词频文件 `pyim-personal-file' 的内容插入到已经创建的 buffer。</li>
<li>使用类似上述方法，递归的为每个普通词库文件创建 buffer 并插入对应词库文件的内容，忽略不存在的文件和已经加载过的文件。</li>
<li><p>
在运行的过程中，`pyim-load-file' 会创建一个词库文件名与 buffer 的对应表，其结构类似：
</p>
<pre class="example">
((("buffer" . #&lt;buffer  *Chinese-pyim*&gt;) ("file" . "/path/to/pyim-personal.txt"))
 (("buffer" . #&lt;buffer  *Chinese-pyim*-431862&gt;) ("file" . "/path/to/pyim-bigdict.txt"))
 (("buffer" . #&lt;buffer  *Chinese-pyim*-208698&gt;) ("file" . "/path/to/chinese-pyim-prettydict-2.txt"))
 (("buffer" . #&lt;buffer  *Chinese-pyim*-810662&gt;) ("file" . "/path/to/chinese-pyim-prettydict-1.txt")))
</pre></li>
<li>函数执行结束后，返回值为上述对应表。</li>
</ol>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-create-template-dict</span> (file)
  <span style="color: #61CE3C;">"&#29983;&#25104;&#27169;&#29256;&#35789;&#24211;&#12290;"</span>
  (<span style="color: #FBDE2D;">condition-case</span> error
      (<span style="color: #FBDE2D;">unless</span> (file-exists-p file)
        (<span style="color: #FBDE2D;">with-temp-buffer</span>
          (erase-buffer)
          (insert <span style="color: #61CE3C;">";; -*- coding: utf-8 -*-\n"</span>)
          (make-directory (file-name-directory file) t)
          (write-file (expand-file-name file))
          (message <span style="color: #61CE3C;">"&#33258;&#21160;&#21019;&#24314; Chinese-pyim &#25991;&#20214;: %s"</span> file)))
    (<span style="color: #ff69b4;">error</span>
     (<span style="color: #ff69b4;">warn</span> <span style="color: #61CE3C;">"`</span><span style="color: #61CE3C;">Chinese-pyim</span><span style="color: #61CE3C;">' &#27169;&#29256;&#35789;&#24211;&#21019;&#24314;&#22833;&#36133;&#65281;"</span> ))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-show-help</span> (string)
  <span style="color: #61CE3C;">"&#26174;&#31034; Chinese-pyim &#24110;&#21161;&#20449;&#24687;&#65292;&#35753;&#29992;&#25143;&#24555;&#36895;&#30340;&#20102;&#35299;&#22914;&#20309;&#23433;&#35013;&#35789;&#24211;&#12290;"</span>
  (<span style="color: #FBDE2D;">let</span> ((buffer-name <span style="color: #61CE3C;">"*Chinese-pyim-dict-help*"</span>))
    (<span style="color: #FBDE2D;">with-output-to-temp-buffer</span> buffer-name
      (set-buffer buffer-name)
      (<span style="color: #FBDE2D;">when</span> (<span style="color: #FBDE2D;">featurep</span> '<span style="color: #4c83ff;">org</span>)
        (org-mode))
      (<span style="color: #FBDE2D;">setq</span> truncate-lines 1)
      (insert string)
      (goto-char (point-min)))))

<span style="color: #8B8989; font-style: italic;">;;;  </span><span style="color: #8B8989; font-style: italic;">read file functions</span>
(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-load-file</span> ()
  <span style="color: #61CE3C;">"&#20026;&#27599;&#19968;&#20010;&#35789;&#24211;&#25991;&#20214;&#21019;&#24314;&#19968;&#20010;buffer(&#36825;&#20123;buffer&#29992;&#25143;&#19981;&#21487;&#35265;)&#65292;&#28982;&#21518;&#23558;&#21508;&#20010;&#35789;&#24211;&#25991;&#20214;&#30340;&#20869;&#23481;&#25554;&#20837;</span>
<span style="color: #61CE3C;">&#19982;&#20043;&#23545;&#24212;&#30340;buffer&#12290;&#26368;&#21518;&#36820;&#22238;&#19968;&#20010;&#21253;&#21547;&#25152;&#26377;buffer&#23545;&#35937;&#20197;&#21450;&#35789;&#24211;&#25991;&#20214;&#21517;&#30340;alist&#12290;</span>

<span style="color: #61CE3C;">`</span><span style="color: #61CE3C;">pyim-personal-file</span><span style="color: #61CE3C;">' &#25991;&#20214;&#26368;&#20808;&#23548;&#20837;&#12290;&#28982;&#21518;&#25353;&#29031;&#20808;&#21518;&#39034;&#24207;&#23548;&#20837; `</span><span style="color: #61CE3C;">pyim-dicts</span><span style="color: #61CE3C;">' &#20013;&#23450;&#20041;&#30340;&#35789;&#24211;</span>
<span style="color: #61CE3C;">&#25490;&#22312;&#26368;&#21069;&#38754;&#30340;&#35789;&#24211;&#39318;&#20808;&#34987;&#21152;&#36733;&#65292;&#30456;&#21516;&#30340;&#35789;&#24211;&#25991;&#20214;&#21482;&#21152;&#36733;&#19968;&#27425;&#12290;"</span>
  (<span style="color: #FBDE2D;">let</span> ((personal-file (expand-file-name pyim-personal-file))
        (dicts-list pyim-dicts)
        (bufname pyim-buffer-name)
        buflist buf file coding disable dict-type)
    (<span style="color: #FBDE2D;">save-excursion</span>
      (<span style="color: #FBDE2D;">unless</span> (file-exists-p personal-file)
        <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#22914;&#26524; `</span><span style="color: #8B8989; font-style: italic;">pyim-personal-file</span><span style="color: #8B8989; font-style: italic;">' &#23545;&#24212;&#30340;&#25991;&#20214;&#19981;&#23384;&#22312;&#65292;</span>
        <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#21019;&#24314;&#19968;&#20010;&#27169;&#29256;&#25991;&#20214;&#12290;</span>
        (pyim-create-template-dict personal-file))
      (<span style="color: #FBDE2D;">setq</span> buf (pyim-read-file personal-file bufname))
      (<span style="color: #FBDE2D;">setq</span> buflist (append buflist (list buf)))
      (<span style="color: #FBDE2D;">if</span> dicts-list
          (<span style="color: #FBDE2D;">dolist</span> (dict dicts-list)
            (<span style="color: #FBDE2D;">setq</span> file (expand-file-name (plist-get dict <span style="color: #FF6400;">:file</span>)))
            (<span style="color: #FBDE2D;">setq</span> coding (plist-get dict <span style="color: #FF6400;">:coding</span>))
            (<span style="color: #FBDE2D;">setq</span> disable (plist-get dict <span style="color: #FF6400;">:disable</span>))
            (<span style="color: #FBDE2D;">setq</span> dict-type (plist-get dict <span style="color: #FF6400;">:dict-type</span>))
            (<span style="color: #FBDE2D;">if</span> (<span style="color: #FBDE2D;">and</span> (not disable)
                     (file-exists-p file)
                     (not (pyim-file-load-p file buflist)))
                (<span style="color: #FBDE2D;">setq</span> buflist (append buflist (list (pyim-read-file file bufname coding dict-type))))
              (message <span style="color: #61CE3C;">"&#24573;&#30053;&#23548;&#20837;&#37325;&#22797;&#30340;&#35789;&#24211;&#25991;&#20214;&#65306;%s&#12290;"</span> file)))
        <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#24403;&#29992;&#25143;&#27809;&#26377;&#35774;&#32622;&#35789;&#24211;&#20449;&#24687;&#26102;&#65292;&#24377;&#20986;&#24110;&#21161;&#20449;&#24687;&#12290;</span>
        (<span style="color: #ff69b4;">warn</span> <span style="color: #61CE3C;">"Chinese-pyim &#27809;&#26377;&#23433;&#35013;&#35789;&#24211;&#65292;&#35831;&#36816;&#34892;&#35789;&#24211;&#31649;&#29702;&#21629;&#20196; `</span><span style="color: #61CE3C;">pyim-dicts-manager</span><span style="color: #61CE3C;">' &#26469;&#23433;&#35013;&#35789;&#24211;&#12290;"</span>)))
    buflist))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-file-load-p</span> (file buflist)
  <span style="color: #61CE3C;">"&#21028;&#26029; file &#26159;&#21542;&#24050;&#32463;&#21152;&#36733;"</span>
  (cl-some (<span style="color: #FBDE2D;">lambda</span> (x)
             (rassoc file x))
           buflist))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-read-file</span> (file name <span style="color: #D8FA3C;">&amp;optional</span> coding dict-type)
  (<span style="color: #FBDE2D;">with-current-buffer</span> (generate-new-buffer name)
    (<span style="color: #FBDE2D;">if</span> coding
        (<span style="color: #FBDE2D;">let</span> ((coding-system-for-read coding))
          (insert-file-contents file))
      (insert-file-contents file))
    `((<span style="color: #61CE3C;">"buffer"</span> . ,(current-buffer))
      (<span style="color: #61CE3C;">"file"</span> . ,file)
      (<span style="color: #61CE3C;">"dict-type"</span> . ,dict-type))))
</pre>
</div>

<p>
当使用 `pyim-start' 或者 `pyim-restart' 命令激活  Chinese-pyim 时，上述对应表保存到变量 `pyim-buffer-list'。供 Chinese-pyim 后续使用。
</p>

<p>
`pyim-buffer-list' 包含的第一个buffer，永远对应着个人词频文件，Chinese-pyim 使用 `pyim-save-personal-file'
将 `pyim-buffer-list' 第一个 buffer 的内容保存到个人词频文件，这个命令用于更新个人词频文件。
<a id="orgtarget1"></a>
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-save-personal-file</span> ()
  <span style="color: #61CE3C;">"&#19982; `</span><span style="color: #61CE3C;">pyim-personal-file</span><span style="color: #61CE3C;">' &#25991;&#20214;&#23545;&#24212;&#30340;buffer&#22312; `</span><span style="color: #61CE3C;">Chinese-pyim</span><span style="color: #61CE3C;">' &#20351;&#29992;&#26399;&#38388;&#19981;&#26029;&#26356;&#26032;&#12290;</span>
<span style="color: #61CE3C;">&#36825;&#20010;&#20989;&#25968;&#23558;&#26356;&#26032;&#21518;&#30340;&#20869;&#23481;&#20445;&#23384;&#21040;`</span><span style="color: #61CE3C;">pyim-personal-file</span><span style="color: #61CE3C;">' &#25991;&#20214;&#20013;&#65292;</span>

<span style="color: #61CE3C;">&#36825;&#20010;&#20989;&#25968;&#40664;&#35748;&#20316;&#20026;`</span><span style="color: #61CE3C;">kill-emacs-hook</span><span style="color: #61CE3C;">'&#20351;&#29992;&#12290;"</span>
  (<span style="color: #FBDE2D;">interactive</span>)
  (<span style="color: #FBDE2D;">let*</span> ((element (car pyim-buffer-list))
         (buffer (cdr (assoc <span style="color: #61CE3C;">"buffer"</span> element)))
         (file (cdr (assoc <span style="color: #61CE3C;">"file"</span> element))))
    (<span style="color: #FBDE2D;">when</span> (buffer-live-p buffer)
      (<span style="color: #FBDE2D;">with-current-buffer</span> buffer
        (<span style="color: #FBDE2D;">save-restriction</span>
          (<span style="color: #FBDE2D;">if</span> (file-exists-p file)
              (<span style="color: #FBDE2D;">progn</span> (write-region (point-min) (point-max) file)
                     (message <span style="color: #61CE3C;">"&#26356;&#26032; Chinese-pyim &#25991;&#20214;&#65306;%s&#12290;"</span> file))
            (message <span style="color: #61CE3C;">"Chinese-pyim &#25991;&#20214;&#65306;%s &#19981;&#23384;&#22312;&#12290;"</span> file)))))))
</pre>
</div>

<p>
`pyim-check-buffers' 函数会检查 `pyim-buffer-list' 中的所有 buffer 是否存在，如果某个 buffer 不存在，这个函数会重新创建一个buffer，并插入对应词库文件的内容，如果对应词库文件也不存在，那么这个函数会删除这条记录。
</p>

<p>
而 `pyim-kill-buffers' 会删除 `pyim-buffer-list' 中所有的 buffer。这个函数用于重新启动输入法前的清理工作。
<a id="orgtarget2"></a>
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-check-buffers</span> ()
  <span style="color: #61CE3C;">"&#26816;&#26597;&#25152;&#26377;&#30340; buffer &#26159;&#21542;&#36824;&#23384;&#22312;&#65292;&#22914;&#26524;&#19981;&#23384;&#22312;&#65292;&#37325;&#26032;&#25171;&#24320;&#25991;&#20214;&#65292;&#22914;&#26524;&#25991;&#20214;&#19981;</span>
<span style="color: #61CE3C;">&#23384;&#22312;&#65292;&#20174; buffer-list &#20013;&#21024;&#38500;&#36825;&#20010; buffer"</span>
  (<span style="color: #FBDE2D;">let</span> ((buflist pyim-buffer-list)
        (bufname pyim-buffer-name)
        buffer file)
    (<span style="color: #FBDE2D;">dolist</span> (buf buflist)
      (<span style="color: #FBDE2D;">setq</span> buffer (assoc <span style="color: #61CE3C;">"buffer"</span> buf))
      (<span style="color: #FBDE2D;">setq</span> file (cdr (assoc <span style="color: #61CE3C;">"file"</span> buf)))
      (<span style="color: #FBDE2D;">unless</span> (buffer-live-p (cdr buffer))
        (<span style="color: #FBDE2D;">if</span> (file-exists-p file)
            (<span style="color: #FBDE2D;">with-current-buffer</span> (generate-new-buffer bufname)
              (insert-file-contents file)
              (setcdr buffer (current-buffer)))
          (message <span style="color: #61CE3C;">"%s for %s is not exists!"</span> file bufname)
          (<span style="color: #FBDE2D;">setq</span> buflist (remove buf buflist)))))
    t))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-kill-buffers</span> ()
  <span style="color: #61CE3C;">"&#21024;&#38500;&#25152;&#26377;&#35789;&#24211;&#25991;&#20214;&#23545;&#24212;&#30340; buffer &#65292;&#29992;&#20110;&#37325;&#21551; Chinese-pyim &#12290;"</span>
  (<span style="color: #FBDE2D;">let</span> ((buflist pyim-buffer-list)
        buffer)
    (<span style="color: #FBDE2D;">dolist</span> (buf buflist)
      (<span style="color: #FBDE2D;">setq</span> buffer (cdr (assoc <span style="color: #61CE3C;">"buffer"</span> buf)))
      (<span style="color: #FBDE2D;">when</span> (buffer-live-p buffer)
        (kill-buffer buffer)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline10" class="outline-4">
<h4 id="orgheadline10"><span class="section-number-4">2.4.3</span> 从词库中搜索中文词条</h4>
<div class="outline-text-4" id="text-2-4-3">
<p>
当个人词频文件以及普通词库文件加载完成后， Chinese-pyim 就可以搜索某个拼音字符串对应的中文词条了，这个工作由函数 `pyim-get' 完成，其基本原理是：递归的搜索 `pyim-buffer-list' 中所有的 buffer，将得到的搜索结果汇总成一个列表，去除重复元素后返回。
</p>

<p>
在搜索 buffer 之前，Chinese-pyim 会使用函数 `pyim-dict-buffer-valid-p'
大致的判断当前 buffer 是否是一个有效的词库 buffer，判断标准为：
</p>

<ol class="org-ol">
<li>buffer 必须多于5行。</li>
<li>buffer 中间一行必须包含空格或者TAB。</li>
<li>buffer 中间一行必须包含中文字符(\\cc)。</li>
</ol>

<p>
由于 chinese-pyim 文本词库没有包含 meta 信息，所以这个函数只能粗略的做出判断，另外这个函数使用 `count-lines' 计算行数，我限定其参数 END 不超过 20000, 这样可以优化性能，防止输入法卡顿。
</p>

<p>
BUG: 这个函数需要进一步优化，使其判断更准确。
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-get</span> (code <span style="color: #D8FA3C;">&amp;optional</span> search-from-guessdict ignore-personal-buffer)
  (<span style="color: #FBDE2D;">let</span> ((persional-file-buffer (car pyim-buffer-list))
        (other-buffer-list (cdr pyim-buffer-list))
        (search-dicts-buffer-p t) <span style="color: #8B8989; font-style: italic;">;</span><span style="color: #8B8989; font-style: italic;">&#29992;&#26469;&#20915;&#23450;&#26159;&#21542;&#38656;&#35201;&#25628;&#32034;&#35789;&#24211; buffer</span>
        words nearby-codes-positions buffer-list)
    (<span style="color: #FBDE2D;">when</span> (<span style="color: #FBDE2D;">and</span> (stringp code) (string&lt; <span style="color: #61CE3C;">""</span> code))
      (<span style="color: #FBDE2D;">when</span> pyim-buffer-cache-list
        <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#30452;&#25509;&#20174; buffer cache &#20013;&#26597;&#35810;&#35789;&#26465;&#65292;&#36895;&#24230;&#24456;&#24555;&#12290;</span>
        (<span style="color: #FBDE2D;">dolist</span> (buf-cache pyim-buffer-cache-list)
          (<span style="color: #FBDE2D;">setq</span> words
                (append words
                        (car (gethash code
                                      (cdr (assoc <span style="color: #61CE3C;">"buffer-cache"</span> buf-cache)))))))

        <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#22914;&#26524;&#29992;&#25143;&#23558;&#25152;&#26377;&#30340;&#20010;&#20154;&#35789;&#24211;&#37117;&#32531;&#23384;&#20102;&#65292;&#21363;&#20351;&#25214;&#19981;&#21040;&#35789;&#26465;&#65292;</span>
        <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#20063;&#27809;&#26377;&#24517;&#35201;&#32487;&#32493;&#25628;&#32034;&#35789;&#24211; buffer &#20102;&#12290;</span>
        (<span style="color: #FBDE2D;">when</span> (eq (cdr (assoc <span style="color: #61CE3C;">"buffer-cache-mode"</span>
                              (car pyim-buffer-cache-list))) <span style="color: #ff69b4;">'full)</span>
          (<span style="color: #FBDE2D;">setq</span> search-dicts-buffer-p nil))

        <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#22914;&#26524;&#20174;&#32531;&#23384;&#20013;&#25214;&#19981;&#21040; code &#23545;&#24212;&#30340;&#35789;&#26465;&#65292;&#21017;&#33719;&#21462; code &#25152;&#22312;&#30340;&#33539;&#22260;&#65292;</span>
        <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#27604;&#22914;&#65306; &#22914;&#26524;&#25628;&#32034; ni-hao, &#37027;&#20040;&#65292;&#25628;&#32034; n &#21644; o &#20004;&#20010; code &#22312; buffer</span>
        <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#20013;&#30340;&#20301;&#32622;&#65292;&#36825;&#20004;&#20010; code &#30340;&#20301;&#32622;&#21487;&#20197;&#20943;&#23569;&#21518;&#38754;&#25628;&#32034;&#35789;&#24211; buffer &#33457;&#36153;&#30340;&#26102;&#38388;&#12290;</span>
        (<span style="color: #FBDE2D;">when</span> search-dicts-buffer-p
          (<span style="color: #FBDE2D;">dolist</span> (buf-cache pyim-buffer-cache-list)
            (<span style="color: #FBDE2D;">unless</span> words
              (<span style="color: #FBDE2D;">let*</span> ((begin (string-to-char (substring code 0 1)))
                     (end (1+ begin))
                     (words-ht  (cdr (assoc <span style="color: #61CE3C;">"buffer-cache"</span> buf-cache))))
                (<span style="color: #FBDE2D;">push</span> `(,(cdr (assoc <span style="color: #61CE3C;">"buffer"</span> buf-cache))
                        ,(cadr (gethash (string begin) words-ht))
                        ,(cadr (gethash (string end) words-ht)))
                      nearby-codes-positions))))))

      <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#30452;&#25509;&#29992;&#20108;&#20998;&#27861;&#25628;&#32034; *&#26222;&#36890;&#35789;&#24211;* buffer&#65288;&#36895;&#24230;&#27604;&#36739;&#24930;&#65289;&#12290;</span>
      (<span style="color: #FBDE2D;">when</span> (<span style="color: #FBDE2D;">and</span> (not words) search-dicts-buffer-p)
        (<span style="color: #FBDE2D;">dolist</span> (buf other-buffer-list)
          (<span style="color: #FBDE2D;">let</span> ((dict-type (cdr (assoc <span style="color: #61CE3C;">"dict-type"</span> buf))))
            <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">Search from dict</span>
            (<span style="color: #FBDE2D;">when</span> (<span style="color: #FBDE2D;">and</span> (not search-from-guessdict)
                       (<span style="color: #FBDE2D;">or</span> (null dict-type)
                           (eq dict-type 'pinyin-dict)))
              (<span style="color: #FBDE2D;">push</span> buf buffer-list))
            <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">Search from guessdict</span>
            (<span style="color: #FBDE2D;">when</span> (<span style="color: #FBDE2D;">and</span> search-from-guessdict
                       (eq dict-type 'guess-dict))
              (<span style="color: #FBDE2D;">push</span> buf buffer-list))))
        (<span style="color: #FBDE2D;">setq</span> buffer-list (reverse buffer-list))
        (<span style="color: #FBDE2D;">dolist</span> (buf buffer-list)
          (<span style="color: #FBDE2D;">let*</span> ((buffer (cdr (assoc <span style="color: #61CE3C;">"buffer"</span> buf)))
                 (positions (cdr (assoc buffer nearby-codes-positions)))
                 (point1 (car positions)) <span style="color: #8B8989; font-style: italic;">;</span><span style="color: #8B8989; font-style: italic;">&#20174;&#32531;&#23384;&#20013;&#33719;&#21462;&#30340;&#19978;&#30028;&#38480;</span>
                 (point2 (cadr positions))) <span style="color: #8B8989; font-style: italic;">;</span><span style="color: #8B8989; font-style: italic;">&#20174;&#32531;&#23384;&#20013;&#33719;&#21462;&#30340;&#19979;&#30028;&#38480;</span>
            (<span style="color: #FBDE2D;">with-current-buffer</span> buffer
              (<span style="color: #FBDE2D;">if</span> (pyim-dict-buffer-valid-p)
                  (<span style="color: #FBDE2D;">setq</span> words (append words
                                      (cdr
                                       (pyim-bisearch-word code
                                                           (<span style="color: #FBDE2D;">or</span> point1 (point-min))
                                                           (<span style="color: #FBDE2D;">or</span> point2 (point-max))))))
                (message <span style="color: #61CE3C;">"%s &#21487;&#33021;&#19981;&#26159;&#19968;&#20010;&#26377;&#25928;&#30340;&#35789;&#24211; buffer&#65292;&#24573;&#30053;&#12290;"</span> (buffer-name)))))))

      (<span style="color: #FBDE2D;">when</span> (not (<span style="color: #FBDE2D;">or</span> search-from-guessdict
                     ignore-personal-buffer))
        <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#35774;&#32622; `</span><span style="color: #8B8989; font-style: italic;">ignore-personal-buffer</span><span style="color: #8B8989; font-style: italic;">' &#20026; t &#26102;&#65292;&#29992;&#20110;&#22810;&#38899;&#23383;&#26657;&#27491;&#12290;</span>
        <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">pyim-buffer-list &#20013;&#31532;&#19968;&#20010; buffer &#23545;&#24212;&#30340;&#26159;&#20010;&#20154;&#35789;&#24211;&#25991;&#20214;</span>
        <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#20010;&#20154;&#35789;&#24211;&#25991;&#20214;&#20013;&#30340;&#35789;&#26465;&#26497;&#26377;&#21487;&#33021;&#23384;&#22312; *&#22810;&#38899;&#23383;&#27745;&#26579;*&#12290;</span>
        <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#19981;&#36866;&#21512;&#29992;&#20110;&#22810;&#38899;&#23383;&#26657;&#27491;&#65292;&#36825;&#26159;&#30001; Chinese-pyim &#20445;&#23384;&#35789;&#26465;&#30340;</span>
        <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#26426;&#21046;&#20915;&#23450;&#30340;&#12290;</span>
        (<span style="color: #FBDE2D;">with-current-buffer</span> (cdr (assoc <span style="color: #61CE3C;">"buffer"</span> persional-file-buffer))
          (<span style="color: #FBDE2D;">if</span> (pyim-dict-buffer-valid-p)
              (<span style="color: #FBDE2D;">setq</span> words (append (cdr
                                   (pyim-bisearch-word code
                                                       (point-min)
                                                       (point-max)))
                                  words))
            (message <span style="color: #61CE3C;">"&#20010;&#20154;&#35789;&#24211;&#25991;&#20214; buffer &#23384;&#22312;&#38382;&#39064;&#65292;&#24573;&#30053;&#21152;&#36733;&#65281;"</span>))))
      (delete-dups words))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-get-codes-in-personal-buffer</span> ()
  (<span style="color: #FBDE2D;">let</span> ((buffer (cdr (assoc <span style="color: #61CE3C;">"buffer"</span> (car pyim-buffer-list))))
        result)
    (<span style="color: #FBDE2D;">with-current-buffer</span> buffer
      (goto-char (point-min))
      (<span style="color: #FBDE2D;">while</span> (not (eobp))
        (<span style="color: #FBDE2D;">push</span> (pyim-code-at-point) result)
        (forward-line 1)))
    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#21152;&#20837;26&#20010;&#23383;&#27597;code&#65292;&#29992;&#20110;&#32553;&#23567;&#25628;&#32034;&#33539;&#22260;&#12290;</span>
    (<span style="color: #FBDE2D;">setq</span> result
          (append (mapcar
                   #'(lambda (x)
                       (string x))
                   <span style="color: #61CE3C;">"abcdefghjklmnopqrstwxyz"</span>)
                  result))
    (cl-delete-duplicates (nreverse result)
                          <span style="color: #FF6400;">:test</span> #'string= <span style="color: #FF6400;">:from-end</span> t)))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-cache-dict-buffer</span> ()
  <span style="color: #61CE3C;">"&#26681;&#25454;&#20010;&#20154;&#35789;&#24211;&#25991;&#20214;&#20013;&#30340; codes&#65292;&#26469;&#26500;&#24314;&#26222;&#36890;&#35789;&#24211;&#25991;&#20214;&#30340;&#32531;&#23384;&#65292;&#29992;&#20110;&#21152;&#24555;&#26597;&#35810;&#36895;&#24230;&#65292;</span>
<span style="color: #61CE3C;">&#20027;&#35201;&#29992;&#20110;&#23545;&#35775;&#38382;&#36895;&#24230;&#35201;&#27714;&#39640;&#30340;&#20013;&#25991;&#23383;&#31526;&#20018;&#20998;&#35789;&#21151;&#33021;&#12290;"</span>
  (<span style="color: #FBDE2D;">interactive</span>)
  (<span style="color: #FBDE2D;">let</span> ((cache-all-codes (yes-or-no-p <span style="color: #61CE3C;">"&#35831;&#36873;&#25321;&#32531;&#23384;&#27169;&#24335;&#65306;[Yes] &#32531;&#23384;&#25152;&#26377;&#30340;&#35789;&#26465;; [No] &#32531;&#23384;&#24120;&#29992;&#30340;&#35789;&#26465;;  "</span>))
        (max-word-length (read-number <span style="color: #61CE3C;">"&#32531;&#23384;&#35789;&#26465;&#30340;&#26368;&#22823;&#38271;&#24230;&#20026;&#65306; "</span>)))
    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#22914;&#26524; Chinese-pyim &#35789;&#24211;&#27809;&#26377;&#21152;&#36733;&#65292;&#21152;&#36733; Chinese-pyim &#35789;&#24211;&#65292;</span>
    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#30830;&#20445; pyim-get &#21487;&#20197;&#27491;&#24120;&#36816;&#34892;&#12290;</span>
    (<span style="color: #FBDE2D;">unless</span> pyim-buffer-list
      (<span style="color: #FBDE2D;">setq</span> pyim-buffer-list (pyim-load-file)))
    (message <span style="color: #61CE3C;">"&#27491;&#22312;&#32531;&#23384;&#35789;&#24211;&#65292;&#35831;&#31245;&#31561;&#12290;&#12290;&#12290;"</span>)
    (pyim-cache-dict-buffer-internal cache-all-codes max-word-length)
    (message <span style="color: #61CE3C;">"&#35789;&#24211;&#32531;&#23384;&#23436;&#25104;&#65281;"</span>)))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-cache-dict-buffer-internal</span> (<span style="color: #D8FA3C;">&amp;optional</span> cache-all-codes max-word-length)
  <span style="color: #61CE3C;">"&#26500;&#24314;&#26222;&#36890;&#35789;&#24211;&#25991;&#20214;&#30340;&#32531;&#23384;&#65292;&#29992;&#20110;&#21152;&#24555;&#26597;&#35810;&#36895;&#24230;&#65292;&#20027;&#35201;&#29992;&#20110;&#23545;&#35775;&#38382;&#36895;&#24230;&#35201;&#27714;&#39640;&#30340;&#20013;&#25991;&#23383;&#31526;&#20018;&#20998;&#35789;&#21151;&#33021;&#12290;</span>
<span style="color: #61CE3C;">&#24403; `</span><span style="color: #61CE3C;">cache-all-codes</span><span style="color: #61CE3C;">' &#35774;&#32622;&#20026; t &#26102;&#65292;&#32531;&#23384;&#26222;&#36890;&#35789;&#24211; buffer &#20013;&#23384;&#22312;&#30340;&#25152;&#26377;&#35789;&#26465;&#65292;&#22914;&#26524;&#35774;&#32622;&#20026; nil&#65292; &#20165;&#20165;</span>
<span style="color: #61CE3C;">&#32531;&#23384;&#24120;&#29992;&#30340; codes &#23545;&#24212;&#30340;&#35789;&#26465;&#65292;&#24120;&#29992; codes &#20174;&#20010;&#20154;&#25991;&#20214;&#20013;&#25552;&#21462;&#65292;&#20855;&#20307;&#35831;&#21442;&#32771;&#65306;`</span><span style="color: #61CE3C;">pyim-get-codes-in-personal-buffer</span><span style="color: #61CE3C;">'</span>
<span style="color: #61CE3C;">`</span><span style="color: #61CE3C;">max-word-length</span><span style="color: #61CE3C;">' &#29992;&#26469;&#35774;&#32622;&#32531;&#23384;&#35789;&#26465;&#30340;&#26368;&#22823;&#38271;&#24230;&#12290;"</span>
  (<span style="color: #FBDE2D;">interactive</span>)
  (<span style="color: #FBDE2D;">let</span> ((all-buffer-list pyim-buffer-list)
        (codes-used-freq (pyim-get-codes-in-personal-buffer))
        buffer-cache-mode result)
    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#28165;&#31354;&#21407;&#26469;&#30340;&#32531;&#23384;&#12290;</span>
    (<span style="color: #FBDE2D;">setq</span> pyim-buffer-cache-list nil)
    (<span style="color: #FBDE2D;">dolist</span> (buf all-buffer-list)
      <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#36825;&#37324;&#20165;&#20165; cache &#26222;&#36890;&#35789;&#24211; buffer&#65292;&#24573;&#30053; cache &#20010;&#20154;&#35789;&#24211;&#25991;&#20214; buffer &#21644;</span>
      <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">guessdict &#35789;&#24211; buffer&#12290;&#20854;&#20027;&#35201;&#21407;&#22240;&#26159;&#65306;</span>
      <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">1. &#20010;&#20154;&#35789;&#24211;&#39057;&#32321;&#21464;&#21160;&#65292;cache &#24456;&#24555;&#20250;&#36807;&#26399;</span>
      <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">2. guessdict &#35789;&#24211;&#30340;&#26597;&#35810;&#36895;&#24230;&#22522;&#26412;&#21487;&#20197;&#28385;&#36275;&#36755;&#20837;&#27861;&#30340;&#35201;&#27714;&#65292;</span>
      <span style="color: #8B8989; font-style: italic;">;;    </span><span style="color: #8B8989; font-style: italic;">&#19981;&#38656;&#35201; cache&#12290;</span>
      <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">3. &#24403;&#23545;&#20013;&#25991;&#23383;&#31526;&#20018;&#20998;&#35789;&#26102;&#65292;&#35201;&#27714;&#26497;&#20854;&#24555;&#36895;&#30340;&#26597;&#35810;&#20010;&#20154;&#35789;&#24211;,</span>
      <span style="color: #8B8989; font-style: italic;">;;    </span><span style="color: #8B8989; font-style: italic;">&#20351;&#29992;&#32531;&#23384;&#21487;&#20197;&#26497;&#22823;&#30340;&#25552;&#39640;&#20998;&#35789;&#36895;&#24230;&#12290;</span>
      (<span style="color: #FBDE2D;">let</span> ((dict-type (cdr (assoc <span style="color: #61CE3C;">"dict-type"</span> buf)))
            (buffer (cdr (assoc <span style="color: #61CE3C;">"buffer"</span> buf))))
        (<span style="color: #FBDE2D;">when</span> (<span style="color: #FBDE2D;">or</span> (null dict-type)
                  (eq dict-type 'pinyin-dict))
          (<span style="color: #FBDE2D;">with-current-buffer</span> buffer
            (goto-char (point-min))
            (<span style="color: #FBDE2D;">let</span> ((index-table (make-hash-table <span style="color: #FF6400;">:size</span> 50000 <span style="color: #FF6400;">:test</span> #'equal)))
              (<span style="color: #FBDE2D;">when</span> (pyim-dict-buffer-valid-p)
                (<span style="color: #FBDE2D;">if</span> cache-all-codes
                    (<span style="color: #FBDE2D;">progn</span>
                      (<span style="color: #FBDE2D;">while</span> (not (eobp))
                        (<span style="color: #FBDE2D;">let*</span> ((code (pyim-code-at-point))
                               (code-length (length (split-string code <span style="color: #61CE3C;">"-"</span>)))
                               (words (cdr (pyim-line-content))))
                          (<span style="color: #FBDE2D;">when</span> (&lt;= code-length (<span style="color: #FBDE2D;">or</span> max-word-length 6))
                            (puthash code
                                     (list words)
                                     index-table)))
                        (forward-line 1))
                      (<span style="color: #FBDE2D;">setq</span> buffer-cache-mode 'full))
                  (<span style="color: #FBDE2D;">dolist</span> (code codes-used-freq)
                    (puthash code
                             (list (cdr (pyim-bisearch-word code
                                                            (point-min)
                                                            (point-max)))
                                   (point))
                             index-table))
                  (<span style="color: #FBDE2D;">setq</span> buffer-cache-mode 'partly))
                (<span style="color: #FBDE2D;">push</span> `((<span style="color: #61CE3C;">"buffer"</span> . ,buffer)
                        (<span style="color: #61CE3C;">"buffer-cache"</span> . ,index-table)
                        (<span style="color: #61CE3C;">"buffer-cache-mode"</span> . ,buffer-cache-mode))
                      pyim-buffer-cache-list)))))))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-predict</span> (code <span style="color: #D8FA3C;">&amp;optional</span> search-from-guessdict)
  <span style="color: #61CE3C;">"&#24471;&#21040; `</span><span style="color: #61CE3C;">code</span><span style="color: #61CE3C;">' &#23545;&#24212;&#30340;&#32852;&#24819;&#35789;&#12290;"</span>
  (<span style="color: #FBDE2D;">let</span> ((regexp (pyim-predict-build-regexp code))
        buffer-list words-list predicted-words)
    (<span style="color: #FBDE2D;">dolist</span> (buf pyim-buffer-list)
      (<span style="color: #FBDE2D;">let</span> ((dict-type (cdr (assoc <span style="color: #61CE3C;">"dict-type"</span> buf))))
        (<span style="color: #FBDE2D;">when</span> (<span style="color: #FBDE2D;">and</span> (not search-from-guessdict)
                   (<span style="color: #FBDE2D;">or</span> (null dict-type)
                       (eq dict-type 'pinyin-dict)))
          (<span style="color: #FBDE2D;">push</span> buf buffer-list))
        (<span style="color: #FBDE2D;">when</span> (<span style="color: #FBDE2D;">and</span> search-from-guessdict
                   (eq dict-type 'guess-dict))
          (<span style="color: #FBDE2D;">push</span> buf buffer-list))))
    (<span style="color: #FBDE2D;">setq</span> buffer-list (reverse buffer-list))
    (<span style="color: #FBDE2D;">when</span> (<span style="color: #FBDE2D;">and</span> (stringp code)
               (string&lt; <span style="color: #61CE3C;">""</span> code)
               (string-match-p <span style="color: #61CE3C;">"[a-z]+-[a-z]+"</span> code))
      (<span style="color: #FBDE2D;">dolist</span> (buf buffer-list)
        (<span style="color: #FBDE2D;">with-current-buffer</span> (cdr (assoc <span style="color: #61CE3C;">"buffer"</span> buf))
          (<span style="color: #FBDE2D;">when</span> (pyim-dict-buffer-valid-p)
            (pyim-bisearch-word code (point-min) (point-max))
            (<span style="color: #FBDE2D;">let*</span> ((begin (<span style="color: #FBDE2D;">when</span> (re-search-forward regexp nil t)
                            (beginning-of-line)
                            (point)))
                   <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#25552;&#21462;20&#34892;&#20869;&#23481;&#26469;&#33719;&#21462;&#20998;&#26512;&#32852;&#24819;&#35789;&#65292;&#22826;&#22810;&#30340;&#32852;&#24819;&#35789;</span>
                   <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#29992;&#22788;&#19981;&#22823;&#65292;&#36824;&#20250;&#20351;&#36755;&#20837;&#27861;&#21709;&#24212;&#36895;&#24230;&#20943;&#24930;(&#32463;&#39564;&#25968;&#23383;)&#12290;</span>
                   (end (<span style="color: #FBDE2D;">progn</span> (forward-line 20)
                               (end-of-line)
                               (point))))
              (<span style="color: #FBDE2D;">when</span> begin
                (<span style="color: #FBDE2D;">setq</span> words-list
                      (append words-list
                              (pyim-multiline-content begin end))))))))
      (<span style="color: #FBDE2D;">dolist</span> (line-words words-list)
        (<span style="color: #FBDE2D;">when</span> (string-match-p regexp (car line-words))
          (<span style="color: #FBDE2D;">let</span> ((line-words (cdr line-words)))
            (<span style="color: #FBDE2D;">dolist</span> (word line-words)
              (<span style="color: #FBDE2D;">when</span> (<span style="color: #FBDE2D;">and</span> (stringp word)
                         (&gt; (length word) 0))
                (<span style="color: #FBDE2D;">push</span> word predicted-words))))))
      (delete-dups (reverse predicted-words)))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-predict-build-regexp</span> (code)
  <span style="color: #61CE3C;">"&#20174;`</span><span style="color: #61CE3C;">code</span><span style="color: #61CE3C;">' &#26500;&#24314;&#19968;&#20010; regexp&#65292;&#29992;&#20110;&#25628;&#32034;&#32852;&#24819;&#35789;&#65292;</span>
<span style="color: #61CE3C;">&#27604;&#22914;&#65306;ni-hao-si-j --&gt; ^ni-hao[a-z]*-si[a-z]*-j[a-z]*"</span>
  (<span style="color: #FBDE2D;">let</span> ((count 0))
    (concat <span style="color: #61CE3C;">"^"</span>
            (mapconcat
             #'(lambda (x)
                 (<span style="color: #FBDE2D;">setq</span> count (+ count 1))
                 (<span style="color: #FBDE2D;">if</span> (&gt; count 1)
                     (concat x <span style="color: #61CE3C;">"[a-z]*"</span>)
                   x))
             (split-string code <span style="color: #61CE3C;">"-"</span>) <span style="color: #61CE3C;">"-"</span>))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-dict-buffer-valid-p</span> ()
  <span style="color: #61CE3C;">"&#31895;&#30053;&#22320;&#30830;&#23450;&#24403;&#21069; buffer &#26159;&#21542;&#26159;&#19968;&#20010;&#26377;&#25928;&#30340;&#35789;&#24211;&#20135;&#29983;&#30340; buffer&#12290;</span>
<span style="color: #61CE3C;">&#30830;&#23450;&#26631;&#20934;&#65306;</span>

<span style="color: #61CE3C;">1. buffer &#24517;&#39035;&#22810;&#20110;5&#34892;&#12290;</span>
<span style="color: #61CE3C;">2. buffer &#20013;&#38388;&#19968;&#34892;&#24517;&#39035;&#21253;&#21547;&#31354;&#26684;&#25110;&#32773;TAB&#12290;</span>
<span style="color: #61CE3C;">2. buffer &#20013;&#38388;&#19968;&#34892;&#24517;&#39035;&#21253;&#21547;&#20013;&#25991;&#23383;&#31526;(\\cc)&#12290;</span>

<span style="color: #61CE3C;">BUG: &#36825;&#20010;&#20989;&#25968;&#38656;&#35201;&#36827;&#19968;&#27493;&#20248;&#21270;&#65292;&#20351;&#20854;&#21028;&#26029;&#26356;&#20934;&#30830;&#12290;"</span>
  (<span style="color: #FBDE2D;">when</span> (&gt; (count-lines (point-min)
                        (min 20000 (point-max))) <span style="color: #ff69b4;">5)</span>
    (<span style="color: #FBDE2D;">save-excursion</span>
      (<span style="color: #FBDE2D;">let</span> ((mid (/ (+ (point-min) (point-max)) 2))
            ccode)
        (goto-char mid)
        (beginning-of-line)
        (<span style="color: #FBDE2D;">and</span> (re-search-forward <span style="color: #61CE3C;">"[ \t]"</span> (line-end-position) t)
             (re-search-forward <span style="color: #61CE3C;">"\\cc"</span> (line-end-position) t))))))
</pre>
</div>

<p>
`pyim-buffer-list' 中每一个 buffer 都使用函数：`pyim-bisearch-word' 来搜索，其具体方式是：
</p>

<ol class="org-ol">
<li>获取 buffer 的 max-point 和 min-point</li>
<li>将光标移动到上述两个值的中间。</li>
<li>使用 `pyim-code-at-point' 获取当前行的拼音字符串。</li>
<li>比较上述拼音字符串和待搜索的字符串，来决定搜索 buffer 的上半部份还是下半部份。</li>
<li>这样递归的操作，最终会将光标移动到 buffer 的某一行，这一行中的拼音字符串和待搜索的拼音字符串一致。</li>
<li><p>
最后使用 `pyim-line-content' 返回当前行的内容，其结果是一个列表，类似：
</p>
<pre class="example">
("ni-hao" "你好" "你号" ...)
</pre></li>
</ol>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-bisearch-word</span> (code start end)
  (<span style="color: #FBDE2D;">let</span> ((mid (/ (+ start end) 2))
        ccode)
    (goto-char mid)
    (beginning-of-line)
    (<span style="color: #FBDE2D;">setq</span> ccode (pyim-code-at-point))
    <span style="color: #8B8989; font-style: italic;">;;    </span><span style="color: #8B8989; font-style: italic;">(message "%d, %d, %d: %s" start mid end ccode)</span>
    (<span style="color: #FBDE2D;">if</span> (string= ccode code)
        (pyim-line-content)
      (<span style="color: #FBDE2D;">if</span> (&gt; mid start)
          (<span style="color: #FBDE2D;">if</span> (string&lt; ccode code)
              (pyim-bisearch-word code mid end)
            (pyim-bisearch-word code start mid))))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-code-at-point</span> ()
  <span style="color: #61CE3C;">"Before calling this function, be sure that the point is at the</span>
<span style="color: #61CE3C;">beginning of line"</span>
  (<span style="color: #FBDE2D;">save-excursion</span>
    (<span style="color: #FBDE2D;">if</span> (re-search-forward <span style="color: #61CE3C;">"[ \t]"</span> (line-end-position) t)
        (buffer-substring-no-properties (line-beginning-position) (1- (point)))
      (<span style="color: #ff69b4;">error</span> <span style="color: #61CE3C;">"&#25991;&#20214;&#31867;&#22411;&#38169;&#35823;&#65281;%s &#30340;&#31532; %d &#34892;&#27809;&#26377;&#35789;&#26465;&#65281;"</span> (buffer-name) (line-number-at-pos)))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-line-content</span> (<span style="color: #D8FA3C;">&amp;optional</span> seperaters omit-nulls)
  <span style="color: #61CE3C;">"&#29992; SEPERATERS &#20998;&#35299;&#24403;&#21069;&#34892;&#65292;&#25152;&#26377;&#21442;&#25968;&#20256;&#36882;&#32473; split-string &#20989;&#25968;"</span>
  (<span style="color: #FBDE2D;">let</span> ((items   (split-string
                  (buffer-substring-no-properties
                   (line-beginning-position)
                   (line-end-position)) <span style="color: #ff69b4;">seperaters)))</span>
    (<span style="color: #FBDE2D;">if</span> omit-nulls
        (cl-delete-if 'pyim-string-emptyp items)
      items)))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-multiline-content</span> (begin end <span style="color: #D8FA3C;">&amp;optional</span> seperaters omit-nulls)
  <span style="color: #61CE3C;">"&#23558;&#24403;&#21069; buffer &#20013;&#65292;`</span><span style="color: #61CE3C;">begin</span><span style="color: #61CE3C;">' &#21040; `</span><span style="color: #61CE3C;">end</span><span style="color: #61CE3C;">' &#20043;&#38388;&#30340;&#20869;&#23481;&#20998;&#35299;&#65292;&#29983;&#25104;&#19968;&#20010; list&#65292;</span>
<span style="color: #61CE3C;">&#36825;&#20010;&#20989;&#25968;&#29992;&#20110;&#25628;&#32034;&#32852;&#24819;&#35789;&#20989;&#25968; `</span><span style="color: #61CE3C;">pyim-predict</span><span style="color: #61CE3C;">' &#12290;"</span>
  <span style="color: #8B8989; font-style: italic;">;;  </span><span style="color: #8B8989; font-style: italic;">ni-hao &#20320;&#22909; &#20522;&#28009;         (("ni-hao" "&#20320;&#22909;" "&#20522;&#28009;")</span>
  <span style="color: #8B8989; font-style: italic;">;;  </span><span style="color: #8B8989; font-style: italic;">ni-hao-a &#20320;&#22909;&#21834;    --&gt;    ("ni-hao-a" "&#20320;&#22909;&#21834;")</span>
  <span style="color: #8B8989; font-style: italic;">;;  </span><span style="color: #8B8989; font-style: italic;">ni-hao-b &#20320;&#22909;&#21543;           ("ni-hao-ba" "&#20320;&#22909;&#21543;"))</span>
  (<span style="color: #FBDE2D;">let</span> ((items (split-string
                (buffer-substring-no-properties
                 (<span style="color: #FBDE2D;">if</span> (&gt; begin (point-min))
                     begin
                   (point-min))
                 (<span style="color: #FBDE2D;">if</span> (&lt; end (point-max))
                     end
                   (point-max))) <span style="color: #61CE3C;">"\n"</span>)))
    (mapcar
     #'(lambda (x)
         (<span style="color: #FBDE2D;">let</span> ((line-items (split-string x (<span style="color: #FBDE2D;">or</span> seperaters <span style="color: #61CE3C;">" "</span>))))
           (<span style="color: #FBDE2D;">if</span> omit-nulls
               (cl-delete-if 'pyim-string-emptyp line-items)
             line-items)))
     items)))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-string-emptyp</span> (str)
  (not (string&lt; <span style="color: #61CE3C;">""</span> str)))
</pre>
</div>

<p>
`pyim-bisearch-word' 是 Chinese-pyim 搜索词条的最基本最核心的函数，只要涉及到搜索词条，必须调用这个函数。
</p>
</div>
</div>

<div id="outline-container-orgheadline13" class="outline-4">
<h4 id="orgheadline13"><span class="section-number-4">2.4.4</span> 保存词条，删除词条以及调整词条位置</h4>
<div class="outline-text-4" id="text-2-4-4">
<p>
Chinese-pyim 不会更改普通词库文件的内容，只会将运行过程中的词频信息保存到个人词频文件，这个过程分为两步：
</p>
<ol class="org-ol">
<li>调整个人词频文件对应的 buffer 的内容，这个过程的核心函数是 `pyim-intern-word'。</li>
<li>将 buffer 的内容保存到个人词频文件，这个使用函数 `pyim-save-personal-file' 完成。</li>
</ol>

<p>
`pyim-intern-word' 的工作原理和 `pyim-get' 类似， 只不过
`pyim-intern-word' 只搜索个人词频文件对应的 buffer ，搜索到结果后做如下工作：
</p>

<ol class="org-ol">
<li>获取当前行的信息，并其格式为一个list</li>
<li>将参数 `word' 对应的词条和上述list合并
<ol class="org-ol">
<li>向前追加（用于词频调整功能）</li>
<li>向后追加（用于造词功能）</li>
<li>从list中删除word （用于删词功能）</li>
</ol></li>
<li>使用 `pyim-delete-line' 删除当前行</li>
<li>将合并后的list转换为词库格式后，再写入当前行。</li>
</ol>

<p>
围绕着 `pyim-intern-word'，Chinese-pyim 构建了3类命令：
</p>
<ol class="org-ol">
<li>将一个中文词条加入个人词频文件（造词功能）</li>
<li>将一个中文词条从个人词频文件中删除（删词功能）</li>
<li>调整一个中文词条选项的位置（词频调整功能）</li>
</ol>
</div>

<ol class="org-ol"><li><a id="orgheadline11"></a>造词功能和词频调整功能<br  /><div class="outline-text-5" id="text-2-4-4-1">
<ol class="org-ol">
<li>`pyim-create-or-rearrange-word' 当用户选择了一个词库中不存在的中文词条时，
`pyim-select-current' 会调用这个函数来自动造词。其工作流程是：
<ol class="org-ol">
<li>使用 `chinese-hanzi2pinyin' 获取中文词条的拼音。</li>
<li>然后调用 `pyim-intern-word' 保存词条，多音字重复操作，比如：</li>
</ol></li>
</ol>
<p>
;;
</p>
<pre class="example">
yin-hang 银行
yin-xing 银行
</pre>
<p>
;;
    另外，这个函数也用于<b>词频调整</b>。
;;
    BUG：这种处理方式最大的问题是<b>无法正确处理</b>多音字，从而导致
    chinese-pyim 个人文件<b>不纯洁</b>  :-)，但不影响使用。Emacs-eim
    使用的方式不存在这种问题，但其增加了代码的复杂度，并且灵活性太差增加高级功能，比如 “词语联想”，时存在问题。
;;
</p>
<ol class="org-ol">
<li>`pyim-create-word-at-point' 这个命令会提取光标前 `number' 个中文字符，将其组成字符串后，调用 `pyim-create-word' 将其加入个人词频文件。</li>
<li>`pyim-create-word-at-point:&lt;NUM&gt;char' 这组命令是
`pyim-create-word-at-point' 的包装命令。</li>
</ol>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-delete-line</span> ()
  (delete-region (line-beginning-position) (min (+ (line-end-position) 1)
                                                (point-max))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-intern-word</span> (word py <span style="color: #D8FA3C;">&amp;optional</span> append delete)
  <span style="color: #61CE3C;">"&#36825;&#20010;&#20989;&#25968;&#29992;&#20110;&#20445;&#23384;&#29992;&#25143;&#35789;&#39057;&#65292;&#23558;&#21442;&#25968;&#25340;&#38899; `</span><span style="color: #61CE3C;">py</span><span style="color: #61CE3C;">' &#23545;&#24212;&#30340;&#20013;&#25991;&#35789;&#26465; `</span><span style="color: #61CE3C;">word</span><span style="color: #61CE3C;">'</span>
<span style="color: #61CE3C;">&#20445;&#23384;&#21040; personal-file &#23545;&#24212;&#30340; buffer&#12290;</span>

<span style="color: #61CE3C;">&#24403; `</span><span style="color: #61CE3C;">append</span><span style="color: #61CE3C;">' &#35774;&#32622;&#20026; t &#26102;&#65292;&#26032;&#35789;&#36861;&#21152;&#21040;&#24050;&#26377;&#35789;&#30340;&#21518;&#38754;&#12290;</span>

<span style="color: #61CE3C;">&#24403;`</span><span style="color: #61CE3C;">delete</span><span style="color: #61CE3C;">' &#35774;&#32622;&#20026; t &#26102;&#65292;&#20174;&#19978;&#36848; buffer &#20013;&#21024;&#38500;&#21442;&#25968;&#25340;&#38899; `</span><span style="color: #61CE3C;">py</span><span style="color: #61CE3C;">' &#23545;&#24212;</span>
<span style="color: #61CE3C;">&#30340;&#20013;&#25991;&#35789;&#26465; `</span><span style="color: #61CE3C;">word</span><span style="color: #61CE3C;">'&#12290;"</span>
  (<span style="color: #FBDE2D;">let</span>((buf (cdr (assoc <span style="color: #61CE3C;">"buffer"</span> (car pyim-buffer-list))))
       words)
    (<span style="color: #FBDE2D;">with-current-buffer</span> buf
      (pyim-bisearch-word py (point-min) (point-max))
      (<span style="color: #FBDE2D;">if</span> (string= (pyim-code-at-point) py)
          (<span style="color: #FBDE2D;">progn</span>
            (<span style="color: #FBDE2D;">setq</span> words (pyim-line-content))
            (<span style="color: #FBDE2D;">if</span> delete
                (<span style="color: #FBDE2D;">setq</span> words (remove word words))
              (<span style="color: #FBDE2D;">setq</span> words
                    (cons (car words)
                          (delete-dups
                           (<span style="color: #FBDE2D;">if</span> append
                               (append (cdr words) (list word))
                             (append (list word) (cdr words)))))))
            <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">(message "delete: %s" words))</span>
            (pyim-delete-line))
        (forward-line 1)
        (<span style="color: #FBDE2D;">setq</span> words (list py word)))
      <span style="color: #8B8989; font-style: italic;">;;    </span><span style="color: #8B8989; font-style: italic;">(message "insert: %s" words)</span>
      (<span style="color: #FBDE2D;">when</span> (&gt; (length words) 1)
        (insert (mapconcat 'identity words <span style="color: #61CE3C;">" "</span>) <span style="color: #61CE3C;">"\n"</span>)))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-create-or-rearrange-word</span> (word <span style="color: #D8FA3C;">&amp;optional</span> rearrange-word)
  <span style="color: #61CE3C;">"&#23558;&#20013;&#25991;&#35789;&#26465; `</span><span style="color: #61CE3C;">word</span><span style="color: #61CE3C;">' &#28155;&#21152;&#25340;&#38899;&#21518;&#65292;&#20445;&#23384;&#21040; personal-file &#23545;&#24212;&#30340;</span>
<span style="color: #61CE3C;">buffer&#20013;&#65292;&#24403;&#21069;&#35789;&#26465;&#36861;&#21152;&#21040;&#24050;&#26377;&#35789;&#26465;&#20043;&#21518;&#12290;`</span><span style="color: #61CE3C;">pyim-create-or-rearrange-word</span><span style="color: #61CE3C;">'&#20250;&#35843;&#29992;</span>
<span style="color: #61CE3C;">`</span><span style="color: #61CE3C;">pyim-hanzi2pinyin</span><span style="color: #61CE3C;">' &#26469;&#33719;&#21462;&#20013;&#25991;&#35789;&#26465;&#30340;&#25340;&#38899;code&#12290;</span>

<span style="color: #61CE3C;">BUG&#65306;&#26080;&#27861;&#26377;&#25928;&#30340;&#22788;&#29702;&#22810;&#38899;&#23383;&#12290;"</span>
  (<span style="color: #FBDE2D;">let</span> ((pinyins (pyim-hanzi2pinyin word nil <span style="color: #61CE3C;">"-"</span> t nil t))) <span style="color: #8B8989; font-style: italic;">;</span><span style="color: #8B8989; font-style: italic;">&#20351;&#29992;&#20102;&#22810;&#38899;&#23383;&#26657;&#27491;</span>
    (mapc #'(lambda (py)
              (<span style="color: #FBDE2D;">unless</span> (string-match-p <span style="color: #61CE3C;">"[</span><span style="color: #61CE3C;">^</span><span style="color: #61CE3C;"> a-z-]"</span> py)
                <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#28155;&#21152;&#35789;&#24211;&#65306; &#8221;&#25340;&#38899;&#8220; - &#8221;&#20013;&#25991;&#35789;&#26465;&#8220;</span>
                (pyim-intern-word word py (not rearrange-word))
                <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#28155;&#21152;&#35789;&#24211;&#65306; &#8221;&#25340;&#38899;&#39318;&#23383;&#27597;&#8220; - &#8221;&#20013;&#25991;&#35789;&#26465;&#8220;</span>
                (pyim-intern-word word
                                  (mapconcat
                                   #'(lambda (x)
                                       (substring x 0 1))
                                   (split-string py <span style="color: #61CE3C;">"-"</span>)
                                   <span style="color: #61CE3C;">"-"</span>)
                                  (not rearrange-word))))
          pinyins)))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-chinese-string-at-point</span> (<span style="color: #D8FA3C;">&amp;optional</span> number)
  <span style="color: #61CE3C;">"&#33719;&#21462;&#20809;&#26631;&#19968;&#20010;&#20013;&#25991;&#23383;&#31526;&#20018;&#65292;&#23383;&#31526;&#25968;&#37327;&#20026;&#65306;`</span><span style="color: #61CE3C;">number</span><span style="color: #61CE3C;">'"</span>
  (<span style="color: #FBDE2D;">save-excursion</span>
    (<span style="color: #FBDE2D;">let*</span> ((point (point))
           (begin (- point number))
           (begin (<span style="color: #FBDE2D;">if</span> (&gt; begin 0)
                      begin
                    (point-min)))
           (string (buffer-substring-no-properties
                    point begin)))
      (<span style="color: #FBDE2D;">when</span> (<span style="color: #FBDE2D;">and</span> string
                 (= (length string) number)
                 (not (string-match-p <span style="color: #61CE3C;">"\\CC"</span> string)))
        string))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-create-word-at-point</span> (<span style="color: #D8FA3C;">&amp;optional</span> number silent)
  <span style="color: #61CE3C;">"&#23558;&#20809;&#26631;&#21069;&#23383;&#31526;&#25968;&#20026; `</span><span style="color: #61CE3C;">number</span><span style="color: #61CE3C;">' &#30340;&#20013;&#25991;&#23383;&#31526;&#20018;&#28155;&#21152;&#21040;&#20010;&#20154;&#35789;&#24211;&#20013;</span>
<span style="color: #61CE3C;">&#24403; `</span><span style="color: #61CE3C;">silent</span><span style="color: #61CE3C;">' &#35774;&#32622;&#20026; t &#26159;&#65292;&#19981;&#26174;&#31034;&#25552;&#37266;&#20449;&#24687;&#12290;"</span>
  (<span style="color: #FBDE2D;">let*</span> ((string (pyim-chinese-string-at-point (<span style="color: #FBDE2D;">or</span> number 2))))
    (<span style="color: #FBDE2D;">when</span> string
      (pyim-create-or-rearrange-word string)
      (<span style="color: #FBDE2D;">unless</span> silent
        (message <span style="color: #61CE3C;">"&#23558;&#35789;&#26465;: \"%s\" &#25554;&#20837; personal file&#12290;"</span> string)))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-create-word-at-point:2char</span> ()
  <span style="color: #61CE3C;">"&#23558;&#20809;&#26631;&#21069;2&#20010;&#20013;&#25991;&#23383;&#31526;&#32452;&#25104;&#30340;&#23383;&#31526;&#20018;&#21152;&#20837;&#20010;&#20154;&#35789;&#24211;&#12290;"</span>
  (<span style="color: #FBDE2D;">interactive</span>)
  (pyim-create-word-at-point 2))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-create-word-at-point:3char</span> ()
  <span style="color: #61CE3C;">"&#23558;&#20809;&#26631;&#21069;3&#20010;&#20013;&#25991;&#23383;&#31526;&#32452;&#25104;&#30340;&#23383;&#31526;&#20018;&#21152;&#20837;&#20010;&#20154;&#35789;&#24211;&#12290;"</span>
  (<span style="color: #FBDE2D;">interactive</span>)
  (pyim-create-word-at-point 3))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-create-word-at-point:4char</span> ()
  <span style="color: #61CE3C;">"&#23558;&#20809;&#26631;&#21069;4&#20010;&#20013;&#25991;&#23383;&#31526;&#32452;&#25104;&#30340;&#23383;&#31526;&#20018;&#21152;&#20837;&#20010;&#20154;&#35789;&#24211;&#12290;"</span>
  (<span style="color: #FBDE2D;">interactive</span>)
  (pyim-create-word-at-point 4))
</pre>
</div>
</div></li>

<li><a id="orgheadline12"></a>删词功能<br  /><div class="outline-text-5" id="text-2-4-4-2">
<p>
`pyim-delete-word-from-personal-buffer' 从个人词频 buffer 中删除用户高亮选择的词条。
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-delete-word</span> (word)
  <span style="color: #61CE3C;">"&#23558;&#20013;&#25991;&#35789;&#26465; `</span><span style="color: #61CE3C;">word</span><span style="color: #61CE3C;">' &#20174; personal-file &#23545;&#24212;&#30340; buffer &#20013;&#21024;&#38500;"</span>
  (mapc (<span style="color: #FBDE2D;">lambda</span> (py)
          (<span style="color: #FBDE2D;">unless</span> (string-match-p <span style="color: #61CE3C;">"[</span><span style="color: #61CE3C;">^</span><span style="color: #61CE3C;"> a-z-]"</span> py)
            (pyim-intern-word word py nil t)))
        (pyim-hanzi2pinyin word nil <span style="color: #61CE3C;">"-"</span> t)))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-delete-word-from-personal-buffer</span> ()
  <span style="color: #61CE3C;">"&#23558;&#39640;&#20142;&#36873;&#25321;&#30340;&#23383;&#31526;&#20174; personel-file &#23545;&#24212;&#30340; buffer &#20013;&#21024;&#38500;&#12290;"</span>
  (<span style="color: #FBDE2D;">interactive</span>)
  (<span style="color: #FBDE2D;">if</span> mark-active
      (<span style="color: #FBDE2D;">let</span> ((string (buffer-substring-no-properties
                     (region-beginning) (region-end))))
        (<span style="color: #FBDE2D;">when</span> (<span style="color: #FBDE2D;">and</span> (&lt; (length string) 6)
                   (&gt; (length string) 0))
          (pyim-delete-word string)
          (message <span style="color: #61CE3C;">"&#23558;&#35789;&#26465;: \"%s\" &#20174; personal file&#20013;&#21024;&#38500;&#12290;"</span> string)))
    (message <span style="color: #61CE3C;">"&#35831;&#39318;&#20808;&#39640;&#20142;&#36873;&#25321;&#38656;&#35201;&#21024;&#38500;&#30340;&#35789;&#26465;&#12290;"</span>)))
</pre>
</div>
</div></li></ol>
</div>
</div>

<div id="outline-container-orgheadline17" class="outline-3">
<h3 id="orgheadline17"><span class="section-number-3">2.5</span> 生成 `pyim-current-key' 并插入 `pyim-current-str'</h3>
<div class="outline-text-3" id="text-2-5">
</div><div id="outline-container-orgheadline15" class="outline-4">
<h4 id="orgheadline15"><span class="section-number-4">2.5.1</span> 生成拼音字符串 `pyim-current-key'</h4>
<div class="outline-text-4" id="text-2-5-1">
<p>
Chinese-pyim 使用函数 `pyim-start' 启动输入法的时候，会将变量
`input-method-function' 设置为 `pyim-input-method' ，这个变量会影响 `read-event' 的行为。
</p>

<p>
当输入字符时，`read-event' 会被调用，`read-event' 调用的过程中，会执行 `pyim-input-method' 这个函数。`pyim-input-method' 又调用函数
`pyim-start-translation'
</p>

<p>
`pyim-start-translation' 这个函数较复杂，作许多低层工作，但它的一个重要流程是：
</p>
<ol class="org-ol">
<li>使用函数 `read-key-sequence' 得到 key-sequence</li>
<li>使用函数 `lookup-key' 查询 pyim-mode-map 中，上述 key-sequence 对应的命令。</li>
<li>如果查询得到的命令是 'pyim-self-insert-command' 时，
`pyim-start-translation' 会调用这个函数。</li>
</ol>

<p>
`pyim-self-insert-command' 这个函数的核心工作就是将用户输入的字符，组合成拼音字符串并保存到变量 `pyim-current-key' 中。
</p>

<p>
中英文输入模式切换功能也是在 'pyim-self-insert-command' 中实现。
</p>

<p>
这个部份的代码涉及许多 emacs 低层函数，相对复杂，不容易理解，有兴趣的朋友可以参考：
</p>
<ol class="org-ol">
<li>`quail-input-method' 相关函数。</li>
<li>elisp 手册相关章节:
<ol class="org-ol">
<li>Invoking the Input Method</li>
<li>Input Methods</li>
<li>Miscellaneous Event Input Features</li>
<li>Reading One Event</li>
</ol></li>
</ol>
</div>
</div>

<div id="outline-container-orgheadline16" class="outline-4">
<h4 id="orgheadline16"><span class="section-number-4">2.5.2</span> 在待输入 buffer 中插入 `pyim-current-str'</h4>
<div class="outline-text-4" id="text-2-5-2">
<p>
`pyim-self-insert-command' 会调用 `pyim-handle-string' 来处理
`pyim-current-key'，得到对应的 `pyim-current-str'，然后，
`pyim-start-translation' 返回 `pyim-current-str' 的取值。
</p>

<p>
在 `pyim-input-method' 函数内部，`pyim-start-translation' 返回值分解为
event list。
</p>

<p>
最后，emacs 低层函数 read-event 将这个 list 插入<b>待输入buffer</b>。
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-input-method</span> (key)
  (<span style="color: #FBDE2D;">if</span> (<span style="color: #FBDE2D;">or</span> buffer-read-only
          overriding-terminal-local-map
          overriding-local-map)
      (list key)
    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">(message "call with key: %c" key)</span>
    (pyim-setup-overlays)
    (<span style="color: #FBDE2D;">with-silent-modifications</span>
      (<span style="color: #FBDE2D;">unwind-protect</span>
          (<span style="color: #FBDE2D;">let</span> ((input-string (pyim-start-translation key)))
            <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">(message "input-string: %s" input-string)</span>
            (<span style="color: #FBDE2D;">setq</span> pyim-guidance-str <span style="color: #61CE3C;">""</span>)
            (<span style="color: #FBDE2D;">when</span> (<span style="color: #FBDE2D;">and</span> (stringp input-string)
                       (&gt; (length input-string) 0))
              (<span style="color: #FBDE2D;">if</span> input-method-exit-on-first-char
                  (list (aref input-string 0))
                (mapcar 'identity input-string))))
        (pyim-delete-overlays)))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-start-translation</span> (key)
  <span style="color: #61CE3C;">"Start translation of the typed character KEY by Chinese-pyim.</span>
<span style="color: #61CE3C;">Return the input string."</span>
  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">Check the possibility of translating KEY.</span>
  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">If KEY is nil, we can anyway start translation.</span>
  (<span style="color: #FBDE2D;">if</span> (<span style="color: #FBDE2D;">or</span> (integerp key) (null key))
      <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">OK, we can start translation.</span>
      (<span style="color: #FBDE2D;">let*</span> ((echo-keystrokes 0)
             (help-char nil)
             (overriding-terminal-local-map pyim-mode-map)
             (generated-events nil)
             (input-method-function nil)
             (modified-p (buffer-modified-p))
             last-command-event last-command this-command)
        (<span style="color: #FBDE2D;">setq</span> pyim-current-str <span style="color: #61CE3C;">""</span>
              pyim-current-key <span style="color: #61CE3C;">""</span>
              pyim-translating t)
        (<span style="color: #FBDE2D;">if</span> key
            (<span style="color: #FBDE2D;">setq</span> unread-command-events
                  (cons key unread-command-events)))
        (<span style="color: #FBDE2D;">while</span> pyim-translating
          (set-buffer-modified-p modified-p)
          (<span style="color: #FBDE2D;">let*</span> ((prompt (<span style="color: #FBDE2D;">if</span> input-method-use-echo-area
                             (format <span style="color: #61CE3C;">"%s%s %s"</span>
                                     (<span style="color: #FBDE2D;">or</span> input-method-previous-message <span style="color: #61CE3C;">""</span>)
                                     pyim-current-key
                                     pyim-guidance-str)))
                 (keyseq (read-key-sequence prompt nil nil t))
                 (cmd (lookup-key pyim-mode-map keyseq)))
            <span style="color: #8B8989; font-style: italic;">;;             </span><span style="color: #8B8989; font-style: italic;">(message "key: %s, cmd:%s\nlcmd: %s, lcmdv: %s, tcmd: %s"</span>
            <span style="color: #8B8989; font-style: italic;">;;                      </span><span style="color: #8B8989; font-style: italic;">key cmd last-command last-command-event this-command)</span>
            (<span style="color: #FBDE2D;">if</span> (<span style="color: #FBDE2D;">if</span> key
                    (commandp cmd)
                  (eq cmd 'pyim-self-insert-command))
                (<span style="color: #FBDE2D;">progn</span>
                  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">(message "keyseq: %s" keyseq)</span>
                  (<span style="color: #FBDE2D;">setq</span> last-command-event (aref keyseq (1- (length keyseq)))
                        last-command this-command
                        this-command cmd)
                  (<span style="color: #FBDE2D;">setq</span> key t)
                  (<span style="color: #FBDE2D;">condition-case</span> err
                      (call-interactively cmd)
                    (<span style="color: #ff69b4;">error</span> (message <span style="color: #61CE3C;">"%s"</span> (cdr err)) (beep))))
              <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">KEYSEQ is not defined in the translation keymap.</span>
              <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">Let's return the event(s) to the caller.</span>
              (<span style="color: #FBDE2D;">setq</span> unread-command-events
                    (string-to-list (this-single-command-raw-keys)))
              <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">(message "unread-command-events: %s" unread-command-events)</span>
              (pyim-terminate-translation))))
        <span style="color: #8B8989; font-style: italic;">;;    </span><span style="color: #8B8989; font-style: italic;">(1message "return: %s" pyim-current-str)</span>
        pyim-current-str)
    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">Since KEY doesn't start any translation, just return it.</span>
    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">But translate KEY if necessary.</span>
    (char-to-string key)))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-input-chinese-p</span> ()
  <span style="color: #61CE3C;">"&#30830;&#23450; Chinese-pyim &#26159;&#21542;&#21551;&#21160;&#20013;&#25991;&#36755;&#20837;&#27169;&#24335;"</span>
  (<span style="color: #FBDE2D;">and</span> (not pyim-input-ascii)
       (<span style="color: #FBDE2D;">if</span> (functionp pyim-english-input-switch-function)
           (not (funcall pyim-english-input-switch-function)) t)
       (<span style="color: #FBDE2D;">if</span> (pyim-string-emptyp pyim-current-key)
           (member last-command-event
                   (mapcar 'identity <span style="color: #61CE3C;">"abcdefghjklmnopqrstwxyz"</span>))
         (member last-command-event
                 (mapcar 'identity <span style="color: #61CE3C;">"vmpfwckzyjqdltxuognbhsrei'-a"</span>)))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-self-insert-command</span> ()
  <span style="color: #61CE3C;">"&#22914;&#26524;&#22312; pyim-first-char &#21015;&#34920;&#20013;&#65292;&#21017;&#26597;&#25214;&#30456;&#24212;&#30340;&#35789;&#26465;&#65292;&#21542;&#21017;&#20572;&#27490;&#36716;&#25442;&#65292;&#25554;&#20837;&#23545;&#24212;&#30340;&#23383;&#31526;"</span>
  (<span style="color: #FBDE2D;">interactive</span> <span style="color: #61CE3C;">"*"</span>)
  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">(message "%s" (current-buffer))</span>
  (<span style="color: #FBDE2D;">if</span> (pyim-input-chinese-p)
      (<span style="color: #FBDE2D;">progn</span> (<span style="color: #FBDE2D;">setq</span> pyim-current-key
                   (concat pyim-current-key (char-to-string last-command-event)))
             (pyim-handle-string))
    (pyim-append-string (pyim-translate last-command-event))
    (pyim-terminate-translation)))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-terminate-translation</span> ()
  <span style="color: #61CE3C;">"Terminate the translation of the current key."</span>
  (<span style="color: #FBDE2D;">setq</span> pyim-translating nil)
  (pyim-delete-region)
  (<span style="color: #FBDE2D;">setq</span> pyim-current-choices nil)
  (<span style="color: #FBDE2D;">setq</span> pyim-guidance-str <span style="color: #61CE3C;">""</span>)
  (<span style="color: #FBDE2D;">when</span> (pyim-use-tooltip-p)
    (pos-tip-hide)))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgheadline22" class="outline-3">
<h3 id="orgheadline22"><span class="section-number-3">2.6</span> 处理拼音字符串 `pyim-current-key'</h3>
<div class="outline-text-3" id="text-2-6">
</div><div id="outline-container-orgheadline20" class="outline-4">
<h4 id="orgheadline20"><span class="section-number-4">2.6.1</span> 拼音字符串 -&gt; 待选词列表</h4>
<div class="outline-text-4" id="text-2-6-1">
<p>
从一个拼音字符串获取其待选词列表，大致可以分成3个步骤：
</p>
<ol class="org-ol">
<li><p>
分解这个拼音字符串，得到一个拼音列表。
</p>
<pre class="example">
woaimeinv -&gt; (("w" . "o") ("" . "ai") ("m" . "ei") ("n" . "v"))
</pre></li>
<li><p>
将拼音列表排列组合，得到多个词语的拼音，并用列表表示。
</p>
<pre class="example">
(("p" . "in") ("y" . "in") ("sh" . "") ("r" . ""))
=&gt; ("pin-yin"  ;; 完整的拼音
    ("p-y-sh" ("p" . "in") ("y" . "in") ("sh" . "")) ;; 不完整的拼音
    ("p-y-sh-r" ("p" . "in") ("y" . "in") ("sh" . "") ("r" . "")) ;; 不完整的拼音
    )
</pre></li>
<li>递归的查询上述多个词语拼音，将得到的结果合并为待选词列表。</li>
</ol>
</div>
<ol class="org-ol"><li><a id="orgheadline18"></a>分解拼音字符串<br  /><div class="outline-text-5" id="text-2-6-1-1">
<p>
拼音字符串操作主要做两方面的工作：
</p>
<ol class="org-ol">
<li>将拼音字符串分解为拼音列表。</li>
<li>将拼音列表合并成拼音字符串。</li>
</ol>

<p>
在这之前，Chinese-pyim 定义了三个变量：
</p>
<ol class="org-ol">
<li>声母表： `pyim-shen-mu'</li>
<li>韵母表：`pyim-yun-mu'</li>
<li>有效韵母表： `pyim-valid-yun-mu'</li>
</ol>

<p>
Chinese-pyim 使用函数 `pyim-split-string' 将拼音字符串分解为一个由声母和韵母组成的拼音列表，比如：
</p>

<pre class="example">
(pyim-split-string "woaimeinv")
</pre>

<p>
结果为:
</p>
<pre class="example">
(("w" . "o") ("" . "ai") ("m" . "ei") ("n" . "v"))
</pre>

<p>
这个过程通过递归的调用 `pyim-get-charpy' 来实现，整个过程类似用菜刀切黄瓜片，将一个拼音字符串逐渐切开。比如：
</p>

<pre class="example">
(pyim-get-charpy "woaimeinv")
</pre>

<p>
结果为:
</p>
<pre class="example">
(("w" . "o") . "aimeinv")
</pre>

<p>
一个完整的递归过程类似：
</p>
<pre class="example">
"woaimeinv"
(("w" . "o") . "aimeinv")
(("w" . "o") ("" . "ai") . "meinv")
(("w" . "o") ("" . "ai") ("m" . "ei" ) . "nv")
(("w" . "o") ("" . "ai") ("m" . "ei" ) ("n" . "v"))
</pre>

<p>
`pyim-get-charpy' 由两个基本函数配合实现：
</p>
<ol class="org-ol">
<li>pyim-get-sm 从一个拼音字符串中提出第一个声母</li>
<li>pyim-get-ym 从一个拼音字符串中提出第一个韵母</li>
</ol>

<pre class="example">
(pyim-get-sm "woaimeinv")
</pre>

<p>
结果为:
</p>
<pre class="example">
("w" . "oaimeinv")
</pre>

<pre class="example">
(pyim-get-ym "oaimeinv")
</pre>

<p>
结果为:
</p>
<pre class="example">
("o" . "aimeinv")
</pre>

<p>
当用户输入一个错误的拼音时，`pyim-split-string' 会产生一个声母为空而韵母又不正确的拼音列表 ，比如：
</p>

<pre class="example">
(pyim-split-string "ua")
</pre>

<p>
结果为:
</p>
<pre class="example">
(("" . "ua"))
</pre>

<p>
这种错误可以使用函数 `pyim-validp' 来检测。
</p>
<pre class="example">
(list (pyim-validp (pyim-split-string "ua"))
      (pyim-validp (pyim-split-string "a"))
      (pyim-validp (pyim-split-string "wa"))
      (pyim-validp (pyim-split-string "wua")))
</pre>

<p>
结果为:
</p>
<pre class="example">
(nil t t t)
</pre>

<p>
Chinese-pyim 使用函数 `pyim-pylist-to-string' 将一个拼音列表合并为拼音字符串，这个可以认为是 `pyim-split-string' 的反向操作。构建得到的拼音字符串用于搜索词条。
</p>

<pre class="example">
(pyim-pylist-to-string '(("w" . "o") ("" . "ai") ("m" . "ei") ("n" . "v")))
</pre>

<p>
结果为:
</p>
<pre class="example">
"wo-ai-mei-nv"
</pre>

<p>
最后： `pyim-user-divide-pos' 和 `pyim-restore-user-divide' 用来处理隔音符，比如： xi'an
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#23558;&#27721;&#23383;&#30340;&#25340;&#38899;&#20998;&#25104;&#22768;&#27597;&#21644;&#20854;&#23427;</span>
(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-get-sm</span> (py)
  <span style="color: #61CE3C;">"&#20174;&#19968;&#20010;&#25340;&#38899;&#23383;&#31526;&#20018;&#20013;&#25552;&#20986;&#31532;&#19968;&#20010;&#22768;&#27597;&#12290;"</span>
  (<span style="color: #FBDE2D;">when</span> (<span style="color: #FBDE2D;">and</span> py (string&lt; <span style="color: #61CE3C;">""</span> py))
    (<span style="color: #FBDE2D;">let</span> (shenmu yunmu len)
      (<span style="color: #FBDE2D;">if</span> (&lt; (length py) 2)
          (<span style="color: #FBDE2D;">if</span> (member py pyim-shen-mu)
              (cons py <span style="color: #61CE3C;">""</span>)
            (cons <span style="color: #61CE3C;">""</span> py))
        (<span style="color: #FBDE2D;">setq</span> shenmu (substring py 0 2))
        (<span style="color: #FBDE2D;">if</span> (member shenmu pyim-shen-mu)
            (<span style="color: #FBDE2D;">setq</span> py (substring py 2))
          (<span style="color: #FBDE2D;">setq</span> shenmu (substring py 0 1))
          (<span style="color: #FBDE2D;">if</span> (member shenmu pyim-shen-mu)
              (<span style="color: #FBDE2D;">setq</span> py (substring py 1))
            (<span style="color: #FBDE2D;">setq</span> shenmu <span style="color: #61CE3C;">""</span>)))
        (cons shenmu py)))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-get-ym</span> (py)
  <span style="color: #61CE3C;">"&#20174;&#19968;&#20010;&#25340;&#38899;&#23383;&#31526;&#20018;&#20013;&#25552;&#20986;&#31532;&#19968;&#20010;&#38901;&#27597;"</span>
  (<span style="color: #FBDE2D;">when</span> (<span style="color: #FBDE2D;">and</span> py (string&lt; <span style="color: #61CE3C;">""</span> py))
    (<span style="color: #FBDE2D;">let</span> (yunmu len)
      (<span style="color: #FBDE2D;">setq</span> len (min (length py) 5))
      (<span style="color: #FBDE2D;">setq</span> yunmu (substring py 0 len))
      (<span style="color: #FBDE2D;">while</span> (<span style="color: #FBDE2D;">and</span> (not (member yunmu pyim-yun-mu))
                  (&gt; len 0))
        (<span style="color: #FBDE2D;">setq</span> yunmu (substring py 0 (<span style="color: #FBDE2D;">setq</span> len (1- len)))))
      (<span style="color: #FBDE2D;">setq</span> py (substring py len))
      (<span style="color: #FBDE2D;">if</span> (<span style="color: #FBDE2D;">and</span> (string&lt; <span style="color: #61CE3C;">""</span> py)
               (not (member (substring py 0 1) pyim-shen-mu))
               (member (substring yunmu -1) pyim-shen-mu)
               (member (substring yunmu 0 -1) pyim-yun-mu))
          (<span style="color: #FBDE2D;">setq</span> py (concat (substring yunmu -1) py)
                yunmu (substring yunmu 0 -1)))
      (cons yunmu py))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-get-charpy</span> (py)
  <span style="color: #61CE3C;">"&#20998;&#35299;&#19968;&#20010;&#25340;&#38899;&#23383;&#31526;&#20018;&#25104;&#22768;&#27597;&#21644;&#38901;&#27597;&#12290;"</span>
  (<span style="color: #FBDE2D;">when</span> (<span style="color: #FBDE2D;">and</span> py (string&lt; <span style="color: #61CE3C;">""</span> py))
    (<span style="color: #FBDE2D;">let*</span> ((sm (pyim-get-sm py))
           (ym (pyim-get-ym (cdr sm)))
           (chpy (concat (car sm) (car ym))))
      (<span style="color: #FBDE2D;">if</span> (<span style="color: #FBDE2D;">or</span> (null ym)                 <span style="color: #8B8989; font-style: italic;">; </span><span style="color: #8B8989; font-style: italic;">&#22914;&#26524;&#38901;&#27597;&#20026;&#31354;</span>
              (<span style="color: #FBDE2D;">and</span> (string&lt; <span style="color: #61CE3C;">""</span> (car ym)) (not (pyim-get chpy)))) <span style="color: #8B8989; font-style: italic;">; </span><span style="color: #8B8989; font-style: italic;">&#38169;&#35823;&#30340;&#25340;&#38899;</span>
          (cons sm <span style="color: #61CE3C;">""</span>)
        (cons (cons (car sm) (car ym)) (cdr ym))))))

<span style="color: #8B8989; font-style: italic;">;;; </span><span style="color: #8B8989; font-style: italic;">&#22788;&#29702;&#36755;&#20837;&#30340;&#25340;&#38899;</span>
(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-split-string</span> (py)
  <span style="color: #61CE3C;">"&#25226;&#19968;&#20010;&#25340;&#38899;&#23383;&#31526;&#20018;&#20998;&#35299;&#12290;&#22914;&#26524;&#21547;&#26377; '&#65292;&#20248;&#20808;&#22312;&#36825;&#20010;&#20301;&#32622;&#20013;&#26029;&#65292;&#21542;&#21017;&#65292;&#33258;&#21160;&#20998;</span>
<span style="color: #61CE3C;">&#35299;&#25104;&#22768;&#27597;&#21644;&#38901;&#27597;&#30340;&#32452;&#21512;"</span>
  (<span style="color: #FBDE2D;">when</span> (<span style="color: #FBDE2D;">and</span> py (string&lt; <span style="color: #61CE3C;">""</span> py))
    (apply 'append
           (mapcar (<span style="color: #FBDE2D;">lambda</span> (p)
                     (<span style="color: #FBDE2D;">let</span> (chpy pylist)
                       (<span style="color: #FBDE2D;">setq</span> p (replace-regexp-in-string <span style="color: #61CE3C;">"[ -]"</span> <span style="color: #61CE3C;">""</span> p))
                       (<span style="color: #FBDE2D;">while</span> (<span style="color: #FBDE2D;">when</span> (string&lt; <span style="color: #61CE3C;">""</span> p)
                                (<span style="color: #FBDE2D;">setq</span> chpy (pyim-get-charpy p))
                                (<span style="color: #FBDE2D;">setq</span> pylist (append pylist (list (car chpy))))
                                (<span style="color: #FBDE2D;">setq</span> p (cdr chpy))))
                       pylist))
                   (split-string py <span style="color: #61CE3C;">"'"</span>)))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-validp</span> (pylist)
  <span style="color: #61CE3C;">"&#26816;&#26597;&#24471;&#21040;&#30340;&#25340;&#38899;&#26159;&#21542;&#21547;&#26377;&#22768;&#27597;&#20026;&#31354;&#65292;&#32780;&#38901;&#27597;&#21448;&#19981;&#27491;&#30830;&#30340;&#25340;&#38899;"</span>
  (<span style="color: #FBDE2D;">let</span> ((valid t) py)
    (<span style="color: #FBDE2D;">while</span> (<span style="color: #FBDE2D;">progn</span>
             (<span style="color: #FBDE2D;">setq</span> py (car pylist))
             (<span style="color: #FBDE2D;">if</span> (<span style="color: #FBDE2D;">and</span> (not (string&lt; <span style="color: #61CE3C;">""</span> (car py)))
                      (not (member (cdr py) pyim-valid-yun-mu)))
                 (<span style="color: #FBDE2D;">setq</span> valid nil)
               (<span style="color: #FBDE2D;">setq</span> pylist (cdr pylist)))))
    valid))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-user-divide-pos</span> (py)
  <span style="color: #61CE3C;">"&#26816;&#27979;&#20986;&#29992;&#25143;&#20998;&#21106;&#30340;&#20301;&#32622;"</span>
  (<span style="color: #FBDE2D;">setq</span> py (replace-regexp-in-string <span style="color: #61CE3C;">"-"</span> <span style="color: #61CE3C;">""</span> py))
  (<span style="color: #FBDE2D;">let</span> (poslist (start 0))
    (<span style="color: #FBDE2D;">while</span> (string-match <span style="color: #61CE3C;">"'"</span> py start)
      (<span style="color: #FBDE2D;">setq</span> start (match-end 0))
      (<span style="color: #FBDE2D;">setq</span> poslist (append poslist (list (match-beginning 0)))))
    poslist))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-restore-user-divide</span> (py pos)
  <span style="color: #61CE3C;">"&#25353;&#26816;&#27979;&#20986;&#30340;&#29992;&#25143;&#20998;&#35299;&#30340;&#20301;&#32622;&#65292;&#37325;&#26032;&#35774;&#32622;&#25340;&#38899;"</span>
  (<span style="color: #FBDE2D;">let</span> ((i 0) (shift 0) cur)
    (<span style="color: #FBDE2D;">setq</span> cur (car pos)
          pos (cdr pos))
    (<span style="color: #FBDE2D;">while</span> (<span style="color: #FBDE2D;">and</span> cur (&lt; i (length py)))
      (<span style="color: #FBDE2D;">if</span> (= (aref py i) ?-)
          (<span style="color: #FBDE2D;">if</span> (= i (+ cur shift))
              (<span style="color: #FBDE2D;">progn</span>
                (aset py i ?')
                (<span style="color: #FBDE2D;">setq</span> cur (car pos)
                      pos (cdr pos)))
            (<span style="color: #FBDE2D;">setq</span> shift (1+ shift))))
      (<span style="color: #FBDE2D;">setq</span> i (1+ i)))
    (<span style="color: #FBDE2D;">if</span> cur (<span style="color: #FBDE2D;">setq</span> py (concat py <span style="color: #61CE3C;">"'"</span>)))  <span style="color: #8B8989; font-style: italic;">; </span><span style="color: #8B8989; font-style: italic;">the last char is `''</span>
    py))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-pylist-to-string</span> (pylist <span style="color: #D8FA3C;">&amp;optional</span> shou-zi-mu)
  <span style="color: #61CE3C;">"&#25226;&#20998;&#35299;&#30340;&#25340;&#38899;&#21512;&#24182;&#65292;&#20197;&#20415;&#36827;&#34892;&#26597;&#25214;, &#24403; `</span><span style="color: #61CE3C;">shou-zi-mu</span><span style="color: #61CE3C;">' &#35774;&#32622;&#20026; t</span>
<span style="color: #61CE3C;">&#26102;&#65292;&#29983;&#25104;&#25340;&#38899;&#39318;&#23383;&#27597;&#23383;&#31526;&#20018;&#65292;&#27604;&#22914; p-y&#12290;"</span>
  (mapconcat 'identity
             (mapcar
              #'(lambda (w)
                  (<span style="color: #FBDE2D;">let</span> ((py (concat (car w) (cdr w))))
                    (<span style="color: #FBDE2D;">if</span> shou-zi-mu
                        (substring py 0 1)
                      py)))
              pylist)
             <span style="color: #61CE3C;">"-"</span>))
</pre>
</div>
</div></li>

<li><a id="orgheadline19"></a>获得词语拼音并进一步查询得到备选词列表<br  /><div class="outline-text-5" id="text-2-6-1-2">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-get-choices</span> (pylist)
  <span style="color: #61CE3C;">"&#24471;&#21040;&#21487;&#33021;&#30340;&#35789;&#32452;&#21644;&#27721;&#23383;&#12290;&#20363;&#22914;&#65306;</span>

<span style="color: #61CE3C;"> (pyim-get-choices  (pyim-split-string \"pin-yin\"))</span>
<span style="color: #61CE3C;">  =&gt; (\"&#25340;&#38899;\" \"&#25340;\" \"&#21697;\" \"&#36139;\" \"&#33529;\" \"&#32856;\" \"&#39057;\" \"&#25306;\" \"&#39078;\" \"&#29277;\" \"&#23252;\" \"&#23000;\" \"&#22188;\")</span>

<span style="color: #61CE3C;"> (pyim-get-choices  (pyim-split-string \"pin-yin\"))</span>
<span style="color: #61CE3C;"> =&gt; (\"&#25340;&#38899;\" \"&#36139;&#38080;\" \"&#32856;&#29992;\" \"&#25340;\" \"&#21697;\" \"&#36139;\" \"&#33529;\" \"&#32856;\" \"&#39057;\" \"&#25306;\" \"&#39078;\" \"&#29277;\" \"&#23252;\" \"&#23000;\" \"&#22188;\")"</span>
  (<span style="color: #FBDE2D;">let</span> ((py-str (pyim-pylist-to-string pylist))
        (py-str-shouzimu (pyim-pylist-to-string pylist t))
        choice words word guess-words-accurate guess-words-similar
        words-predicted chars wordspy)

    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#25628;&#32034;&#20005;&#26684;&#21305;&#37197;&#36755;&#20837;&#25340;&#38899;&#30340;&#35789;&#26465;&#12290;</span>
    (<span style="color: #FBDE2D;">setq</span> words (pyim-get py-str))

    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#22914;&#26524;&#36755;&#20837; "ni-hao" &#65292;&#25628;&#32034;&#25340;&#38899;&#19982; "ni-hao" &#31867;&#20284;&#30340;&#35789;&#26465;&#20316;&#20026;&#32852;&#24819;&#35789;&#12290;</span>
    (<span style="color: #FBDE2D;">when</span> (member 'pinyin-similar pyim-enable-words-predict)
      (<span style="color: #FBDE2D;">push</span> `(pinyin-similar ,@(pyim-predict py-str)) words-predicted))

    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#22914;&#26524;&#36755;&#20837; "ni-hao" &#65292;&#25628;&#32034; code &#20026; "n-h" &#30340;&#35789;&#26465;&#20570;&#20026;&#32852;&#24819;&#35789;&#12290;</span>
    (<span style="color: #FBDE2D;">when</span> (member 'pinyin-shouzimu pyim-enable-words-predict)
      (<span style="color: #FBDE2D;">push</span> `(pinyin-shouzimu ,@(pyim-get py-str-shouzimu)) words-predicted))

    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#22914;&#26524;&#19978;&#19968;&#27425;&#36755;&#20837;&#35789;&#26465; "&#20320;&#22909;" &#65292;&#37027;&#20040;&#20197; &#8220;&#20320;&#22909;&#8221; &#20026; code&#65292;&#20174; guessdict &#35789;&#24211;&#20013;&#25628;&#32034;&#35789;&#26465;</span>
    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#23558;&#25628;&#32034;&#24471;&#21040;&#30340;&#35789;&#26465;&#30340;&#25340;&#38899;&#19982; *&#24403;&#21069;&#36755;&#20837;&#30340;&#25340;&#38899;* &#36827;&#34892;&#27604;&#36739;&#65292;&#31867;&#20284;&#25110;&#32773;&#31934;&#30830;&#21305;&#37197;&#30340;&#35789;&#26465;&#20316;&#20026;&#32852;&#24819;&#35789;&#12290;</span>
    (<span style="color: #FBDE2D;">when</span> (member 'guess-words pyim-enable-words-predict)
      (<span style="color: #FBDE2D;">let</span> ((words (pyim-get pyim-last-input-word t))
            (count 0))
        (<span style="color: #FBDE2D;">while</span> words
          (<span style="color: #FBDE2D;">setq</span> word (<span style="color: #FBDE2D;">pop</span> words))
          (<span style="color: #FBDE2D;">let</span> ((pinyins (pyim-hanzi2pinyin word nil <span style="color: #61CE3C;">"-"</span> t)))
            (<span style="color: #FBDE2D;">when</span> (cl-some
                   #'(lambda (x)
                       (string-match-p (pyim-predict-build-regexp py-str) x))
                   pinyins)
              (<span style="color: #FBDE2D;">push</span> word guess-words-similar))
            (<span style="color: #FBDE2D;">when</span> (cl-some
                   #'(lambda (x)
                       (string= py-str x))
                   pinyins)
              (<span style="color: #FBDE2D;">push</span> word guess-words-accurate)))
          <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#24403; `</span><span style="color: #8B8989; font-style: italic;">words</span><span style="color: #8B8989; font-style: italic;">' &#21253;&#21547;&#30340;&#20803;&#32032;&#22826;&#22810;&#26102;&#65292;&#21518;&#38754;&#22788;&#29702;&#20250;&#26497;&#20854;&#32531;&#24930;&#65292;</span>
          <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#36825;&#37324;&#36890;&#36807;&#38480;&#21046;&#24490;&#29615;&#27425;&#25968;&#26469;&#25552;&#39640;&#36755;&#20837;&#27861;&#30340;&#21709;&#24212;&#12290;</span>
          (<span style="color: #FBDE2D;">setq</span> count (1+ count))
          (<span style="color: #FBDE2D;">when</span> (&gt; count 1000)
            (<span style="color: #FBDE2D;">setq</span> words nil))))

      (<span style="color: #FBDE2D;">setq</span> guess-words-accurate (reverse guess-words-accurate))
      <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#21512;&#24182;&#21040;&#32852;&#24819;&#35789;&#19968;&#36215;&#22788;&#29702;&#65292;&#36825;&#26679;&#29992;&#25143;&#23601;&#21487;&#20197;&#36890;&#36807; `</span><span style="color: #8B8989; font-style: italic;">pyim-enable-words-predict</span><span style="color: #8B8989; font-style: italic;">'</span>
      <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#26469;&#20915;&#23450;&#21738;&#19968;&#31867;&#32852;&#24819;&#35789;&#20248;&#20808;&#26174;&#31034;&#12290;</span>
      (<span style="color: #FBDE2D;">push</span> `(guess-words ,@(reverse guess-words-similar)) words-predicted))

    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#23558;&#36755;&#20837;&#30340;&#25340;&#38899;&#25353;&#29031;&#22768;&#27597;&#21644;&#38901;&#27597;&#25171;&#25955;&#65292;&#24471;&#21040;&#23613;&#21487;&#33021;&#22810;&#30340;&#25340;&#38899;&#32452;&#21512;&#65292;</span>
    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#26597;&#35810;&#36825;&#20123;&#25340;&#38899;&#32452;&#21512;&#65292;&#24471;&#21040;&#30340;&#35789;&#26465;&#20570;&#20026;&#32852;&#24819;&#35789;&#12290;</span>
    (<span style="color: #FBDE2D;">setq</span> wordspy (pyim-possible-words-py pylist))
    (<span style="color: #FBDE2D;">when</span> (<span style="color: #FBDE2D;">and</span> wordspy (member 'pinyin-znabc pyim-enable-words-predict))
      (<span style="color: #FBDE2D;">push</span> `(pinyin-znabc ,@(pyim-possible-words wordspy)) words-predicted))

    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#20381;&#27425;&#25628;&#32034;&#27599;&#20010;&#25340;&#38899;&#23545;&#24212;&#30340;&#27721;&#23383;&#12290;</span>
    (<span style="color: #FBDE2D;">setq</span> chars (pyim-get (concat (caar pylist) (cdar pylist))))

    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#23558;&#19978;&#36848;&#25628;&#32034;&#24471;&#21040;&#30340;&#35789;&#26465;&#21512;&#24182;&#12290;</span>
    (<span style="color: #FBDE2D;">setq</span> choice `(,@guess-words-accurate
                   ,@words
                   <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#27809;&#26377;&#20005;&#26684;&#21305;&#37197;&#30340;&#35789;&#26465;&#26102;&#65292;&#35774;&#32622;&#31532;&#19968;&#20010;&#34987;&#36873;&#35789;&#20026;&#23383;&#31526;&#65292;</span>
                   <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#36825;&#26679;&#21487;&#20197;&#20943;&#23569;&#19981;&#21487;&#39044;&#26399;&#30340;&#32852;&#24819;&#35789;&#24102;&#26469;&#30340;&#35270;&#35273;&#21387;&#21147;&#12290;</span>
                   ,@(<span style="color: #FBDE2D;">unless</span> words
                       (list (car chars)))
                   <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#32852;&#24819;&#35789;</span>
                   ,@(pyim-flatten-list
                      (mapcar
                       #'(lambda (x)
                           (cdr (assoc x words-predicted)))
                       pyim-enable-words-predict))
                   <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#27721;&#23383;&#23383;&#31526;</span>
                   ,@chars))
    (delete-dups (delq nil choice))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-sublist</span> (list start end)
  <span style="color: #61CE3C;">"Return a section of LIST, from START to END.</span>
<span style="color: #61CE3C;">Counting starts at 1."</span>
  (<span style="color: #FBDE2D;">let</span> (rtn (c start))
    (<span style="color: #FBDE2D;">setq</span> list (nthcdr (1- start) list))
    (<span style="color: #FBDE2D;">while</span> (<span style="color: #FBDE2D;">and</span> list (&lt;= c end))
      (<span style="color: #FBDE2D;">push</span> (<span style="color: #FBDE2D;">pop</span> list) rtn)
      (<span style="color: #FBDE2D;">setq</span> c (1+ c)))
    (nreverse rtn)))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-flatten-list</span> (my-list)
  (<span style="color: #FBDE2D;">cond</span>
   ((null my-list) nil)
   ((atom my-list) (list my-list))
   (t (append (pyim-flatten-list (car my-list))
              (pyim-flatten-list (cdr my-list))))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-possible-words</span> (wordspy)
  <span style="color: #61CE3C;">"&#26681;&#25454;&#25340;&#38899;&#24471;&#21040;&#21487;&#33021;&#30340;&#35789;&#32452;&#12290;&#20363;&#22914;&#65306;</span>
<span style="color: #61CE3C;">  (pyim-possible-words '((\"p-y\" (\"p\" . \"in\") (\"y\" . \"\"))))</span>
<span style="color: #61CE3C;">    =&gt; (\"&#25340;&#38899;\" \"&#36139;&#38080;\" \"&#32856;&#29992;\")</span>
<span style="color: #61CE3C;">"</span>
  (<span style="color: #FBDE2D;">let</span> (words)
    (<span style="color: #FBDE2D;">dolist</span> (word (reverse wordspy))
      (<span style="color: #FBDE2D;">if</span> (listp word)
          (<span style="color: #FBDE2D;">setq</span> words (append words (pyim-get (car word))))
        (<span style="color: #FBDE2D;">setq</span> words (append words (pyim-get word)))))
    words))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-possible-words-py</span> (pylist)
  <span style="color: #61CE3C;">"&#25152;&#26377;&#21487;&#33021;&#30340;&#35789;&#32452;&#25340;&#38899;&#12290;&#20174;&#31532;&#19968;&#20010;&#23383;&#24320;&#22987;&#65292;&#27599;&#20010;&#23383;&#26029;&#24320;&#24418;&#25104;&#19968;&#20010;&#25340;&#38899;&#12290;&#22914;&#26524;&#26159;</span>
<span style="color: #61CE3C;">&#23436;&#25972;&#25340;&#38899;&#65292;&#21017;&#32473;&#20986;&#23436;&#25972;&#30340;&#25340;&#38899;&#65292;&#22914;&#26524;&#26159;&#32473;&#20986;&#22768;&#27597;&#65292;&#21017;&#20026;&#19968;&#20010; CONS CELL&#65292;CAR &#26159;</span>
<span style="color: #61CE3C;">&#25340;&#38899;&#65292;CDR &#26159;&#25340;&#38899;&#21015;&#34920;&#12290;&#20363;&#22914;&#65306;</span>

<span style="color: #61CE3C;"> (setq foo-pylist (pyim-split-string \"pin-yin-sh-r\"))</span>
<span style="color: #61CE3C;">  =&gt; ((\"p\" . \"in\") (\"y\" . \"in\") (\"sh\" . \"\") (\"r\" . \"\"))</span>

<span style="color: #61CE3C;"> (pyim-possible-words-py foo-pylist)</span>
<span style="color: #61CE3C;">  =&gt; (\"pin-yin\" (\"p-y-sh\" (\"p\" . \"in\") (\"y\" . \"in\") (\"sh\" . \"\")) (\"p-y-sh-r\" (\"p\" . \"in\") (\"y\" . \"in\") (\"sh\" . \"\") (\"r\" . \"\")))</span>
<span style="color: #61CE3C;"> "</span>
  (<span style="color: #FBDE2D;">let</span> (pys fullpy smpy wordlist (full t))
    (<span style="color: #FBDE2D;">if</span> (string&lt; <span style="color: #61CE3C;">""</span> (cdar pylist))
        (<span style="color: #FBDE2D;">setq</span> fullpy (concat (caar pylist) (cdar pylist))
              smpy (pyim-essential-py (car pylist)))
      (<span style="color: #FBDE2D;">setq</span> smpy (caar pylist)
            full nil))
    (<span style="color: #FBDE2D;">setq</span> wordlist (list (car pylist)))
    (<span style="color: #FBDE2D;">dolist</span> (py (cdr pylist))
      (<span style="color: #FBDE2D;">setq</span> wordlist (append wordlist (list py)))
      (<span style="color: #FBDE2D;">if</span> (<span style="color: #FBDE2D;">and</span> full (string&lt; <span style="color: #61CE3C;">""</span> (cdr py)))
          (<span style="color: #FBDE2D;">setq</span> fullpy (concat fullpy <span style="color: #61CE3C;">"-"</span> (car py) (cdr py))
                smpy (concat smpy <span style="color: #61CE3C;">"-"</span> (pyim-essential-py py))
                pys (append pys (list fullpy)))
        (<span style="color: #FBDE2D;">setq</span> full nil
              smpy (concat smpy <span style="color: #61CE3C;">"-"</span> (pyim-essential-py py))
              pys (append pys (list (cons smpy wordlist))))))
    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">(message "%s: %s" pys wordlist))</span>
    pys))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-essential-py</span> (py)
  <span style="color: #61CE3C;">"&#19968;&#20010;&#25340;&#38899;&#20013;&#30340;&#20027;&#35201;&#37096;&#20998;&#65292;&#22914;&#26524;&#26377;&#22768;&#27597;&#36820;&#22238;&#22768;&#27597;&#65292;&#21542;&#21017;&#36820;&#22238;&#38901;&#27597;"</span>
  (<span style="color: #FBDE2D;">if</span> (string&lt; <span style="color: #61CE3C;">""</span> (car py))
      (car py)
    (cdr py)))
</pre>
</div>
</div></li></ol>
</div>

<div id="outline-container-orgheadline21" class="outline-4">
<h4 id="orgheadline21"><span class="section-number-4">2.6.2</span> 核心函数：拼音字符串处理函数</h4>
<div class="outline-text-4" id="text-2-6-2">
<p>
`pyim-handle-string' 这个函数是一个重要的<b>核心函数</b>，其大致工作流程为：
</p>
<ol class="org-ol">
<li>查询拼音字符串 `pyim-current-key' 得到： 待选词列表
`pyim-current-choices' 和 当前选择的词条 `pyim-current-key'</li>
<li>显示备选词条和选择备选词等待用户选择。</li>
</ol>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-handle-string</span> ()
  (<span style="color: #FBDE2D;">let</span> ((str pyim-current-key)
        userpos wordspy)
    (<span style="color: #FBDE2D;">setq</span> pyim-pinyin-list (pyim-split-string str)
          pyim-pinyin-position 0)
    (<span style="color: #FBDE2D;">unless</span> (<span style="color: #FBDE2D;">and</span> (pyim-validp pyim-pinyin-list)
                 (<span style="color: #FBDE2D;">progn</span>
                   (<span style="color: #FBDE2D;">setq</span> userpos (pyim-user-divide-pos str)
                         pyim-current-key (pyim-restore-user-divide
                                           (pyim-pylist-to-string pyim-pinyin-list)
                                           userpos))
                   (<span style="color: #FBDE2D;">setq</span> pyim-current-choices (list (delete-dups (pyim-get-choices pyim-pinyin-list))))
                   (<span style="color: #FBDE2D;">when</span>  (car pyim-current-choices)
                     (<span style="color: #FBDE2D;">setq</span> pyim-current-pos 1)
                     (pyim-update-current-str)
                     (pyim-format-page)
                     (pyim-show)
                     t)))
      (<span style="color: #FBDE2D;">setq</span> pyim-current-str (replace-regexp-in-string <span style="color: #61CE3C;">"-"</span> <span style="color: #61CE3C;">""</span> pyim-current-key))
      (<span style="color: #FBDE2D;">setq</span> pyim-guidance-str (format <span style="color: #61CE3C;">"%s"</span>
                                      (replace-regexp-in-string
                                       <span style="color: #61CE3C;">"-"</span> <span style="color: #61CE3C;">" "</span> pyim-current-key)))
      (pyim-show))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgheadline23" class="outline-3">
<h3 id="orgheadline23"><span class="section-number-3">2.7</span> 处理当前需要插入字符串 `pyim-current-str'</h3>
<div class="outline-text-3" id="text-2-7">
<p>
Chinese-pyim 使用变量 `pyim-current-str' 保存<b>当前需要在 buffer 中插入的字符串</b>。
</p>

<p>
处理 `pyim-current-str' 的代码分散在多个函数中，可以按照下面的方式分类：
</p>
<ol class="org-ol">
<li>英文字符串：Chinese-pyim 没有找到相应的候选词时（比如：用户输入错误的拼音），`pyim-current-str' 的值与 `pyim-current-key' 大致相同。相关代码很简单，分散在 `pyim-handle-string' 或者
`pyim-append-string' 等相关函数。</li>
<li><p>
汉字或者拼音和汉字的混合：当 Chinese-pyim 找到相应的候选词条时，
`pyim-current-str' 的值可以是完全的中文词条，比如：
</p>
<pre class="example">
你好
</pre>
<p>
或者中文词条＋拼音的混合新式，比如：
</p>
<pre class="example">
你好bj
</pre>
<p>
这部份代码相对复杂，使用 `pyim-update-current-key' 专门处理。
</p></li>
</ol>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-append-string</span> (str)
  <span style="color: #61CE3C;">"append STR to pyim-current-str"</span>
  (<span style="color: #FBDE2D;">setq</span> pyim-current-str (concat pyim-current-str str)))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-update-current-str</span> ()
  <span style="color: #61CE3C;">"update `</span><span style="color: #61CE3C;">pyim-current-str</span><span style="color: #61CE3C;">'"</span>
  (<span style="color: #FBDE2D;">let*</span> ((end (pyim-page-end))
         (start (1- (pyim-page-start)))
         (choices (car pyim-current-choices))
         (choice (pyim-subseq choices start end))
         (pos (1- (min pyim-current-pos (length choices))))
         rest)
    (<span style="color: #FBDE2D;">setq</span> pyim-current-str (concat (substring pyim-current-str 0 pyim-pinyin-position)
                                   (pyim-choice (nth pos choices)))
          rest (mapconcat (<span style="color: #FBDE2D;">lambda</span> (py)
                            (concat (car py) (cdr py)))
                          (nthcdr (length pyim-current-str) pyim-pinyin-list)
                          <span style="color: #61CE3C;">"'"</span>))
    (<span style="color: #FBDE2D;">if</span> (string&lt; <span style="color: #61CE3C;">""</span> rest)
        (<span style="color: #FBDE2D;">setq</span> pyim-current-str (concat pyim-current-str rest)))))
</pre>
</div>

<p>
Chinese-pyim 会使用 emacs overlay 机制在<b>待输入buffer</b>光标处高亮显示
`pyim-current-str'，让用户快速了解当前输入的字符串，具体方式是：
</p>
<ol class="org-ol">
<li>在 `pyim-input-method' 中调用 `pyim-setup-overlays' 创建 overlay ，并使用变量 `pyim-overlay' 保存，创建时将 overlay 的 face 属性设置为
`pyim-string-face' ，用户可以使用这个变量来自定义 face。</li>
<li>使用函数 `pyim-show' 高亮显示 `pyim-current-str'
<ol class="org-ol">
<li>清除光标处原来的字符串。</li>
<li>插入 `pyim-current-str'</li>
<li>使用 `move-overlay' 函数调整变量 `pyim-overlay' 中保存的 overlay，让其符合新插入的字符串。</li>
</ol></li>
<li>在 `pyim-input-method' 中调用 `pyim-delete-overlays' ，删除
`pyim-overlay' 中保存的 overlay，这个函数同时也删除了 overlay 中包含的文本 `pyim-current-str'。</li>
</ol>

<p>
真正在<b>待输入buffer</b>插入 `pyim-current-str' 字符串的函数是
`read-event'，具体见 `pyim-input-method' 相关说明。
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-setup-overlays</span> ()
  (<span style="color: #FBDE2D;">let</span> ((pos (point)))
    (<span style="color: #FBDE2D;">if</span> (overlayp pyim-overlay)
        (move-overlay pyim-overlay pos pos)
      (<span style="color: #FBDE2D;">setq</span> pyim-overlay (make-overlay pos pos))
      (<span style="color: #FBDE2D;">if</span> input-method-highlight-flag
          (overlay-put pyim-overlay 'face 'pyim-string-face)))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-delete-overlays</span> ()
  (<span style="color: #FBDE2D;">if</span> (<span style="color: #FBDE2D;">and</span> (overlayp pyim-overlay) (overlay-start pyim-overlay))
      (delete-overlay pyim-overlay)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline27" class="outline-3">
<h3 id="orgheadline27"><span class="section-number-3">2.8</span> 显示和选择备选词条</h3>
<div class="outline-text-3" id="text-2-8">
</div><div id="outline-container-orgheadline24" class="outline-4">
<h4 id="orgheadline24"><span class="section-number-4">2.8.1</span> 构建词条菜单字符串： `pyim-guidance-str' 。</h4>
<div class="outline-text-4" id="text-2-8-1">
<p>
Chinese-pyim 内建两种方式显示选词框：
</p>

<ol class="org-ol">
<li>使用 `pyim-minibuffer-message' 函数在 minibuffer 中显示选词框。</li>
<li>使用 `pyim-pos-tip-show' 函数在光标处创建一个 tooltip 来显示选词框。</li>
</ol>

<p>
两种方式的基本原理相同：通过<b>待选词列表</b>构建为一个字符串，然后显示这个字符串。用户可以根据这个字符串的提示，来执行相应的动作，比如按空格确认当前选择的词条或者按数字选择这个数字对应的词条。比如：
</p>

<pre class="example">
"1. 你好 2. 倪皓 3. 你 4.泥 ..."
</pre>

<p>
Chinese-pyim 使用 `pyim-current-choices' 来保存<b>待选词列表</b>，我们以
"nihao" 对应的 `pyim-current-choices' 的值为例，来说明选词框相关的操作函数。
</p>

<pre class="example">
(#("你好" 0 2 (py ("ni-hao"))) #("倪皓" 0 2 (py ("ni-hao"))) "泥" "你" "呢" "拟" "逆" "腻" "妮" "怩" "溺" "尼" "禰" "齯" "麑" "鲵" "蜺" "衵" "薿" "旎" "睨" "铌" "昵" "匿" "倪" "霓" "暱" "柅" "猊" "郳" "輗" "坭" "惄" "堄" "儗" "伲" "祢" "慝")
</pre>

<p>
变量 `pyim-guidance-str' 用来保存需要在 minibuffer 选词框中显示的词条菜单字符串，而变量 `pyim-current-pos' 纪录当前选择的词条在
 `pyim-current-choices' 中的位置，如果当前选择的词条为“倪皓”，那么其取值为2，如果当前选择的词条为“腻”，其取值为8。
</p>

<p>
<b>待选词列表</b>一般都很长，不可能在一行中完全显示，所以 Chinese-pyim 使用了 page 的概念，比如，上面的 “nihao” 的<b>待选词列表</b>就可以逻辑的分成5页：
</p>

<pre class="example">
("你好"  倪皓"  "泥"  "你"  "呢"  "拟"  "逆"  "腻"  "妮"   ;第1页
 "怩"    "溺"   "尼"  "禰"  "齯"  "麑"  "鲵"  "蜺"  "衵"   ;第2页
 "薿"    "旎"   "睨"  "铌"  "昵"  "匿"  "倪"  "霓"  "暱"   ;第3页
 "柅"    "猊"   "郳"  "輗"  "坭"  "惄"  "堄"  "儗"  "伲"   ;第4页
 "祢"    "慝"                                              ;第5页)
</pre>

<p>
用户可以使用变量 `pyim-page-length' 自定义每一页显示词条的数量，默认设置为9。
</p>

<p>
`pyim-current-pos' 的取值以及 `pyim-page-length' 的设定值，共同决定了
Chinese-pyim 需要显示哪一页，我们以一个表格来表示上述<b>待选词列表</b>：
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">第1页</td>
<td class="org-left">"你好"</td>
<td class="org-left">倪皓"</td>
<td class="org-left">"泥"</td>
<td class="org-left">"你"</td>
<td class="org-left">"呢"</td>
<td class="org-left">"拟"</td>
<td class="org-left">"逆"</td>
<td class="org-left">"腻"</td>
<td class="org-left">"妮"</td>
</tr>

<tr>
<td class="org-left">第2页</td>
<td class="org-left">"怩"</td>
<td class="org-left">"溺"</td>
<td class="org-left">"尼"</td>
<td class="org-left">"禰"</td>
<td class="org-left">"齯"</td>
<td class="org-left">"麑"</td>
<td class="org-left">"鲵"</td>
<td class="org-left">"蜺"</td>
<td class="org-left">"衵"</td>
</tr>

<tr>
<td class="org-left">第3页</td>
<td class="org-left">-B- "薿"</td>
<td class="org-left">"旎"</td>
<td class="org-left">-A-"睨"</td>
<td class="org-left">"铌"</td>
<td class="org-left">"昵"</td>
<td class="org-left">"匿"</td>
<td class="org-left">"倪"</td>
<td class="org-left">"霓"</td>
<td class="org-left">-E- "暱"</td>
</tr>

<tr>
<td class="org-left">第4页</td>
<td class="org-left">"柅"</td>
<td class="org-left">"猊"</td>
<td class="org-left">"郳"</td>
<td class="org-left">"輗"</td>
<td class="org-left">"坭"</td>
<td class="org-left">"惄"</td>
<td class="org-left">"堄"</td>
<td class="org-left">"儗"</td>
<td class="org-left">"伲"</td>
</tr>

<tr>
<td class="org-left">第5页</td>
<td class="org-left">"祢"</td>
<td class="org-left">"慝"</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
假设 `pyim-current-pos' 为 A 所在的位置。那么：
</p>
<ol class="org-ol">
<li>函数 `pyim-current-page' 返回值为3， 说明当前 page 为第3页。</li>
<li>函数 `pyim-total-page'  返回值为5，说明 page 共有5页。</li>
<li>函数 `pyim-page-start' 返回 B 所在的位置。</li>
<li>函数 `pyim-page-end' 返回 E 所在的位置。</li>
<li><p>
函数 `pyim-format-page' 会从 `pyim-current-choices' 中提取一个
sublist:
</p>
<pre class="example">
("薿" "旎" "睨" "铌" "昵" "匿" "倪" "霓" "暱")
</pre>
<p>
这个 sublist 的起点为  `pyim-page-start' 的返回值，终点为
`pyim-page-end' 的返回值。然后使用这个 sublist 来构建类似下面的字符串，并保存到变量 `pyim-guidance-str' 。
</p>
<pre class="example">
"1. 薿 2.旎 3.睨 4.铌 5.昵 6.匿 7.倪 8.霓 9.暱"
</pre></li>
</ol>

<p>
`pyim-next-page' 这个命令用来翻页，其原理是：改变 `pyim-current-pos'的取值，假设一次只翻一页，那么这个函数所做的工作就是：
</p>
<ol class="org-ol">
<li>首先将 `pyim-current-pos' 增加 `pyim-page-length' ，确保其指定的位置在下一页。</li>
<li>然后将 `pyim-current-pos' 的值设定为 `pyim-page-start' 的返回值，确保 `pyim-current-pos' 的取值为下一页第一个词条的位置。</li>
<li>最后调用 `pyim-format-page' 来重新设置 `pyim-guidance-str' 。</li>
</ol>

<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #8B8989; font-style: italic;">;;;  </span><span style="color: #8B8989; font-style: italic;">page format</span>
(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-subseq</span> (list from <span style="color: #D8FA3C;">&amp;optional</span> to)
  (<span style="color: #FBDE2D;">if</span> (null to) (nthcdr from list)
    (butlast (nthcdr from list) (- (length list) to))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-mod</span> (x y)
  <span style="color: #61CE3C;">"like `</span><span style="color: #61CE3C;">mod</span><span style="color: #61CE3C;">', but when result is 0, return Y"</span>
  (<span style="color: #FBDE2D;">let</span> ((base (mod x y)))
    (<span style="color: #FBDE2D;">if</span> (= base 0)
        y
      base)))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-choice</span> (choice)
  (<span style="color: #FBDE2D;">if</span> (consp choice)
      (car choice)
    choice))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-current-page</span> ()
  (1+ (/ (1- pyim-current-pos) pyim-page-length)))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-total-page</span> ()
  (1+ (/ (1- (length (car pyim-current-choices))) pyim-page-length)))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-page-start</span> ()
  <span style="color: #61CE3C;">"&#35745;&#31639;&#24403;&#21069;&#25152;&#22312;&#39029;&#30340;&#31532;&#19968;&#20010;&#35789;&#26465;&#30340;&#20301;&#32622;"</span>
  (<span style="color: #FBDE2D;">let</span> ((pos (min (length (car pyim-current-choices)) pyim-current-pos)))
    (1+ (- pos (pyim-mod pos pyim-page-length)))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-page-end</span> (<span style="color: #D8FA3C;">&amp;optional</span> finish)
  <span style="color: #61CE3C;">"&#35745;&#31639;&#24403;&#21069;&#25152;&#22312;&#39029;&#30340;&#26368;&#21518;&#19968;&#20010;&#35789;&#26465;&#30340;&#20301;&#32622;&#65292;&#22914;&#26524; pyim-current-choices &#29992;</span>
<span style="color: #61CE3C;">&#23436;&#65292;&#21017;&#26816;&#26597;&#26159;&#21542;&#26377;&#34917;&#20840;&#12290;&#22914;&#26524; FINISH &#20026; non-nil&#65292;&#35828;&#26126;&#65292;&#34917;&#20840;&#24050;&#32463;&#29992;&#23436;&#20102;"</span>
  (<span style="color: #FBDE2D;">let*</span> ((whole (length (car pyim-current-choices)))
         (len pyim-page-length)
         (pos pyim-current-pos)
         (last (+ (- pos (pyim-mod pos len)) len)))
    (<span style="color: #FBDE2D;">if</span> (&lt; last whole)
        last
      (<span style="color: #FBDE2D;">if</span> finish
          whole
        (pyim-page-end t)))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-format-page</span> (<span style="color: #D8FA3C;">&amp;optional</span> hightlight-current)
  <span style="color: #61CE3C;">"&#25353;&#24403;&#21069;&#20301;&#32622;&#65292;&#29983;&#25104;&#20505;&#36873;&#35789;&#26465;"</span>
  (<span style="color: #FBDE2D;">let*</span> ((end (pyim-page-end))
         (start (1- (pyim-page-start)))
         (choices (car pyim-current-choices))
         (choice (pyim-subseq choices start end))
         (pos (- (min pyim-current-pos (length choices)) start))
         (i 0))
    (<span style="color: #FBDE2D;">setq</span> pyim-guidance-str
          (format <span style="color: #61CE3C;">"%s[%d/%d]: %s"</span>
                  (replace-regexp-in-string <span style="color: #61CE3C;">"-"</span> <span style="color: #61CE3C;">" "</span> pyim-current-key)
                  (pyim-current-page) (pyim-total-page)
                  (mapconcat 'identity
                             (mapcar
                              (<span style="color: #FBDE2D;">lambda</span> (c)
                                (<span style="color: #FBDE2D;">setq</span> i (1+ i))
                                (<span style="color: #FBDE2D;">let</span> (str)
                                  (<span style="color: #FBDE2D;">setq</span> str (<span style="color: #FBDE2D;">if</span> (consp c)
                                                (concat (car c) (cdr c))
                                              c))
                                  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#39640;&#20142;&#24403;&#21069;&#36873;&#25321;&#30340;&#35789;&#26465;&#65292;&#29992;&#20110; `</span><span style="color: #8B8989; font-style: italic;">pyim-next-word</span><span style="color: #8B8989; font-style: italic;">'</span>
                                  (<span style="color: #FBDE2D;">if</span> (<span style="color: #FBDE2D;">and</span> hightlight-current
                                           (= i pos))
                                      (format <span style="color: #61CE3C;">"%d.%s"</span> i
                                              (propertize
                                               (concat <span style="color: #61CE3C;">"["</span> str <span style="color: #61CE3C;">"]"</span>)
                                               'face 'pyim-minibuffer-string-face))
                                    (format <span style="color: #61CE3C;">"%d. %s "</span> i str))))
                              choice) <span style="color: #61CE3C;">" "</span>)))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-next-page</span> (arg)
  (<span style="color: #FBDE2D;">interactive</span> <span style="color: #61CE3C;">"p"</span>)
  (<span style="color: #FBDE2D;">if</span> (= (length pyim-current-key) 0)
      (<span style="color: #FBDE2D;">progn</span>
        (pyim-append-string (pyim-translate last-command-event))
        (pyim-terminate-translation))
    (<span style="color: #FBDE2D;">let</span> ((new (+ pyim-current-pos (* pyim-page-length arg) 1)))
      (<span style="color: #FBDE2D;">setq</span> pyim-current-pos (<span style="color: #FBDE2D;">if</span> (&gt; new 0) new 1)
            pyim-current-pos (pyim-page-start))
      (pyim-update-current-str)
      (pyim-format-page)
      (pyim-show))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-previous-page</span> (arg)
  (<span style="color: #FBDE2D;">interactive</span> <span style="color: #61CE3C;">"p"</span>)
  (pyim-next-page (- arg)))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-next-word</span> (arg)
  (<span style="color: #FBDE2D;">interactive</span> <span style="color: #61CE3C;">"p"</span>)
  (<span style="color: #FBDE2D;">if</span> (= (length pyim-current-key) 0)
      (<span style="color: #FBDE2D;">progn</span>
        (pyim-append-string (pyim-translate last-command-event))
        (pyim-terminate-translation))
    (<span style="color: #FBDE2D;">let</span> ((new (+ pyim-current-pos arg)))
      (<span style="color: #FBDE2D;">setq</span> pyim-current-pos (<span style="color: #FBDE2D;">if</span> (&gt; new 0) new 1))
      (pyim-update-current-str)
      (pyim-format-page t)
      (pyim-show))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-previous-word</span> (arg)
  (<span style="color: #FBDE2D;">interactive</span> <span style="color: #61CE3C;">"p"</span>)
  (pyim-next-word (- arg)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline25" class="outline-4">
<h4 id="orgheadline25"><span class="section-number-4">2.8.2</span> 显示选词框</h4>
<div class="outline-text-4" id="text-2-8-2">
<p>
当`pyim-guidance-str' 构建完成后，Chinese-pyim 使用函数 `pyim-show' 重新显示选词框，`pyim-show' 会根据函数 `pyim-use-tooltip-p' 的返回值来决定使用哪种方式来显示选词框（minibuffer 或者 tooltip ）。
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-show</span> ()
  (<span style="color: #FBDE2D;">unless</span> enable-multibyte-characters
    (<span style="color: #FBDE2D;">setq</span> pyim-current-key nil
          pyim-current-str nil)
    (<span style="color: #ff69b4;">error</span> <span style="color: #61CE3C;">"Can't input characters in current unibyte buffer"</span>))
  (pyim-delete-region)
  (insert pyim-current-str)
  (move-overlay pyim-overlay (overlay-start pyim-overlay) (point))
  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">Then, show the guidance.</span>
  (<span style="color: #FBDE2D;">when</span> (<span style="color: #FBDE2D;">and</span> (not input-method-use-echo-area)
             (null unread-command-events)
             (null unread-post-input-method-events))
    (<span style="color: #FBDE2D;">if</span> (eq (selected-window) (minibuffer-window))
        <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">Show the guidance in the next line of the currrent</span>
        <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">minibuffer.</span>
        (pyim-minibuffer-message
         (format <span style="color: #61CE3C;">"  [%s]\n%s"</span>
                 current-input-method-title pyim-guidance-str))
      <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">Show the guidance in echo area without logging.</span>
      (<span style="color: #FBDE2D;">let</span> ((message-log-max nil))
        (<span style="color: #FBDE2D;">if</span> (pyim-use-tooltip-p)
            (<span style="color: #FBDE2D;">let</span> ((pos (string-match <span style="color: #61CE3C;">": "</span> pyim-guidance-str)))
              (<span style="color: #FBDE2D;">if</span> pos
                  (<span style="color: #FBDE2D;">setq</span> pyim-guidance-str
                        (format <span style="color: #61CE3C;">"=&gt; %s\n%s"</span>
                                (substring pyim-guidance-str 0 pos)
                                (substring pyim-guidance-str (+ pos 2)))))
              (pyim-pos-tip-show pyim-guidance-str (overlay-start pyim-overlay)))
          (message <span style="color: #61CE3C;">"%s"</span> pyim-guidance-str))))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-delete-region</span> ()
  <span style="color: #61CE3C;">"Delete the text in the current translation region of E+."</span>
  (<span style="color: #FBDE2D;">if</span> (overlay-start pyim-overlay)
      (delete-region (overlay-start pyim-overlay)
                     (overlay-end pyim-overlay))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-pos-tip-show</span> (string position)
  <span style="color: #61CE3C;">"&#22312; `</span><span style="color: #61CE3C;">position</span><span style="color: #61CE3C;">' &#20301;&#32622;&#65292;&#20351;&#29992; pos-tip &#26174;&#31034;&#23383;&#31526;&#20018; `</span><span style="color: #61CE3C;">string</span><span style="color: #61CE3C;">' &#12290;"</span>
  (<span style="color: #FBDE2D;">let</span> ((frame (window-frame (selected-window)))
        (length (* pyim-page-length 10)))
    (pos-tip-show-no-propertize pyim-guidance-str
                                pyim-tooltip-color
                                position nil 15
                                (round (* (pos-tip-tooltip-width length (frame-char-width frame))
                                          pyim-tooltip-width-adjustment))
                                (pos-tip-tooltip-height 2 (frame-char-height frame) frame)
                                nil nil 35)))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-minibuffer-message</span> (string)
  (message nil)
  (<span style="color: #FBDE2D;">let</span> ((point-max (point-max))
        (inhibit-quit t))
    (<span style="color: #FBDE2D;">save-excursion</span>
      (goto-char point-max)
      (insert string))
    (sit-for 1000000)
    (delete-region point-max (point-max))
    (<span style="color: #FBDE2D;">when</span> quit-flag
      (<span style="color: #FBDE2D;">setq</span> quit-flag nil
            unread-command-events '(7)))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-use-tooltip-p</span> ()
  <span style="color: #61CE3C;">"&#24403;&#36825;&#20010;&#20989;&#25968;&#36820;&#22238;&#20540;&#20026; t &#26102;&#65292;Chinese-pyim &#20351;&#29992; tooltip &#26174;&#31034;&#36873;&#35789;&#26694;&#65292;</span>
<span style="color: #61CE3C;">&#36820;&#22238;&#20540;&#20026; nil &#26102;&#65292;&#20351;&#29992; minibuffer &#26174;&#31034;&#36873;&#35789;&#26694;&#12290;"</span>
  (<span style="color: #FBDE2D;">and</span> pyim-use-tooltip
       (not (<span style="color: #FBDE2D;">or</span> noninteractive
                emacs-basic-display
                (not (display-graphic-p))
                (not (fboundp 'x-show-tip))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline26" class="outline-4">
<h4 id="orgheadline26"><span class="section-number-4">2.8.3</span> 选择备选词</h4>
<div class="outline-text-4" id="text-2-8-3">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-select-current</span> ()
  (<span style="color: #FBDE2D;">interactive</span>)
  (<span style="color: #FBDE2D;">if</span> (null (car pyim-current-choices))  <span style="color: #8B8989; font-style: italic;">; </span><span style="color: #8B8989; font-style: italic;">&#22914;&#26524;&#27809;&#26377;&#36873;&#39033;&#65292;&#36755;&#20837;&#31354;&#26684;</span>
      (<span style="color: #FBDE2D;">progn</span>
        (<span style="color: #FBDE2D;">setq</span> pyim-current-str (pyim-translate last-command-event))
        (pyim-terminate-translation))
    (<span style="color: #FBDE2D;">let</span> ((str (pyim-choice (nth (1- pyim-current-pos) (car pyim-current-choices))))
          pylist)
      (pyim-create-or-rearrange-word str t)
      (<span style="color: #FBDE2D;">setq</span> pyim-pinyin-position (+ pyim-pinyin-position (length str)))
      (<span style="color: #FBDE2D;">if</span> (&gt;= pyim-pinyin-position (length pyim-pinyin-list))
                                        <span style="color: #8B8989; font-style: italic;">; </span><span style="color: #8B8989; font-style: italic;">&#22914;&#26524;&#26159;&#26368;&#21518;&#19968;&#20010;&#65292;&#26816;&#26597;</span>
                                        <span style="color: #8B8989; font-style: italic;">; </span><span style="color: #8B8989; font-style: italic;">&#26159;&#19981;&#26159;&#22312;&#25991;&#20214;&#20013;&#65292;&#27809;&#26377;&#30340;&#35805;&#65292;&#21019;</span>
                                        <span style="color: #8B8989; font-style: italic;">; </span><span style="color: #8B8989; font-style: italic;">&#24314;&#36825;&#20010;&#35789;</span>
          (<span style="color: #FBDE2D;">progn</span>
            (<span style="color: #FBDE2D;">if</span> (not (member pyim-current-str (car pyim-current-choices)))
                (pyim-create-or-rearrange-word pyim-current-str))
            (<span style="color: #FBDE2D;">setq</span> pyim-last-input-word pyim-current-str)
            (pyim-terminate-translation)
            <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">Chinese-pyim &#20351;&#29992;&#36825;&#20010; hook &#26469;&#22788;&#29702;&#32852;&#24819;&#35789;&#12290;</span>
            (run-hooks 'pyim-select-word-finish-hook))
        (<span style="color: #FBDE2D;">setq</span> pylist (nthcdr pyim-pinyin-position pyim-pinyin-list))
        (<span style="color: #FBDE2D;">setq</span> pyim-current-choices (list (pyim-get-choices pylist))
              pyim-current-pos 1)
        (pyim-update-current-str)
        (pyim-format-page)
        (pyim-show)))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-number-select</span> ()
  <span style="color: #61CE3C;">"&#22914;&#26524;&#27809;&#26377;&#21487;&#36873;&#39033;&#65292;&#25554;&#20837;&#25968;&#23383;&#65292;&#21542;&#21017;&#36873;&#25321;&#23545;&#24212;&#30340;&#35789;&#26465;"</span>
  (<span style="color: #FBDE2D;">interactive</span>)
  (<span style="color: #FBDE2D;">if</span> (car pyim-current-choices)
      (<span style="color: #FBDE2D;">let</span> ((index (- last-command-event ?1))
            (end (pyim-page-end)))
        (<span style="color: #FBDE2D;">if</span> (&gt; (+ index (pyim-page-start)) end)
            (pyim-show)
          (<span style="color: #FBDE2D;">setq</span> pyim-current-pos (+ pyim-current-pos index))
          (<span style="color: #FBDE2D;">setq</span> pyim-current-str (concat (substring pyim-current-str 0
                                                    pyim-pinyin-position)
                                         (pyim-choice
                                          (nth (1- pyim-current-pos)
                                               (car pyim-current-choices)))))
          (pyim-select-current)))
    (pyim-append-string (char-to-string last-command-event))
    (pyim-terminate-translation)))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgheadline28" class="outline-3">
<h3 id="orgheadline28"><span class="section-number-3">2.9</span> 处理标点符号</h3>
<div class="outline-text-3" id="text-2-9">
<p>
常用的标点符号数量不多，所以 Chinese-pyim 没有使用文件而是使用一个变量
`pyim-punctuation-dict' 来设置标点符号对应表，这个变量是一个 alist 列表。
</p>

<p>
Chinese-pyim 在运行过程中调用函数 `pyim-translate' 进行标点符号格式的转换。
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-translate</span> (char)
  (<span style="color: #FBDE2D;">let*</span> ((str (char-to-string char))
         <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#27880;&#24847;&#65306;`</span><span style="color: #8B8989; font-style: italic;">str</span><span style="color: #8B8989; font-style: italic;">' &#26159; *&#24453;&#36755;&#20837;* &#30340;&#23383;&#31526;&#23545;&#24212;&#30340;&#23383;&#31526;&#20018;&#12290;</span>
         (str-before-1 (pyim-char-before-to-string 0))
         (str-before-2 (pyim-char-before-to-string 1))
         (str-before-3 (pyim-char-before-to-string 2))
         (str-before-4 (pyim-char-before-to-string 3))
         <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#20174;&#26631;&#28857;&#35789;&#24211;&#20013;&#25628;&#32034;&#19982; `</span><span style="color: #8B8989; font-style: italic;">str</span><span style="color: #8B8989; font-style: italic;">' &#23545;&#24212;&#30340;&#26631;&#28857;&#21015;&#34920;&#12290;</span>
         (punc-list (assoc str pyim-punctuation-dict))
         <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#20174;&#26631;&#28857;&#35789;&#24211;&#20013;&#25628;&#32034;&#19982; `</span><span style="color: #8B8989; font-style: italic;">str-before-1</span><span style="color: #8B8989; font-style: italic;">' &#23545;&#24212;&#30340;&#26631;&#28857;&#21015;&#34920;&#12290;</span>
         (punc-list-before-1
          (cl-some (<span style="color: #FBDE2D;">lambda</span> (x)
                     (<span style="color: #FBDE2D;">when</span> (member str-before-1 x) x))
                   pyim-punctuation-dict))
         <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">`</span><span style="color: #8B8989; font-style: italic;">str-before-1</span><span style="color: #8B8989; font-style: italic;">' &#22312;&#20854;&#23545;&#24212;&#30340;&#26631;&#28857;&#21015;&#34920;&#20013;&#30340;&#20301;&#32622;&#12290;</span>
         (punc-posit-before-1
          (cl-position str-before-1 punc-list-before-1
                       <span style="color: #FF6400;">:test</span> #'string=)))
    (<span style="color: #FBDE2D;">cond</span>
     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#31354;&#26684;&#20043;&#21069;&#30340;&#23383;&#31526;&#20160;&#20040;&#20063;&#19981;&#36755;&#20837;&#12290;</span>
     ((&lt; char ? ) <span style="color: #61CE3C;">""</span>)

     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#36825;&#20010;&#37096;&#20221;&#19982;&#26631;&#28857;&#31526;&#21495;&#22788;&#29702;&#26080;&#20851;&#65292;&#20027;&#35201;&#29992;&#26469;&#24555;&#36895;&#20445;&#23384;&#29992;&#25143;&#33258;&#23450;&#20041;&#35789;&#26465;&#12290;</span>
     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#27604;&#22914;&#65306;&#22312;&#19968;&#20010;&#20013;&#25991;&#23383;&#31526;&#20018;&#21518;&#36755;&#20837; 2v&#65292;&#21487;&#20197;&#23558;&#20809;&#26631;&#21069;&#20004;&#20010;&#20013;&#25991;&#23383;&#31526;</span>
     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#32452;&#25104;&#30340;&#23383;&#31526;&#20018;&#65292;&#20445;&#23384;&#21040;&#20010;&#20154;&#35789;&#24211;&#12290;</span>
     ((<span style="color: #FBDE2D;">and</span> (member (char-before) (number-sequence ?2 ?9))
           (string-match-p <span style="color: #61CE3C;">"\\cc"</span> str-before-2)
           (= char pyim-translate-trigger-char))
      (delete-char -1)
      (pyim-create-word-at-point
       (string-to-number str-before-1))
      <span style="color: #61CE3C;">""</span>)

     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#20851;&#38381;&#26631;&#28857;&#36716;&#25442;&#21151;&#33021;&#26102;&#65292;&#21482;&#25554;&#20837;&#33521;&#25991;&#26631;&#28857;&#12290;</span>
     ((not pyim-punctuation-translate-p)
      <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">`</span><span style="color: #8B8989; font-style: italic;">pyim-last-input-word</span><span style="color: #8B8989; font-style: italic;">' &#20445;&#23384;&#30340;&#35789;&#26465;&#29992;&#20110;&#35789;&#35821;&#32852;&#24819;&#65292;</span>
      <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#36923;&#36753;&#19978;&#65292;&#24403;&#36755;&#20837;&#26631;&#28857;&#31526;&#21495;&#21518;&#65292;&#20445;&#23384;&#30340;&#35789;&#26465;&#24050;&#32463;&#22833;&#25928;&#65292;</span>
      <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#24212;&#35813;&#23558;&#20854;&#28165;&#31354;&#12290;</span>
      (<span style="color: #FBDE2D;">setq</span> pyim-last-input-word nil)
      str)

     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#24403;&#21069;&#23383;&#31526;&#23646;&#20110; `</span><span style="color: #8B8989; font-style: italic;">pyim-punctuation-escape-list</span><span style="color: #8B8989; font-style: italic;">'&#26102;&#65292;</span>
     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#25554;&#20837;&#33521;&#25991;&#26631;&#28857;&#12290;</span>
     ((member (char-before)
              pyim-punctuation-escape-list)
      (<span style="color: #FBDE2D;">setq</span> pyim-last-input-word nil)
      str)

     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#24403;&#20809;&#26631;&#21069;&#38754;&#20026;&#33521;&#25991;&#26631;&#28857;&#26102;&#65292; &#25353; `</span><span style="color: #8B8989; font-style: italic;">pyim-translate-trigger-char</span><span style="color: #8B8989; font-style: italic;">'</span>
     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#23545;&#24212;&#30340;&#23383;&#31526;&#21518;&#65292; &#33258;&#21160;&#23558;&#20854;&#36716;&#25442;&#20026;&#23545;&#24212;&#30340;&#20013;&#25991;&#26631;&#28857;&#12290;</span>
     ((<span style="color: #FBDE2D;">and</span> (numberp punc-posit-before-1)
           (= punc-posit-before-1 0)
           (= char pyim-translate-trigger-char))
      (<span style="color: #FBDE2D;">setq</span> pyim-last-input-word nil)
      (delete-char -1)
      (pyim-return-proper-punctuation punc-list-before-1 t))

     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#24403;&#20809;&#26631;&#21069;&#38754;&#20026;&#20013;&#25991;&#26631;&#28857;&#26102;&#65292; &#25353; `</span><span style="color: #8B8989; font-style: italic;">pyim-translate-trigger-char</span><span style="color: #8B8989; font-style: italic;">'</span>
     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#23545;&#24212;&#30340;&#23383;&#31526;&#21518;&#65292; &#33258;&#21160;&#23558;&#20854;&#36716;&#25442;&#20026;&#23545;&#24212;&#30340;&#33521;&#25991;&#26631;&#28857;&#12290;</span>
     ((<span style="color: #FBDE2D;">and</span> (numberp punc-posit-before-1)
           (&gt; punc-posit-before-1 0)
           (= char pyim-translate-trigger-char))
      (<span style="color: #FBDE2D;">setq</span> pyim-last-input-word nil)
      (delete-char -1)
      (car punc-list-before-1))

     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#27491;&#24120;&#36755;&#20837;&#26631;&#28857;&#31526;&#21495;&#12290;</span>
     (punc-list
      (<span style="color: #FBDE2D;">setq</span> pyim-last-input-word nil)
      (pyim-return-proper-punctuation punc-list))

     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#24403;&#36755;&#20837;&#30340;&#23383;&#31526;&#19981;&#26159;&#26631;&#28857;&#31526;&#21495;&#26102;&#65292;&#21407;&#26679;&#25554;&#20837;&#12290;</span>
     (t str))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-char-before-to-string</span> (num)
  <span style="color: #61CE3C;">"&#24471;&#21040;&#20809;&#26631;&#21069;&#31532; `</span><span style="color: #61CE3C;">num</span><span style="color: #61CE3C;">' &#20010;&#23383;&#31526;&#65292;&#24182;&#23558;&#20854;&#36716;&#25442;&#20026;&#23383;&#31526;&#20018;&#12290;"</span>
  (<span style="color: #FBDE2D;">let*</span> ((point (point))
         (point-before (- point num)))
    (<span style="color: #FBDE2D;">when</span> (<span style="color: #FBDE2D;">and</span> (&gt; point-before 0)
               (char-before point-before))
      (char-to-string (char-before point-before)))))
</pre>
</div>

<p>
当用户使用 org-mode 以及 markdown 等轻量级标记语言撰写文档时，常常需要输入数字列表，比如：
</p>

<pre class="example">
1. item1
2. item2
3. item3
</pre>

<p>
在这种情况下，数字后面输入句号必须是半角句号而不是全角句号，Chinese-pyim 调用 `pyim-translate' 时，会检测光标前面的字符，如果这个字符属于 `pyim-punctuation-escape-list' ，Chinese-pyim 将输入半角标点，具体细节见：`pyim-translate'
</p>

<p>
用户可以使用 `pyim-toggle-full-width-punctuation' 全局的控制输入的标点符号是半角标点还是全角标点。
</p>


<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #8B8989; font-style: italic;">;;; </span><span style="color: #8B8989; font-style: italic;">&#20999;&#25442;&#20013;&#33521;&#25991;&#26631;&#28857;&#31526;&#21495;</span>
(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-toggle-full-width-punctuation</span> (arg)
  (<span style="color: #FBDE2D;">interactive</span> <span style="color: #61CE3C;">"P"</span>)
  (<span style="color: #FBDE2D;">setq</span> pyim-punctuation-translate-p
        (<span style="color: #FBDE2D;">if</span> (null arg)
            (not pyim-punctuation-translate-p)
          (&gt; (prefix-numeric-value arg) 0)))
  (<span style="color: #FBDE2D;">if</span> pyim-punctuation-translate-p
      (message <span style="color: #61CE3C;">"&#24320;&#21551;&#26631;&#28857;&#36716;&#25442;&#21151;&#33021;&#65288;&#20351;&#29992;&#20840;&#35282;&#26631;&#28857;&#65289;"</span>)
    (message <span style="color: #61CE3C;">"&#20851;&#38381;&#26631;&#28857;&#36716;&#25442;&#21151;&#33021;&#65288;&#20351;&#29992;&#21322;&#35282;&#26631;&#28857;&#65289;"</span>)))
</pre>
</div>

<p>
每次运行这个命令，都会反转变量 `pyim-punctuation-translate-p' 的取值，`pyim-translate' 会检测
`pyim-punctuation-translate-p' 的取值，当取值为 t 时，`pyim-translate' 转换标点符号，从而输入全角标点，反之，`pyim-translate' 忽略转换，从而输入半角标点。
</p>

<p>
用户也可以使用命令 `pyim-punctuation-translate-at-point' 来切换<b>光标前</b>标点符号的样式。
</p>


<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#20999;&#25442;&#20809;&#26631;&#22788;&#26631;&#28857;&#30340;&#26679;&#24335;&#65288;&#20840;&#35282; or &#21322;&#35282;&#65289;</span>
(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-punctuation-translate-at-point</span> ()
  (<span style="color: #FBDE2D;">interactive</span>)
  (<span style="color: #FBDE2D;">let*</span> ((current-char (char-to-string (preceding-char)))
         (punc-list
          (cl-some (<span style="color: #FBDE2D;">lambda</span> (x)
                     (<span style="color: #FBDE2D;">when</span> (member current-char x) x))
                   pyim-punctuation-dict)))
    (<span style="color: #FBDE2D;">when</span> punc-list
      (delete-char -1)
      (<span style="color: #FBDE2D;">if</span> (string= current-char (car punc-list))
          (insert (pyim-return-proper-punctuation punc-list t))
        (insert (car punc-list))))))
</pre>
</div>

<p>
使用上述命令切换光标前标点符号的样式时，我们使用函数 `pyim-return-proper-punctuation'
来处理成对的全角标点符号， 比如：
</p>

<pre class="example">
“”
‘’
</pre>
<p>
这个函数的参数是一个标点符号对应表，类似：
</p>

<pre class="example">
("." "。")
</pre>

<p>
第一个元素为半角标点，第二个和第三个元素（如果有）为对应的全角标点。
</p>

<pre class="example">
(list (pyim-return-proper-punctuation '("'" "‘" "’"))
      (pyim-return-proper-punctuation '("'" "‘" "’")))
</pre>

<p>
结果为:
</p>
<pre class="example">
("’" "‘")
</pre>

<p>
简单来说，定义这个函数的目的是为了实现类似的功能：如果第一次输入的标点是：（‘）时，那么下一次输入的标点就是（’）。
</p>


<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#22788;&#29702;&#26631;&#28857;&#31526;&#21495;</span>
(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-return-proper-punctuation</span> (punc-list <span style="color: #D8FA3C;">&amp;optional</span> before)
  <span style="color: #61CE3C;">"&#36820;&#22238;&#21512;&#36866;&#30340;&#26631;&#28857;&#31526;&#21495;&#65292;`</span><span style="color: #61CE3C;">punc-list</span><span style="color: #61CE3C;">'&#20026;&#26631;&#28857;&#31526;&#21495;&#21015;&#34920;&#65292;&#20854;&#26684;&#24335;&#31867;&#20284;&#65306;</span>
<span style="color: #61CE3C;">      `(\",\" \"&#65292;\") &#25110;&#32773;&#65306;`(\"'\" \"&#8216;\" \"&#8217;\")</span>
<span style="color: #61CE3C;">&#24403; `</span><span style="color: #61CE3C;">before</span><span style="color: #61CE3C;">' &#20026; t &#26102;&#65292;&#21482;&#36820;&#22238;&#20999;&#25442;&#20043;&#21069;&#30340;&#32467;&#26524;&#65292;&#36825;&#20010;&#29992;&#26469;&#33719;&#21462;&#20999;&#25442;&#20043;&#21069;</span>
<span style="color: #61CE3C;">&#30340;&#26631;&#28857;&#31526;&#21495;&#12290;"</span>
  (<span style="color: #FBDE2D;">let*</span> ((str (car punc-list))
         (punc (cdr punc-list))
         (switch-p (cdr (assoc str pyim-pair-punctuation-status))))
    (<span style="color: #FBDE2D;">if</span> (= (safe-length punc) 1)
        (car punc)
      (<span style="color: #FBDE2D;">if</span> before
          (<span style="color: #FBDE2D;">setq</span> switch-p (not switch-p))
        (<span style="color: #FBDE2D;">setf</span> (cdr (assoc str pyim-pair-punctuation-status))
              (not switch-p)))
      (<span style="color: #FBDE2D;">if</span> switch-p
          (car punc)
        (nth 1 punc)))))
</pre>
</div>

<p>
函数 `pyim-return-proper-punctuation' 内部，我们使用变量 `pyim-pair-punctuation-status'
来记录“成对”中文标点符号的状态。
</p>
</div>
</div>

<div id="outline-container-orgheadline29" class="outline-3">
<h3 id="orgheadline29"><span class="section-number-3">2.10</span> 处理特殊功能触发字符（单字符快捷键）</h3>
<div class="outline-text-3" id="text-2-10">
<p>
输入中文的时候，我们需要快速频繁的执行一些特定的命令，最直接的方法就是将上述命令绑定到一个容易按的快捷键上，但遗憾的是 emacs 大多数容易按的快捷键都<b>名花有主</b>了，甚至找一个 “Ctrl＋单字符”的快捷键都不太容易，特殊功能触发字符，可以帮助我们实现“单字符”快捷键，类似 org-mode 的 speed key。
</p>

<p>
默认情况下，我们可以使用特殊功能触发字符执行下面两个操作：
</p>
<ol class="org-ol">
<li><p>
快速切换中英文标点符号的样式：当光标前的字符是一个标点符号时，按"v"可以切换这个标点的样式。比如：光标在A处的时候，按 "v" 可以将A前面的全角逗号转换为半角逗号。
</p>
<pre class="example">
你好，-A-
</pre>
<p>
按 "v" 后
</p>
<pre class="example">
你好,-A-
</pre></li>
<li><p>
快速将光标前的词条添加到词库：当光标前的字符是中文字符时，按 "num" + "v" 可以将光标前 num 个中文汉字组成的词条添加到个人词频文件中，比如：当光标在A处时，按"4v"可以将“的红烧肉”这个词条加入个人词频文件，默认
num不超过9。
</p>
<pre class="example">
我爱吃美味的红烧肉-A-
</pre></li>
</ol>

<p>
值得注意的是，这种方式如果添加的功能太多，会造成许多潜在的冲突。
</p>

<p>
用户可以使用变量 `pyim-translate-trigger-char' 来设置触发字符，默认的触发字符是："v", 选择这个字符的理由是：
</p>

<ol class="org-ol">
<li>"v" 不是有效的声母，不会对中文输入造成太大的影响。</li>
<li>"v" 字符很容易按。</li>
</ol>

<p>
Chinese-pyim 使用函数 `pyim-translate' 来处理特殊功能触发字符。当待输入的字符是触发字符时，`pyim-translate' 根据光标前的字符的不同来调用不同的功能，具体见 `pyim-translate' ：
</p>
</div>
</div>

<div id="outline-container-orgheadline30" class="outline-3">
<h3 id="make-char-table"><a id="orgheadline30"></a><span class="section-number-3">2.11</span> 代码说明</h3>
<div class="outline-text-3" id="text-make-char-table">
<p>
Chinese-pyim 在特定的时候需要读取一个汉字的拼音，这个工作由下面几个函数完成：
</p>

<p>
函数 `pyim-get-char-code' 从 `pyim-char-table' 查询得到一个汉字字符的拼音， 例如：
</p>
<pre class="example">
(pyim-get-char-code ?我)
</pre>

<p>
结果为:
</p>
<pre class="example">
("wo")
</pre>

<p>
函数 `pyim-make-char-table-1' 参数 `chars’的形式类似：
</p>
<pre class="example">
(("ni" "你尼呢腻")
 ("wo" "我握涡卧龌"))
</pre>

<p>
最终得到一个汉字到拼音的<b>hash table</b>，用<b>一个列表</b>直观的表示为：
</p>
<pre class="example">
(('我 '("wo"))
 ('你 '("ni"))
 ('行 '("xing" "hang"))
 ('大 '("da")))
</pre>

<p>
我们用全局变量 `pyim-char-table' 来保存这个<b>hash table</b>。
</p>

<p>
函数 `pyim-make-char-table-quail/PY' 是函数 `pyim-make-char-table-1' 的包装，这个函数是一个<b>历史函数</b>，已经没有作用了，仅仅用于学习，其运行过程大体为：
</p>
<ol class="org-ol">
<li><p>
使用 regexp 解析  "quail/PY.el" 文件中的汉字拼音信息，这个文件的结构类似：
</p>
<pre class="example">
(quail-define-rules
("a" "阿啊呵腌嗄锕吖")
("ai" "爱哀挨碍埃癌艾唉矮哎皑蔼隘暧霭捱嗳瑷嫒锿嗌砹")
("an" "安案按暗岸俺谙黯鞍氨庵桉鹌胺铵揞犴埯")
("ang" "昂肮盎")
("ao" "奥澳傲熬敖凹袄懊坳嗷拗鏖骜鳌翱岙廒遨獒聱媪螯鏊")
("ba" "把八吧巴爸罢拔叭芭霸靶扒疤跋坝笆耙粑灞茇菝魃岜捌钯鲅")
("bai" "百白败摆伯拜柏呗掰捭佰稗")
("ban" "办半版般班板伴搬扮斑颁瓣拌扳绊阪坂瘢钣舨癍")
...
)
</pre></li>
<li><p>
将上述汉字拼音信息<b>按行处理</b>，转换为下述类似的列表结构。
</p>
<pre class="example">
(("ni" "你尼呢腻"))
</pre></li>
<li>使用 `pyim-make-char-table-1' 处理得到的列表。</li>
</ol>
<p>
;;
函数 `pyim-make-char-table' 也是函数 `pyim-make-char-table-1' 的包装，其过程简单来说就是使用 `pyim-make-char-table-1' 函数处理变量
`pyim-pinyin-pymap' 中保存的拼音汉字对应信息。
</p>

<p>
这个例子中的语句用于调试上述三个函数。
</p>
<pre class="example">
(setq pyim-char-table nil)
(pyim-make-char-table-1 '(("ni" "你呢泥")))
(pyim-make-char-table)
(pyim-get-char-code ?你)
</pre>


<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-get-char-code</span> (char)
  <span style="color: #61CE3C;">"Get the code of the character CHAR"</span>
  (symbol-value (intern-soft (char-to-string char) pyim-char-table)))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-make-char-table-1</span> (chars)
  (<span style="color: #FBDE2D;">dolist</span> (char chars)
    (<span style="color: #FBDE2D;">let</span> ((code (car char)))
      (mapc (<span style="color: #FBDE2D;">lambda</span> (c)
              (<span style="color: #FBDE2D;">let*</span> ((str (char-to-string c))
                     (s (intern-soft str pyim-char-table))
                     (py (<span style="color: #FBDE2D;">and</span> s (symbol-value s))))
                (set (intern str pyim-char-table)
                     (cl-remove-duplicates
                      (append py (list code)) <span style="color: #FF6400;">:test</span> #'equal))))
            (car (cdr char))))))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-make-char-table</span> ()
  <span style="color: #61CE3C;">"Build pinyin char hashtable from `</span><span style="color: #61CE3C;">pyim-pinyin-pymap</span><span style="color: #61CE3C;">'</span>
<span style="color: #61CE3C;">in package `</span><span style="color: #61CE3C;">chinese-pyim-pymap</span><span style="color: #61CE3C;">'"</span>
  (pyim-make-char-table-1 pyim-pinyin-pymap))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-make-char-table-from-quail/PY</span> ()
  <span style="color: #61CE3C;">"Build pinyin char hashtable from quail/PY.el&#65292;</span>
<span style="color: #61CE3C;">&#36825;&#20010;&#20989;&#25968;&#26242;&#26102;&#27809;&#26377;&#29992;&#22788;&#12290;"</span>
  (<span style="color: #FBDE2D;">interactive</span>)
  (<span style="color: #FBDE2D;">let</span> ((file (locate-library <span style="color: #61CE3C;">"quail/PY.el"</span>)))
    (<span style="color: #FBDE2D;">if</span> file
        (<span style="color: #FBDE2D;">with-temp-buffer</span>
          (insert-file-contents file)
          (goto-char (point-min))
          (<span style="color: #FBDE2D;">while</span> (re-search-forward
                  <span style="color: #61CE3C;">"^[[:space:]]*([[:space:]]*\"</span><span style="color: #61CE3C;">\\</span><span style="color: #61CE3C;">(</span><span style="color: #61CE3C;">[a-z]+</span><span style="color: #61CE3C;">\\</span><span style="color: #61CE3C;">)</span><span style="color: #61CE3C;">\"[[:space:]]*\"</span><span style="color: #61CE3C;">\\</span><span style="color: #61CE3C;">(</span><span style="color: #61CE3C;">[</span><span style="color: #61CE3C;">^</span><span style="color: #61CE3C;">\"]+</span><span style="color: #61CE3C;">\\</span><span style="color: #61CE3C;">)</span><span style="color: #61CE3C;">\"[[:space:]]*)[[:space:]]*$"</span> nil t)
            (<span style="color: #FBDE2D;">let</span> ((pinyin (match-string 1))
                  (hanzi-string (substring-no-properties (match-string 2))))
              (pyim-make-char-table-1 `((,pinyin ,hanzi-string))))))
      (<span style="color: #ff69b4;">warn</span> <span style="color: #61CE3C;">"&#27809;&#26377;&#25214;&#21040; Emacs &#33258;&#24102;&#25991;&#20214;: quail/PY.el&#65292;&#29992;&#25143;&#21487;&#33021;&#27809;&#26377;&#23433;&#35013; emacs&lt;VERSION&gt;-el &#36719;&#20214;&#21253;&#12290;</span>
<span style="color: #61CE3C;">&#27492;&#26102;&#65292; Chinese-pyim &#21487;&#20197;&#27491;&#24120;&#36755;&#20837;&#35789;&#26465;&#65292;&#20294;&#19979;&#38754;&#20960;&#20010;&#21151;&#33021;&#22833;&#25928;&#65306;</span>
<span style="color: #61CE3C;">1. &#35789;&#39057;&#35843;&#25972;&#21151;&#33021;</span>
<span style="color: #61CE3C;">2. &#27721;&#23383;&#21040;&#25340;&#38899;&#36716;&#25442;&#21151;&#33021;</span>
<span style="color: #61CE3C;">3. &#35789;&#26465;&#28155;&#21152;&#21644;&#21024;&#38500;&#21151;&#33021;"</span>))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline38" class="outline-3">
<h3 id="orgheadline38"><span class="section-number-3">2.12</span> 与拼音输入相关的用户命令</h3>
<div class="outline-text-3" id="text-2-12">
</div><div id="outline-container-orgheadline31" class="outline-4">
<h4 id="orgheadline31"><span class="section-number-4">2.12.1</span> 删除拼音字符串最后一个字符</h4>
<div class="outline-text-4" id="text-2-12-1">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-delete-last-char</span> ()
  (<span style="color: #FBDE2D;">interactive</span>)
  (<span style="color: #FBDE2D;">if</span> (&gt; (length pyim-current-key) 1)
      (<span style="color: #FBDE2D;">progn</span>
        (<span style="color: #FBDE2D;">setq</span> pyim-current-key (substring pyim-current-key 0 -1))
        (pyim-handle-string))
    (<span style="color: #FBDE2D;">setq</span> pyim-current-str <span style="color: #61CE3C;">""</span>)
    (pyim-terminate-translation)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline32" class="outline-4">
<h4 id="orgheadline32"><span class="section-number-4">2.12.2</span> 删除拼音字符串最后一个拼音</h4>
<div class="outline-text-4" id="text-2-12-2">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-backward-kill-py</span> ()
  (<span style="color: #FBDE2D;">interactive</span>)
  (string-match <span style="color: #61CE3C;">"['-][</span><span style="color: #61CE3C;">^</span><span style="color: #61CE3C;">'-]+$"</span> pyim-current-key)
  (<span style="color: #FBDE2D;">setq</span> pyim-current-key
        (replace-match <span style="color: #61CE3C;">""</span> nil nil pyim-current-key))
  (pyim-handle-string))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline33" class="outline-4">
<h4 id="orgheadline33"><span class="section-number-4">2.12.3</span> 取消当前输入</h4>
<div class="outline-text-4" id="text-2-12-3">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-quit-clear</span> ()
  (<span style="color: #FBDE2D;">interactive</span>)
  (<span style="color: #FBDE2D;">setq</span> pyim-current-str <span style="color: #61CE3C;">""</span>)
  (pyim-terminate-translation))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline34" class="outline-4">
<h4 id="orgheadline34"><span class="section-number-4">2.12.4</span> 字母上屏</h4>
<div class="outline-text-4" id="text-2-12-4">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-quit-no-clear</span> ()
  (<span style="color: #FBDE2D;">interactive</span>)
  (<span style="color: #FBDE2D;">setq</span> pyim-current-str (replace-regexp-in-string <span style="color: #61CE3C;">"-"</span> <span style="color: #61CE3C;">""</span>
                                                   pyim-current-key))
  (pyim-terminate-translation))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline35" class="outline-4">
<h4 id="orgheadline35"><span class="section-number-4">2.12.5</span> 处理模糊音</h4>
<div class="outline-text-4" id="text-2-12-5">
<p>
'Chinese-pyim的核心并不能处理模糊音，这里提供了一个比较<b>粗糙</b>的方法来处理模糊音。
</p>

<p>
假如：用户需要输入“应该”，其拼音为“ying-gai”，但用户确输入了一个错误的拼音“yin-gai”，这时，用户可以通过快捷键运行 `pyim-fuzzy-pinyin-adjust' ，将“in” 替换为 “ing”，得到“ying-gai”对应的词语，用户可以通过设置变量 `pyim-fuzzy-pinyin-adjust-function' 来自定义模糊音处理函数。
</p>

<p>
这种处理方式能力有限，一次不能处理太多的模糊音，用户需要根据自己的需要，自定义模糊音处理函数。具体可以参考函数 `pyim-pinyin-fuzzy-adjust-1' 的定义。
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-fuzzy-pinyin-adjust</span> ()
  (<span style="color: #FBDE2D;">interactive</span>)
  (funcall pyim-fuzzy-pinyin-adjust-function))

(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-fuzzy-pinyin-adjust-1</span> ()
  (<span style="color: #FBDE2D;">interactive</span>)
  (<span style="color: #FBDE2D;">cond</span>
   ((string-match-p <span style="color: #61CE3C;">"eng"</span> pyim-current-key)
    (<span style="color: #FBDE2D;">setq</span> pyim-current-key
          (replace-regexp-in-string <span style="color: #61CE3C;">"eng"</span> <span style="color: #61CE3C;">"en"</span> pyim-current-key)))
   ((string-match-p <span style="color: #61CE3C;">"en[</span><span style="color: #61CE3C;">^</span><span style="color: #61CE3C;">g]*"</span> pyim-current-key)
    (<span style="color: #FBDE2D;">setq</span> pyim-current-key
          (replace-regexp-in-string <span style="color: #61CE3C;">"en"</span> <span style="color: #61CE3C;">"eng"</span> pyim-current-key))))
  (<span style="color: #FBDE2D;">cond</span>
   ((string-match-p <span style="color: #61CE3C;">"ing"</span> pyim-current-key)
    (<span style="color: #FBDE2D;">setq</span> pyim-current-key
          (replace-regexp-in-string <span style="color: #61CE3C;">"ing"</span> <span style="color: #61CE3C;">"in"</span> pyim-current-key)))
   ((string-match-p <span style="color: #61CE3C;">"in[</span><span style="color: #61CE3C;">^</span><span style="color: #61CE3C;">g]*"</span> pyim-current-key)
    (<span style="color: #FBDE2D;">setq</span> pyim-current-key
          (replace-regexp-in-string <span style="color: #61CE3C;">"in"</span> <span style="color: #61CE3C;">"ing"</span> pyim-current-key))))
  (<span style="color: #FBDE2D;">cond</span>
   ((string-match-p <span style="color: #61CE3C;">"un"</span> pyim-current-key)
    (<span style="color: #FBDE2D;">setq</span> pyim-current-key
          (replace-regexp-in-string <span style="color: #61CE3C;">"un"</span> <span style="color: #61CE3C;">"ong"</span> pyim-current-key)))
   ((string-match-p <span style="color: #61CE3C;">"ong"</span> pyim-current-key)
    (<span style="color: #FBDE2D;">setq</span> pyim-current-key
          (replace-regexp-in-string <span style="color: #61CE3C;">"ong"</span> <span style="color: #61CE3C;">"un"</span> pyim-current-key))))
  (pyim-handle-string))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline36" class="outline-4">
<h4 id="orgheadline36"><span class="section-number-4">2.12.6</span> Chinese-pyim 取消激活</h4>
<div class="outline-text-4" id="text-2-12-6">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-inactivate</span> ()
  (<span style="color: #FBDE2D;">interactive</span>)
  (mapc 'kill-local-variable pyim-local-variable-list))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline37" class="outline-4">
<h4 id="orgheadline37"><span class="section-number-4">2.12.7</span> 切换中英文输入模式</h4>
<div class="outline-text-4" id="text-2-12-7">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #FBDE2D;">defun</span> <span style="color: #ff1493;">pyim-toggle-input-ascii</span> ()
  <span style="color: #61CE3C;">"Chinese-pyim &#20999;&#25442;&#20013;&#33521;&#25991;&#36755;&#20837;&#27169;&#24335;&#12290;&#21516;&#26102;&#35843;&#25972;&#26631;&#28857;&#31526;&#21495;&#26679;&#24335;&#12290;"</span>
  (<span style="color: #FBDE2D;">interactive</span>)
  (<span style="color: #FBDE2D;">setq</span> pyim-punctuation-translate-p
        (not pyim-input-ascii))
  (<span style="color: #FBDE2D;">setq</span> pyim-input-ascii
        (not pyim-input-ascii))
  (<span style="color: #FBDE2D;">setq</span> pyim-punctuation-translate-p
        (not pyim-punctuation-translate-p))
  (<span style="color: #FBDE2D;">if</span> pyim-input-ascii
      (<span style="color: #FBDE2D;">setq</span> current-input-method-title (concat pyim-title <span style="color: #61CE3C;">"-&#33521;&#25991;"</span>))
    (<span style="color: #FBDE2D;">setq</span> current-input-method-title pyim-title)))
</pre>
</div>
</div>
</div>
</div>
</div>

</div>
</div>
    <div>
      <div class="post-meta">
        <span title="post date" class="post-info">2015-08-22</span>
        <span title="last modification date" class="post-info">2015-08-06</span>
        <span title="tags" class="post-info">N/A</span>
        <span title="author" class="post-info">Feng Shu</span>
      </div>
      <section>
        <h1>Comments</h1>
        <div class="ds-thread"></div>
        <script type="text/javascript">
          var duoshuoQuery = {short_name:'tumashu-website'};
          (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = 'http://static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
          || document.getElementsByTagName('body')[0]).appendChild(ds);
          })();
        </script>
      </section>
      <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.x(<a href="http://orgmode.org">Org mode</a> 8.x)</p>
        <p>
          Copyright &copy; <span id="footerYear"></span> <a href="mailto:tumashu &lt;at&gt; 163 &lt;dot&gt; com">Feng Shu</a>
          &nbsp;&nbsp;-&nbsp;&nbsp;
          Powered by <a href="https://github.com/tumashu/org-webpage" target="_blank">org-webpage</a>
          <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
      </div>
    </div>

</div>
</body>
</html>
